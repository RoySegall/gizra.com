<!DOCTYPE html><html><head><title>Live Monitoring With Shoov And Some Sweet Irony</title><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta property=og:site_name content=Gizra><meta property=og:title content="Live Monitoring With Shoov And Some Sweet Irony"><link rel=apple-touch-icon sizes=180x180 href=/assets/favicons/apple-touch-icon-180x180.png><link rel=icon type=image/png href=/assets/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/assets/favicons/favicon-194x194.png sizes=194x194><link rel=icon type=image/png href=/assets/favicons/favicon-96x96.png sizes=96x96><link rel=icon type=image/png href=/assets/favicons/android-chrome-192x192.png sizes=192x192><link rel=icon type=image/png href=/assets/favicons/favicon-16x16.png sizes=16x16><link rel=manifest href=/assets/favicons/manifest.json><meta name=msapplication-TileColor content=#000000><meta name=msapplication-TileImage content=/assets/favicons/mstile-144x144.png><meta name=theme-color content=#ffffff><link href="https://fonts.googleapis.com/css?family=Rasa" rel=stylesheet><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.2.7/semantic.min.css integrity="sha256-wT6CFc7EKRuf7uyVfi+MQNHUzojuHN2pSw0YWFt2K5E=" crossorigin="anonymous"/><link rel=stylesheet href="/assets/stylesheets/style.css"/><script src=https://code.jquery.com/jquery-2.2.4.min.js integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.2.7/semantic.min.js integrity="sha256-flVaeawsBV96vCHiLmXn03IRJym7+ZfcLVvUWONCas8=" crossorigin=anonymous></script></head><body class=pushable><div class="ui sidebar inverted vertical menu left"><a class="item active" href="/">Home</a> <a class=item href=/team>Team</a> <a class=item href=/blog>Blog</a> <a class=item href=/projects>Projects</a> <a class=item href=/contact>Contact</a></div><div class=pusher><div class="ui grid container"><header class=row><div class="five wide column menu bar"><div class="ui large secondary menu"><a class="item sidebar-toggle"><i class="big sidebar icon"></i> Menu</a></div></div><div class="six wide computer eleven wide tablet column center aligned"><a class=gizra-logo href="/"><svg xmlns=http://www.w3.org/2000/svg width=252 height=104><title>gizra</title><path fill=#E27058 fill-rule=evenodd d="M44.3 21.6c.2 3.5 3 5.4 6 5.4 3.5 0 6.7-2 6.7-7s-3.6-7.7-8.5-7.7c-4.3 0-10.3 2.5-10.3 11 0 1.7.2 3.4.6 5.3-3.4-2-6.5-2.6-11.6-2.6-16 0-22.7 7.6-22.7 17.5 0 8.7 4 13.7 12.2 16-8.2 5-12 7.8-12 13.8C4.7 78 8 83 20.7 83h10c11 0 13.4 2 13.4 7 0 6.7-5.8 11.3-17 11.3s-13.4-4.7-13.4-9c0-1.8.2-3.5 1-5.8l-6.4-3C4.5 84.8.2 87 .2 92c0 6.8 7.5 11.3 25.8 11.3 21.2 0 29.6-8.5 29.6-20 0-14.4-12-17.2-23.8-17.2H21c-5.5 0-6.6-.4-6.6-1.4 0-1 1-2 4.6-4.4 2.2.4 5.4.8 8.5.8C40.3 61 49 55 49 43c0-6.8-4-10.5-8-13.3-.6-2.5-.8-4.6-.8-6.3 0-6.5 3-7 4.5-7 2.2 0 2.8 1.7 2.5 3.4l-3 1.8zM22 41.2C22 29.7 24 28 27 28s4.6 1.4 4.6 13.2v5c0 11-1.8 12.7-4.6 12.7-3.2 0-5-2.3-5-12V41zM62 10c0 4.4 2 9.8 10.6 9.8 7.6 0 10.6-4.3 10.6-10 0-6.3-3.8-9.6-10.4-9.6C65 .2 62 5 62 10zm-5.4 17v2h6.2v46H57v2h31.2v-2h-6V27H56.7zm82.5 0H95l-1.4 20.2H95c4.3-15 8-18.3 22.2-18.3h1L93 75.3V77h44l1.8-21.5h-1.5C133.5 69 127.5 75 115.6 75h-1.4l25-46v-2zm41 3c2.2 0 4.3 1 2.2 5.3h-3.8c-2.2 7.5 1 12 8.2 12 5.6 0 8.8-4 8.8-10 0-8-5-11.3-11.2-11.3-6.3 0-12 3.6-14 11V27H145v2h5.7v46h-5.8v2h32.6v-2h-7.4V47c0-9.5 4.7-17 9.7-17zm40.5 22.3c-15 0-24.2 2.4-24.2 13 0 10.5 8.2 12.8 15.6 12.8 7.2 0 10.3-2.7 12-7.7 1.2 5 6 7.8 14.4 7.8 9 0 13-3.5 13.5-16l-1.7-.2c-.5 8.8-2.3 10.8-4.2 10.8-1.7 0-3-1.2-3-5.5V46c0-15.2-5.5-19.8-22-19.8-14.3 0-22 4-22 13 0 5 2.6 8.6 9 8.6 5.3 0 9.3-3.3 9.3-8.2 0-2-.3-3.4-.8-4.7H214c-.6-1.2-.8-2.2-.8-3 0-3.4 3-4.3 5-4.3 4.2 0 5.3 3.5 5.3 16.8v8h-3zM219 73.8c-2 0-2.7-1-2.7-8.6v-1.6c0-6.4 2-9.6 6.5-9.6h.7v9.8c0 6.7-2.5 10-4.5 10z"/></svg></a><div class=tagline>We Build Websites</div></div><div class="five wide computer only column"></div></header><div class="ui grid centered post"><div class="sixteen wide mobile sixteen wide tablet twelve wide computer column"><div class="ui raised padded segment"><h1 class="ui dividing header"><div class="ui image"><img src=/assets/images/team/avatars/amitaibu.jpg class="ui circular image"></div><div class=content><a href="/content/live-monitor-shoov-irony/">Live Monitoring With Shoov And Some Sweet Irony</a><div class="sub header">By Amitai Burstein (@amitaibu) // 01 Jun 2015</div></div><div class="right floated column"><a href=/blog class="ui teal right ribbon label">Blog post</a></div></h1><p>Irony presents itself in many forms. Not being able to login to a site that is responsible for testing that the login is working properly on other live sites, is one of them.</p><p>As much as I’d like to say I was able to enjoy the irony, the six hours I spent tracking the bug were slightly frustrating.</p><p>One of the things <a href="http://shoov.io/">Shoov</a> is built for is assisting us with a quick configuration of live site monitoring using your preferred functional testing tool (e.g. Behat or CasperJS).<br/>As awesome as services like Pingdom are, they still provide very little insight to what’s actually going on in the site. In fact, according to Pingdom, Shoov was up and running, even though no user could have logged in.</p><div class="ui segments"><div class="ui attached center aligned segment"><div class="ui image"><img src="http://www.gizra.com/assets/images/posts/restful-backbone/image1.jpg"/></div></div><div class="ui attached center aligned caption segment">Shoov login now working. When it wasn't, the fish were sad</div></div><h2 id=post-mortem>Post Mortem</h2><p>At this point of time I think very few people care about the “post mortem” of this incident since Shoov is still a work in progress, however some interesting lessons were learned, and some contributions were made.</p><p>First a quick overview of the problem. Shoov is a fully <a href=https://events.drupal.org/losangeles2015/sessions/decoupled-drupal-when-why-and-how>decoupled Drupal</a>, where the only way to register and login are through the GitHub login. Upon login, after the user is redirected back from GitHub’s own authentication, it sends the one time access code it got from GitHub to our Drupal server to do a final validation and register the user.</p><p>The login worked perfectly, until suddenly it didn’t. To make things even harder my local installation worked fine.</p><p>After more hours that I’m willing to admit and a good pointer from <a href=https://twitter.com/izuzak>@izuzak</a> from GitHub’s support team, we figured that my local was sending the following <code class=highlighter-rouge>POST</code>:</p><div class=highlighter-rouge><pre class=highlight><code>POST /login/oauth/access_token HTTP/1.0
User-Agent: Drupal (+http://drupal.org/)
Host: github.com
Content-Length: 119

client_id=007xxxx007&amp;client_secret=1xxxxxxa2&amp;code=someOneTimeCode
</code></pre></div><p>While the live server sent this:</p><div class=highlighter-rouge><pre class=highlight><code>POST /login/oauth/access_token HTTP/1.0
User-Agent: Drupal (+http://drupal.org/)
Host: github.com
Content-Length: 111

client_id=007xxxx007&amp;amp;client_secret=1xxxxxxa2&amp;amp;code=someOneTimeCode
</code></pre></div><p>As you might have noticed (and I can’t blame you if you didn’t) the <code class=highlighter-rouge>&amp;</code> char was escaped, and GitHub decided it doesn’t like that anymore.</p><h2 id=solve-and-prevent-regressions>Solve and Prevent Regressions</h2><p>After quickly solving the error by hardcoding the <code class=highlighter-rouge>&amp;</code> char I’ve decided to spend some time in figuring how I could prevent this from happening again. (Remember: Shoov means “again” in Hebrew for this very reason…)</p><p>I’ve noticed that even though RESTful has thrown an exception when it got the result from GitHub, and even though the site is piping the logs to <a href="http://www.gizra.com/content/logs-easy-way/">Loggly</a> I wasn’t notified about it.</p><p>So, the first thing I’ve done was to write a <a href=https://github.com/RESTful-Drupal/restful/pull/522/files>pull-request</a> to RESTful to make sure that exceptions are registered in the watchdog. This means we now got that part covered not just for Shoov, but for all users of RESTful!</p><p>Next was writing a <a href=https://github.com/amitaibu/shoov-behat/blob/master/behat/features/github_login.feature>Behat test</a> that will be executed by Shoov every few minutes, and constantly verify that Shoov’s login is working properly. At least this unfortunate bug will not go unnoticed should it return some day (as unfortunate bug tend to do from time to time).</p><p>Having to do all that, along with wanting to have it as a public repository, gave me the push to finally introduce the concept of <a href=https://github.com/amitaibu/shoov-behat/blob/master/.shoov.yml#L1-L6>encrypted keys</a>. Since we don’t want the credentials of the dummy GitHub user we’ve created for the test to be exposed, Shoov will now have a secret private key that can be used for AES encryption. Shoov makes sure those encrypted variables will be available in our <a href=https://github.com/amitaibu/shoov-behat/blob/master/behat/features/bootstrap/FeatureContext.php#L44-L49>tests</a>.</p><div class="ui segments"><div class="ui attached center aligned segment"><div class="ui image"><img src="http://www.gizra.com/assets/images/posts/shoov-post-mortem/image2.jpg"/></div></div><div class="ui attached center aligned caption segment">Encrypted keys using the same syntax as Travis in .shoov.yml file</div></div><p>And you know what else is great? Since all the different components of Shoov are open source, we can enjoy sharing the code the does the <a href=https://github.com/shoov/php-ci/blob/33f9ea4292005e7898f192cb3d1250d681acaf7e/export-vars.js>decryption</a> with everyone.</p></div></div><div class="twelve wide column computer only"><div class="ui borderless secondary menu"><a class=item href="/content/restful-backbone-marionette/"><i class="chevron left icon"></i> Forking Todo Restful with Backbone.Marionette</a><div class="right menu"><a class=item href="/content/phantomjs-chrome-docker-selenium-standalone/">Why PhantomJS When You Can Chrome <i class="chevron right icon"></i></a></div></div></div><div class="twelve wide column"><div class="ui segment basic"><div id=disqus_thread></div><script type=text/javascript>var disqus_developer = 1;
    var disqus_shortname = 'gizra';
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();</script><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div></div></div></div><footer class="ui black inverted vertical footer segment padded"><div class="ui center aligned container"><div class="ui three column stackable inverted grid"><div class=column><address><div class=strong>Israel Headquarters</div><div>5 Brenner Street, Tel Aviv</div><a class=telephone href=tel:+97233731222>+972-3-3731222</a> // <a class=email href=mailto:info@gizra.com>info@gizra.com</a></address></div><div class="column icons"><a target=_blank href=https://twitter.com/gizra_drupal><i class="twitter huge icon"></i></a> <a target=_blank href=https://github.com/Gizra/gizra.com><i class="github huge icon"></i></a></div><div class=column><address><div class=strong>North America Office</div><div>350 N. Orleans Street, Suite 9000N, Chicago, IL 60647</div><a class=telephone href=tel:+13125857625>312-585-7625</a> // <a class=email href=mailto:usoffice@gizra.com>usoffice@gizra.com</a></address></div></div></div></footer></div><script src=/bower_components/anchor-js/anchor.min.js></script><script src=/assets/javascript/script.js></script></body></html>