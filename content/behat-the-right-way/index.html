<!DOCTYPE html><html><head><title>Behat - The Right Way</title><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta property=og:site_name content=Gizra><meta property=og:title content="Behat - The Right Way"><meta name=description content="Gizra is a web strategy, design, and
  development agency with an extensive track record in complex content
  management solutions in Drupal and Elm."><meta property=og:description content=""><meta name=twitter:card content="summary_large_image"/><meta name=twitter:site content="@gizra_drupal"/><meta property=og:image content=https://www.gizra.com/assets/images/homepage/gizra-logo-site.jpg><link rel=apple-touch-icon sizes=180x180 href=/assets/favicons/apple-touch-icon-180x180.png><link rel=icon type=image/png href=/assets/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/assets/favicons/favicon-194x194.png sizes=194x194><link rel=icon type=image/png href=/assets/favicons/favicon-96x96.png sizes=96x96><link rel=icon type=image/png href=/assets/favicons/android-chrome-192x192.png sizes=192x192><link rel=icon type=image/png href=/assets/favicons/favicon-16x16.png sizes=16x16><link rel=manifest href=/assets/favicons/manifest.json><meta name=msapplication-TileColor content=#000000><meta name=msapplication-TileImage content=/assets/favicons/mstile-144x144.png><meta name=theme-color content=#ffffff><link href="https://fonts.googleapis.com/css?family=Abril+Fatface&text=gizra" rel=stylesheet><link href="https://fonts.googleapis.com/css?family=Esteban" rel=stylesheet><link href="https://fonts.googleapis.com/css?family=Open+Sans:400,700" rel=stylesheet><link href="https://fonts.googleapis.com/css?family=Montserrat:500,700" rel=stylesheet><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.2.7/semantic.min.css integrity="sha256-wT6CFc7EKRuf7uyVfi+MQNHUzojuHN2pSw0YWFt2K5E=" crossorigin="anonymous"/><link rel=stylesheet href="/assets/stylesheets/style.css"/><script src=https://code.jquery.com/jquery-2.2.4.min.js integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.2.7/semantic.min.js integrity="sha256-flVaeawsBV96vCHiLmXn03IRJym7+ZfcLVvUWONCas8=" crossorigin=anonymous></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-6558346-3', 'auto');
  ga('send', 'pageview');</script></head><body class=pushable><div class="ui sidebar inverted vertical menu left"><a class="item active" href="/">Home</a> <a class=item href=/team>Team</a> <a class=item href=/blog>Blog</a> <a class=item href=/podcast>Podcast</a> <a class=item href=/projects>Projects</a> <a class=item href=/our-story>Our Story</a> <a class=item href=/contact>Contact</a></div><div class=pusher><div class="ui grid container"><header class=row><div class="five wide column menu bar"><div class="ui large secondary menu"><a class="item sidebar-toggle"><i class="big sidebar icon"></i> Menu</a></div></div><div class="six wide computer six wide tablet eleven wide mobile column center aligned"><a class=gizra-logo href="/"><svg xmlns=http://www.w3.org/2000/svg width=252 height=104><title>gizra</title><path fill=#E27058 fill-rule=evenodd d="M44.3 21.6c.2 3.5 3 5.4 6 5.4 3.5 0 6.7-2 6.7-7s-3.6-7.7-8.5-7.7c-4.3 0-10.3 2.5-10.3 11 0 1.7.2 3.4.6 5.3-3.4-2-6.5-2.6-11.6-2.6-16 0-22.7 7.6-22.7 17.5 0 8.7 4 13.7 12.2 16-8.2 5-12 7.8-12 13.8C4.7 78 8 83 20.7 83h10c11 0 13.4 2 13.4 7 0 6.7-5.8 11.3-17 11.3s-13.4-4.7-13.4-9c0-1.8.2-3.5 1-5.8l-6.4-3C4.5 84.8.2 87 .2 92c0 6.8 7.5 11.3 25.8 11.3 21.2 0 29.6-8.5 29.6-20 0-14.4-12-17.2-23.8-17.2H21c-5.5 0-6.6-.4-6.6-1.4 0-1 1-2 4.6-4.4 2.2.4 5.4.8 8.5.8C40.3 61 49 55 49 43c0-6.8-4-10.5-8-13.3-.6-2.5-.8-4.6-.8-6.3 0-6.5 3-7 4.5-7 2.2 0 2.8 1.7 2.5 3.4l-3 1.8zM22 41.2C22 29.7 24 28 27 28s4.6 1.4 4.6 13.2v5c0 11-1.8 12.7-4.6 12.7-3.2 0-5-2.3-5-12V41zM62 10c0 4.4 2 9.8 10.6 9.8 7.6 0 10.6-4.3 10.6-10 0-6.3-3.8-9.6-10.4-9.6C65 .2 62 5 62 10zm-5.4 17v2h6.2v46H57v2h31.2v-2h-6V27H56.7zm82.5 0H95l-1.4 20.2H95c4.3-15 8-18.3 22.2-18.3h1L93 75.3V77h44l1.8-21.5h-1.5C133.5 69 127.5 75 115.6 75h-1.4l25-46v-2zm41 3c2.2 0 4.3 1 2.2 5.3h-3.8c-2.2 7.5 1 12 8.2 12 5.6 0 8.8-4 8.8-10 0-8-5-11.3-11.2-11.3-6.3 0-12 3.6-14 11V27H145v2h5.7v46h-5.8v2h32.6v-2h-7.4V47c0-9.5 4.7-17 9.7-17zm40.5 22.3c-15 0-24.2 2.4-24.2 13 0 10.5 8.2 12.8 15.6 12.8 7.2 0 10.3-2.7 12-7.7 1.2 5 6 7.8 14.4 7.8 9 0 13-3.5 13.5-16l-1.7-.2c-.5 8.8-2.3 10.8-4.2 10.8-1.7 0-3-1.2-3-5.5V46c0-15.2-5.5-19.8-22-19.8-14.3 0-22 4-22 13 0 5 2.6 8.6 9 8.6 5.3 0 9.3-3.3 9.3-8.2 0-2-.3-3.4-.8-4.7H214c-.6-1.2-.8-2.2-.8-3 0-3.4 3-4.3 5-4.3 4.2 0 5.3 3.5 5.3 16.8v8h-3zM219 73.8c-2 0-2.7-1-2.7-8.6v-1.6c0-6.4 2-9.6 6.5-9.6h.7v9.8c0 6.7-2.5 10-4.5 10z"/></svg></a><div class=tagline>We Build Websites</div></div><div class="five wide computer only column"></div></header><div class="ui grid centered post"><div class="sixteen wide mobile sixteen wide tablet twelve wide computer column"><div class="ui raised padded segment"><h1 class="ui dividing header"><div class="ui image"><img src=/assets/images/team/avatars/amitaibu.jpg class="ui circular image"></div><div class=content><a href="/content/behat-the-right-way/">Behat - The Right Way</a><div class="sub header">By Amitai Burstein (@amitaibu) // 17 Nov 2014</div></div><div class="right floated column"><a href=/blog class="ui teal right ribbon big label">Blog Post</a></div></h1><p><a href=http://behat.org>Behat</a> is a wonderful tool for automatic testing. It allows you to write your user stories and scenarios in proper English, which is then parsed by Behat and transformed to a set of clicks or other operations that mimic a real user.</p><p>If you don’t have automated tests on your project, I would argue that you’re doing it wrong (I explain why on <a href=https://www.getpantheon.com/blog/drupal-development-gizra-way>The Gizra Way</a> presentation). Even having a <em>single</em> test is much better than none.</p><p>With that said, it’s super easy to abuse Behat. We are developers and we think sort of like machines (not really, but you get my point). If you would like to test login to your site you could easily do</p><div class="language-cucumber highlighter-rouge"><div class=highlight><pre class=highlight><code><span class=nf>Given </span>I visit <span class=s>"/user/login"</span>
 <span class=c># fill the username and password input fields, and click submit</span>
 <span class=nf>When </span>I fill <span class=s>"username"</span> with <span class=s>"foo"</span>
  <span class=nf>And </span>I fill <span class=s>"password"</span> with <span class=s>"bar"</span>
  <span class=nf>And </span>I press <span class=s>"Login"</span>
 <span class=nf>Then </span>I should get a <span class=s>"200"</span> HTTP response
</code></pre></div></div><p>Your test will return green, but it could be improved:</p><div class="language-cucumber highlighter-rouge"><div class=highlight><pre class=highlight><code><span class=nf>Given </span>I login with an <span class=s>"authenticated"</span> user
 <span class=nf>When </span>I go to the homepage
 <span class=nf>Then </span>I should have access
</code></pre></div></div><p>As you see we are avoiding writing <em>scripted</em> tests, and try to describe what should happen – not the clicks that got us there.</p><p>Meta steps are a great way to help you write your step definition (i.e. each line that is translated to code) with reusable code. So for example</p><div class="language-cucumber highlighter-rouge"><div class=highlight><pre class=highlight><code><span class=nf>Given </span>a group <span class=s>"Public Group 1"</span> with <span class=s>"Public"</span> access is created with group manager <span class=s>"group1-admin"</span>
</code></pre></div></div><p>Would be defined as:</p><div class="language-php highlighter-rouge"><div class=highlight><pre class=highlight><code><span class=cp>&lt;?php</span>

<span class=sd>/**
 * @Given /^a group "([^"]*)" with "([^"]*)" access is created with group manager "([^"]*)"$/
 */</span>
<span class=k>public</span> <span class=k>function</span> <span class=nf>aGroupWithAccessIsCreatedWithGroupManager</span><span class=p>(</span><span class=nv>$title</span><span class=p>,</span> <span class=nv>$access</span><span class=p>,</span> <span class=nv>$username</span><span class=p>)</span> <span class=p>{</span>
  <span class=nv>$steps</span> <span class=o>=</span> <span class=k>array</span><span class=p>();</span>

  <span class=c1>// Login with existing users.</span>
  <span class=nv>$steps</span><span class=p>[]</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Step\When</span><span class=p>(</span><span class=s1>'I am logged in as user "'</span><span class=o>.</span> <span class=nv>$username</span> <span class=o>.</span><span class=s1>'"'</span><span class=p>);</span>
  <span class=nv>$steps</span><span class=p>[]</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Step\When</span><span class=p>(</span><span class=s1>'I visit "node/add/group"'</span><span class=p>);</span>

  <span class=c1>// Set the title and body fields.</span>
  <span class=nv>$steps</span><span class=p>[]</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Step\When</span><span class=p>(</span><span class=s1>'I fill in "title" with "'</span> <span class=o>.</span> <span class=nv>$title</span> <span class=o>.</span> <span class=s1>'"'</span><span class=p>);</span>
  <span class=nv>$steps</span><span class=p>[]</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Step\When</span><span class=p>(</span><span class=s1>'I fill in "edit-body-und-0-summary" with "Some text"'</span><span class=p>);</span>

  <span class=c1>// ... Do any logic needed.</span>

  <span class=k>return</span> <span class=nv>$steps</span><span class=p>;</span>

  <span class=p>}</span>
</code></pre></div></div><p>Also, we avoid harcoding any URL, so instead of writing <code class=highlighter-rouge>When I visit node/1</code> we could write <code class=highlighter-rouge>When I visit "Public Group 1" of type "group"</code> and write some code to find the node by the title and redirect us there.</p><div class="language-php highlighter-rouge"><div class=highlight><pre class=highlight><code><span class=cp>&lt;?php</span>

<span class=sd>/**
 * @When /^I visit "([^"]*)" node of type "([^"]*)"$/
 */</span>
<span class=k>public</span> <span class=k>function</span> <span class=nf>iVisitNodePageOfType</span><span class=p>(</span><span class=nv>$title</span><span class=p>,</span> <span class=nv>$type</span><span class=p>)</span> <span class=p>{</span>
  <span class=nv>$query</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>entityFieldQuery</span><span class=p>();</span>
  <span class=nv>$result</span> <span class=o>=</span> <span class=nv>$query</span>
    <span class=o>-&gt;</span><span class=na>entityCondition</span><span class=p>(</span><span class=s1>'entity_type'</span><span class=p>,</span> <span class=s1>'node'</span><span class=p>)</span>
    <span class=o>-&gt;</span><span class=na>entityCondition</span><span class=p>(</span><span class=s1>'bundle'</span><span class=p>,</span> <span class=nb>strtolower</span><span class=p>(</span><span class=nv>$type</span><span class=p>))</span>
    <span class=o>-&gt;</span><span class=na>propertyCondition</span><span class=p>(</span><span class=s1>'title'</span><span class=p>,</span> <span class=nv>$title</span><span class=p>)</span>
    <span class=o>-&gt;</span><span class=na>propertyCondition</span><span class=p>(</span><span class=s1>'status'</span><span class=p>,</span> <span class=nx>NODE_PUBLISHED</span><span class=p>)</span>
    <span class=o>-&gt;</span><span class=na>range</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
    <span class=o>-&gt;</span><span class=na>execute</span><span class=p>();</span>

  <span class=k>if</span> <span class=p>(</span><span class=k>empty</span><span class=p>(</span><span class=nv>$result</span><span class=p>[</span><span class=s1>'node'</span><span class=p>]))</span> <span class=p>{</span>
    <span class=nv>$params</span> <span class=o>=</span> <span class=k>array</span><span class=p>(</span>
      <span class=s1>'@title'</span> <span class=o>=&gt;</span> <span class=nv>$title</span><span class=p>,</span>
      <span class=s1>'@type'</span> <span class=o>=&gt;</span> <span class=nv>$type</span><span class=p>,</span>
    <span class=p>);</span>
    <span class=k>throw</span> <span class=k>new</span> <span class=nx>Exception</span><span class=p>(</span><span class=nx>format_string</span><span class=p>(</span><span class=s2>"Node @title of @type not found."</span><span class=p>,</span> <span class=nv>$params</span><span class=p>));</span>
  <span class=p>}</span>

  <span class=nv>$nid</span> <span class=o>=</span> <span class=nb>key</span><span class=p>(</span><span class=nv>$result</span><span class=p>[</span><span class=s1>'node'</span><span class=p>]);</span>
  <span class=c1>// Use Drupal Context 'I am at'.</span>
  <span class=k>return</span> <span class=k>new</span> <span class=nx>Given</span><span class=p>(</span><span class=s2>"I go to </span><span class=se>\"</span><span class=s2>node/</span><span class=nv>$nid</span><span class=se>\"</span><span class=s2>"</span><span class=p>);</span>
<span class=p>}</span>
</code></pre></div></div><p>Behat allows you to create a <strong>clean interface</strong> to your system, without having your internal implementation leak out. Just like RESTful is doing, but for testing instead of REST API.</p><h2 id=headless-drupal>Headless Drupal</h2><p>As we are working on decoupled backend and frontend, we still want to have our code properly tested.</p><p>A nice technique we’ve been using is installing the backend (Drupal) and frontend (AngularJS webapp) on the same Travis instance and running Behat tests on the frontend. By having the backend present we don’t need to mock any data just for the frontend, as we already have some dummy migrated data as part of every installation profile. For that we use PhantomsJS (<a href=https://github.com/Gizra/KnowledgeBase/wiki/Behat-phantomJs-install>easy install</a>).</p><p>For the brave, see our <a href=https://github.com/Gizra/negawatt-server/blob/master/.travis.yml>.travis</a> configuration that runs both API and Javascript tests on our fully decoupled app. Note that the linked project is nowhere near ready, but it can still be valuable if you want to see how we got Travis to run our tests.</p><h2 id=casperjs-vs-behat>CasperJS Vs Behat</h2><p>@juampy from Lullabot has recommended in his <a href=https://www.lullabot.com/blog/article/testing-front-end-casperjs>blog post</a> to use CasperJs to test JS. I believe Behat could be better simply because it’s easier to read. For example take this CasperJs code:</p><div class="language-javascript highlighter-rouge"><div class=highlight><pre class=highlight><code><span class=nx>casper</span><span class=p>.</span><span class=nx>test</span><span class=p>.</span><span class=nx>begin</span><span class=p>(</span><span class=s1>'Tests homepage structure'</span><span class=p>,</span> <span class=mi>7</span><span class=p>,</span> <span class=kd>function</span> <span class=nx>suite</span><span class=p>(</span><span class=nx>test</span><span class=p>)</span> <span class=p>{</span>

  <span class=nx>casper</span><span class=p>.</span><span class=nx>start</span><span class=p>(</span><span class=s1>'http://www.msnbc.com'</span><span class=p>,</span> <span class=kd>function</span><span class=p>()</span> <span class=p>{</span>
    <span class=c1>// Verify that the main menu links are present.</span>
    <span class=nx>test</span><span class=p>.</span><span class=nx>assertExists</span><span class=p>(</span><span class=s1>'a.j-signin-label'</span><span class=p>,</span> <span class=s1>'"Sign in" link is found.'</span><span class=p>);</span>
    <span class=nx>test</span><span class=p>.</span><span class=nx>assertExists</span><span class=p>(</span><span class=s1>'a.j-register-label'</span><span class=p>,</span> <span class=s1>'"Sign up" link is found.'</span><span class=p>);</span>
    <span class=nx>test</span><span class=p>.</span><span class=nx>assertExists</span><span class=p>(</span><span class=s1>'li.main-nav__link--explore a'</span><span class=p>,</span> <span class=s1>'"Explore" link is found.'</span><span class=p>);</span>
    <span class=nx>test</span><span class=p>.</span><span class=nx>assertExists</span><span class=p>(</span><span class=s1>'li.main-nav__link--watch a'</span><span class=p>,</span> <span class=s1>'"Watch" link is found.'</span><span class=p>);</span>
    <span class=nx>test</span><span class=p>.</span><span class=nx>assertExists</span><span class=p>(</span><span class=s1>'li.main-nav__link--join-in a'</span><span class=p>,</span> <span class=s1>'"Join In" link is found.'</span><span class=p>);</span>
    <span class=nx>test</span><span class=p>.</span><span class=nx>assertExists</span><span class=p>(</span><span class=s1>'li.main-nav__link--speak-out a'</span><span class=p>,</span> <span class=s1>'"Speak Out" link is found.'</span><span class=p>);</span>
    <span class=c1>// 10 articles should be listed.</span>
    <span class=nx>test</span><span class=p>.</span><span class=nx>assertElementCount</span><span class=p>(</span><span class=s1>'article'</span><span class=p>,</span> <span class=mi>10</span><span class=p>,</span> <span class=s1>'10 articles are listed.'</span><span class=p>);</span>
  <span class=p>});</span>

  <span class=nx>casper</span><span class=p>.</span><span class=nx>run</span><span class=p>(</span><span class=kd>function</span><span class=p>()</span> <span class=p>{</span>
    <span class=nx>test</span><span class=p>.</span><span class=nx>done</span><span class=p>();</span>
  <span class=p>});</span>
<span class=p>});</span>
</code></pre></div></div><p>… and imagine how it could have been translated to Behat:</p><div class="language-cucumber highlighter-rouge"><div class=highlight><pre class=highlight><code><span class=nt>@javascript</span>
<span class=kn>Scenario</span><span class=p>:</span> Validate an anonymous user can see all links, and a list of articles.
  <span class=nf>Given </span>I am an anonymous user
   <span class=nf>When </span>I visit the homepage
   <span class=nf>Then </span>I should see the main menu links for <span class=s>"anonymous"</span> user are present
    <span class=nf>And </span>I should see a teaser with <span class=s>"10"</span> items of recent articles
</code></pre></div></div><p>The underlying code in the end will be very close to the one in CasperJS - however it better defined <em>what</em> is needed, not only how it should appear, and arguably it’s more readable by other developers.</p></div></div><div class="twelve wide column computer only"><div class="ui borderless secondary menu"><a class=item href="/content/restful-discovery/"><i class="chevron left icon"></i> RESTful Discovery - Who knows about your API?</a><div class="right menu"><a class=item href="/content/todo-restful-backend/">Todo app with RESTful backend <i class="chevron right icon"></i></a></div></div></div><div class="twelve wide column"><div class="ui segment basic"><div id=disqus_thread></div><script type=text/javascript>var disqus_shortname = 'gizra';
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();</script><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div></div></div></div><footer class="ui black inverted vertical footer segment padded"><div class="ui center aligned container"><div class="ui three column stackable inverted grid"><div class=column><address><div class=strong>Israel Headquarters</div><div>5 Brenner Street, Tel Aviv</div><a class=telephone href=tel:+97233731222>+972-3-3731222</a> // <a class=email href=mailto:info@gizra.com>info@gizra.com</a></address></div><div class="column icons"><a target=_blank href=https://twitter.com/gizra_drupal><i class="twitter huge icon"></i></a> <a target=_blank href=https://github.com/Gizra/gizra.com><i class="github huge icon"></i></a></div><div class=column><address><div class=strong>North America Office</div><div>350 N. Orleans Street, Suite 9000N, Chicago, IL 60654</div><a class=telephone href=tel:+13125857625>312-585-7625</a> // <a class=email href=mailto:usoffice@gizra.com>usoffice@gizra.com</a></address></div></div></div></footer></div><script src=/bower_components/anchor-js/anchor.min.js></script><script src=/assets/javascript/script.js></script></body></html>