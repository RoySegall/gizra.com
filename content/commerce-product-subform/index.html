<!DOCTYPE html>
<html lang="en">
    <head>
      <meta charset="utf-8">
      <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
      
    

<title>Commerce product + Subform</title>


      <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
      <meta content="Gizra" property="og:site_name">

      
        <meta content="Commerce product + Subform" property="og:title">
      

      

      

      <!-- Favicon for all platforms -->
      <link rel="apple-touch-icon" sizes="180x180" href="/images/favicons/apple-touch-icon-180x180.5691.png">
      <link rel="icon" type="image/png" href="/images/favicons/favicon-32x32.c391.png" sizes="32x32">
      <link rel="icon" type="image/png" href="/images/favicons/favicon-194x194.e5f8.png" sizes="194x194">
      <link rel="icon" type="image/png" href="/images/favicons/favicon-96x96.8557.png" sizes="96x96">
      <link rel="icon" type="image/png" href="/images/favicons/android-chrome-192x192.17e1.png" sizes="192x192">
      <link rel="icon" type="image/png" href="/images/favicons/favicon-16x16.7353.png" sizes="16x16">
      <link rel="manifest" href="/images/favicons/manifest.json">
      <meta name="msapplication-TileColor" content="#000000">
      <meta name="msapplication-TileImage" content="/images/favicons/mstile-144x144.png">
      <meta name="theme-color" content="#ffffff">
      <!-- End favicon for all platforms -->

      <link rel="stylesheet" href="/css/main.e27e.css"/>
      <link href='http://fonts.googleapis.com/css?family=Abril+Fatface&text=gizra' rel='stylesheet' type='text/css'>
      <link href='https://fonts.googleapis.com/css?family=Hind:400,600,300,500' rel='stylesheet' type='text/css'>
      <link href='https://fonts.googleapis.com/css?family=Raleway:400,300,600,800' rel='stylesheet' type='text/css'>
      <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
      <!-- Google Analytics -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-6558346-3', 'auto');
  ga('send', 'pageview');

</script>
<!-- End Google Analytics -->


      <!-- Begin Inspectlet Embed Code -->
      <script type="text/javascript" id="inspectletjs">
      window.__insp = window.__insp || [];
      __insp.push(['wid', 314054580]);
      (function() {
      function ldinsp(){if(typeof window.__inspld != "undefined") return; window.__inspld = 1; var insp = document.createElement('script'); insp.type = 'text/javascript'; insp.async = true; insp.id = "inspsync"; insp.src = ('https:' == document.location.protocol ? 'https' : 'http') + '://cdn.inspectlet.com/inspectlet.js'; var x = document.getElementsByTagName('script')[0]; x.parentNode.insertBefore(insp, x); };
      setTimeout(ldinsp, 500); document.readyState != "complete" ? (window.attachEvent ? window.attachEvent('onload', ldinsp) : window.addEventListener('load', ldinsp, false)) : ldinsp();
      })();
      </script>
      <!-- End Inspectlet Embed Code -->

    </head>
    <body>

    <!-- Main content -->
    
  



  
    
      
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  


<header id="header-global">
  <div class="container">
    <div class="row">
      <div class="col-sm-12">
        
  

<span class="gizra-logo"><a href="/">gizra</a></span>
<h1 class="sr-only">Gizra</h1>
<nav id="nav" role="navigation" class="navbar navbar-default">
  <div class="navbar-header">
    <button data-target=".navbar-collapse" data-toggle="collapse" class="navbar-toggle" type="button">
      <span class="sr-only">Toggle navigation</span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
    </button>
  </div>
  <div class="navbar-collapse collapse">
    <ul class="nav navbar-nav">
      <li><a href="/#about" class="smooth-scroll-to">About</a></li>
      <li><a href="/services">Our Work</a></li>
      <li><a href="/team">Team</a></li>
      <li><a href="/blog">Blog</a></li>
      <li><a href="/fit">Do We Fit?</a></li>
      <li><a href="/contact">Contact</a></li>
    </ul>
  </div>
</nav>

      </div>
    </div>
  </div>
</header>
<article id="post-page">
  <div class="container">
    <div class="row">
      <div id="post-title" class="col-sm-10 col-sm-offset-1">
        <h1><a href="/content/commerce-product-subform/">Commerce product + Subform </a></h1>
        <div class="post-author">By Amitai Burstein</div>
      </div>
    </div>
    <div class="row">
      <div id="post-data" class="col-sm-2 col-sm-offset-1">
  			<div id="post-label">
  		 		<a href="/blog"><span class="label label-default">Gizra Blog</span></a>
  			</div>
        <div class="date">29 Jan 2012</div>
        <section class="author-details">
          <div class="image-wrapper">
            <img src="/images/team/avatars/amitaibu.42a1.jpg" class="img-circle img-responsive">
          </div>
          <div class="text-wrapper">
            <span class="name">Amitai Burstein</span>
            
              <span class="twitter">(@amitaibu)</span>
            
            <div class="title">CTO, Co-Owner</div>
            <div class="bio">Maintainer of Organic groups, the Message stack, and co-maintainer of Drupal 8's Entity reference. <a href="/content/the-about-story/">The about story</a>.</div>
          </div>
        </section>
        <div class="tags">
          <div class="title">Tags:</div>
          
            <ul class="inline">
              
              

  
    
      <li><a href="/tags.html#Commerce-ref">Commerce</a></li>
    
      <li><a href="/tags.html#Subform-ref">Subform</a></li>
    
      <li><a href="/tags.html#CTools-ref">CTools</a></li>
    
      <li><a href="/tags.html#Drupal-planet-ref">Drupal-planet</a></li>
    
  


            </ul>
          
        </div>
      </div>
      <div id="post-content" class="col-sm-8">

        <p><strong>Edit: Use the <a href="http://drupal.org/project/inline_entity_form">Inline entity form</a> module that was created after this post was published.</strong></p>

<p>This post will go over an example (yet fully functionally) module that shows how we can embed a commerce product form inside a node form, and have the node reference the commerce product - without horrible hacks.</p>

<!-- more -->

<p><img src="/assets/images/legacy/Product-1.jpg" /></p>

<p><img src="/assets/images/legacy/Create-Product-2.jpg" /></p>

<p><img src="/assets/images/legacy/Product-3-Site-Install.jpg" /></p>

<p><a href="https://github.com/amitaibu/commerce_product_subform">Here is the code</a></p>

<p>The problem is obviously the fact that we don’t have commerce product ID nor a node ID, as none of those objects is saved. A second problem is how to actually embed the commerce product form inside the node form. <a href="http://drupal.org/project/subform">Subform</a> module solves both issues (with a little custom code help).</p>

<p>I won’t go over each line of code here, as the module is well documented, however I will explain the _important steps.</p>

<p>In the node&rsquo;s form alter, we embed the commerce product, using Subform’s form element.</p>
<div class="highlight"><pre><code class="php language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="nx">module_load_include</span><span class="p">(</span><span class="s1">&#39;inc&#39;</span><span class="p">,</span> <span class="s1">&#39;commerce_product&#39;</span><span class="p">,</span> <span class="s1">&#39;includes/commerce_product.forms&#39;</span><span class="p">);</span>
<span class="nv">$form</span><span class="p">[</span><span class="s1">&#39;commerce_product_subform&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
  <span class="s1">&#39;#type&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;subform&#39;</span><span class="p">,</span>
  <span class="s1">&#39;#subform_id&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;commerce_product_ui_product_form&#39;</span><span class="p">,</span>
  <span class="s1">&#39;#subform_arguments&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="nv">$commerce_product</span><span class="p">),</span>
  <span class="s1">&#39;#required&#39;</span> <span class="o">=&gt;</span> <span class="k">TRUE</span><span class="p">,</span>
  <span class="s1">&#39;#weight&#39;</span> <span class="o">=&gt;</span> <span class="mi">10</span><span class="p">,</span>
<span class="p">);</span>
<span class="cp">?&gt;</span><span class="x"></span>
</code></pre></div>
<p>In the code above we embed the form, pass it a $product object, and say it is required - meaning Subform should do validation on the embedded form.
Next step, is adding submit handlers <strong>in the right order</strong></p>
<div class="highlight"><pre><code class="php language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="c1">// Set the first submit handler to be &quot;subform_submit_all&quot;, so the</span>
<span class="c1">// commerce product will be created, before handing the submitted node</span>
<span class="c1">// se we can associate the node to the commerce product.</span>
<span class="c1">// The last submit handler is the original &#39;node_form_submit&#39;, which</span>
<span class="c1">// will get all the values already populated, and save the node.</span>
<span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$node</span><span class="o">-&gt;</span><span class="na">nid</span><span class="p">))</span> <span class="p">{</span>
  <span class="nb">array_unshift</span><span class="p">(</span><span class="nv">$form</span><span class="p">[</span><span class="s1">&#39;actions&#39;</span><span class="p">][</span><span class="s1">&#39;submit&#39;</span><span class="p">][</span><span class="s1">&#39;#submit&#39;</span><span class="p">],</span> <span class="s1">&#39;subform_submit_all&#39;</span><span class="p">,</span> <span class="s1">&#39;commerce_product_subform_commerce_product_submit&#39;</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">else</span> <span class="p">{</span>
  <span class="c1">// The node already exists, so we assume there is already a reference</span>
  <span class="c1">// to the commerce product, so just add &quot;subform_submit_all&quot; submit</span>
  <span class="c1">// handler, to make sure the commerce product can be edited.</span>
  <span class="nb">array_unshift</span><span class="p">(</span><span class="nv">$form</span><span class="p">[</span><span class="s1">&#39;actions&#39;</span><span class="p">][</span><span class="s1">&#39;submit&#39;</span><span class="p">][</span><span class="s1">&#39;#submit&#39;</span><span class="p">],</span> <span class="s1">&#39;subform_submit_all&#39;</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">?&gt;</span><span class="x"></span>
</code></pre></div>
<p>Noticed the emphasize on the “right order” above? That’s because we want Subform to first submit the commerce product form (thus the commerce product will be saved and have an ID), next we want our own submit handler to set the field reference from the node to the commerce product, and last we want the original <code>node_form_submit()</code> to save the node.</p>

<p>In the example module, you will notice that we also hide the commerce product title. The reason is that we can easily populate the title from the node&rsquo;s title (see <code>commerce_product_subform_form_commerce_product_ui_validate()</code>).</p>

<p>As bonus, the example module also has a CTools plugin, that allows you to add the subform to an node add/ edit page that was overriden by Page manager.</p>


      </div>
    </div>
  </div>
</article>
<section id="post-nav">
  <div class="container">
    <div class="row">
      <div class="col-sm-3 col-sm-offset-3 col-xs-6 previous">
        
        <a href="/content/sending-lots-emails-hint-drush/">
          <div id="previous-label" class="text-small">
            <span class="hidden-xs"><i class="fa fa-chevron-circle-left"></i>&nbsp;Sending LOTS of emails (Hint: with Drush)</span>
            <span class="visible-xs"><i class="fa fa-chevron-circle-left"></i>&nbsp;Previous post</span>
          </div>
        </a>
        
      </div>
      <div class="col-sm-3 col-sm-offset-2 col-xs-6 next">
        
        <a href="/content/banner-rotator/">
          <div id="next-label" class="text-small">
            <span class="hidden-xs">Banner rotator&nbsp;<i class="fa fa-chevron-circle-right"></i></span>
            <span class="visible-xs">Next post&nbsp;<i class="fa fa-chevron-circle-right"></i></span>
          </div>
        </a>
        
      </div>
    </div>
  </div>
</section>
<section>
  <div class="container">
    <div class="row">
      <div class="col-sm-8 col-sm-offset-3">
        <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_developer = 1;
    var disqus_shortname = 'gizra';
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

      </div>
    </div>
  </div>
</section>
    


    <!--Footer -->
    
  <div id="contact">
    <footer id="footer" role="contentinfo">
      <div class="footer-wrapper">
        <div class="background">
          <div class="container">
            <div class="row">
              <div class="col-sm-12">
                <h2 class="title">Talk to us</h2>
                <div class="clearfix">
                  <address>
                    <div class="strong">Israel Headquarters</div>
                    <span>5 Brenner Street, Tel Aviv</span>
                      <a class="telephone" href="tel:+97233731222">+972-3-3731222</a>
                    <a class="email" href="mailto:info@gizra.com">info@gizra.com</a>
                  </address>
                  <address class="separator">
                    <div class="strong">North America Office</div>
                    <span>106 West 32nd Street, 2nd Floor, New York, NY 10001</span>
                    <a class="telephone" href="tel:+13476864508">212-634-1687</a>
                    <a class="email" href="mailto:usoffice@gizra.com">usoffice@gizra.com</a>
                  </address>
                  <div class="separator social-links">
                    <span class="link github">
                      <a href="https://github.com/Gizra" target="_blank"><i class="fa fa-github-square"></i><span class="link-text">Gizra's Github Account</span></a>
                    </span>
                    <span class="link twitter">
                      <a href="https://twitter.com/gizra_drupal" target="_blank"><i class="fa fa-twitter-square"></i><span class="link-text">Gizra's Twitter Account</span></a>
                    </span>
                    <span class="link linkedin">
                      <a href="https://www.linkedin.com/company/gizra-ltd" target="_blank"><i class="fa fa-linkedin-square"></i><span class="link-text">Gizra's LinkedIn Page</span></a>
                    </span>
                    <span class="link facebook">
                      <a href="https://www.facebook.com/gizraltd/timeline" target="_blank"><i class="fa fa-facebook-square"></i><span class="link-text">Gizra's Facebook Page</span></a>
                    </span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </footer>
  </div>



    <script src="/js/plugins.806b.js"></script>

    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery-backstretch/2.0.4/jquery.backstretch.min.js"></script>

    <script src="/js/scripts.f755.js"></script>
    </body>
</html>
