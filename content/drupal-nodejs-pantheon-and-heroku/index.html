<!DOCTYPE html><html><head><title>Drupal, Node.js, Pantheon, and Heroku</title><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta property=og:site_name content=Gizra><meta property=og:title content="Drupal, Node.js, Pantheon, and Heroku"><link rel=apple-touch-icon sizes=180x180 href=/assets/favicons/apple-touch-icon-180x180.png><link rel=icon type=image/png href=/assets/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/assets/favicons/favicon-194x194.png sizes=194x194><link rel=icon type=image/png href=/assets/favicons/favicon-96x96.png sizes=96x96><link rel=icon type=image/png href=/assets/favicons/android-chrome-192x192.png sizes=192x192><link rel=icon type=image/png href=/assets/favicons/favicon-16x16.png sizes=16x16><link rel=manifest href=/assets/favicons/manifest.json><meta name=msapplication-TileColor content=#000000><meta name=msapplication-TileImage content=/assets/favicons/mstile-144x144.png><meta name=theme-color content=#ffffff><link href="https://fonts.googleapis.com/css?family=Rasa" rel=stylesheet><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.2.7/semantic.min.css integrity="sha256-wT6CFc7EKRuf7uyVfi+MQNHUzojuHN2pSw0YWFt2K5E=" crossorigin="anonymous"/><link rel=stylesheet href="/assets/stylesheets/style.css"/><script src=https://code.jquery.com/jquery-2.2.4.min.js integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.2.7/semantic.min.js integrity="sha256-flVaeawsBV96vCHiLmXn03IRJym7+ZfcLVvUWONCas8=" crossorigin=anonymous></script></head><body class=pushable><div class="ui sidebar inverted vertical menu left"><a class="item active" href="/">Home</a> <a class=item href=/team>Team</a> <a class=item href=/blog>Blog</a> <a class=item href=/projects>Projects</a> <a class=item href=/contact>Contact</a></div><div class=pusher><div class="ui grid container"><header class=row><div class="five wide column menu bar"><div class="ui large secondary menu"><a class="item sidebar-toggle"><i class="big sidebar icon"></i> Menu</a></div></div><div class="six wide computer eleven wide tablet column center aligned"><a class=gizra-logo href="/"><svg xmlns=http://www.w3.org/2000/svg width=252 height=104><title>gizra</title><path fill=#E27058 fill-rule=evenodd d="M44.3 21.6c.2 3.5 3 5.4 6 5.4 3.5 0 6.7-2 6.7-7s-3.6-7.7-8.5-7.7c-4.3 0-10.3 2.5-10.3 11 0 1.7.2 3.4.6 5.3-3.4-2-6.5-2.6-11.6-2.6-16 0-22.7 7.6-22.7 17.5 0 8.7 4 13.7 12.2 16-8.2 5-12 7.8-12 13.8C4.7 78 8 83 20.7 83h10c11 0 13.4 2 13.4 7 0 6.7-5.8 11.3-17 11.3s-13.4-4.7-13.4-9c0-1.8.2-3.5 1-5.8l-6.4-3C4.5 84.8.2 87 .2 92c0 6.8 7.5 11.3 25.8 11.3 21.2 0 29.6-8.5 29.6-20 0-14.4-12-17.2-23.8-17.2H21c-5.5 0-6.6-.4-6.6-1.4 0-1 1-2 4.6-4.4 2.2.4 5.4.8 8.5.8C40.3 61 49 55 49 43c0-6.8-4-10.5-8-13.3-.6-2.5-.8-4.6-.8-6.3 0-6.5 3-7 4.5-7 2.2 0 2.8 1.7 2.5 3.4l-3 1.8zM22 41.2C22 29.7 24 28 27 28s4.6 1.4 4.6 13.2v5c0 11-1.8 12.7-4.6 12.7-3.2 0-5-2.3-5-12V41zM62 10c0 4.4 2 9.8 10.6 9.8 7.6 0 10.6-4.3 10.6-10 0-6.3-3.8-9.6-10.4-9.6C65 .2 62 5 62 10zm-5.4 17v2h6.2v46H57v2h31.2v-2h-6V27H56.7zm82.5 0H95l-1.4 20.2H95c4.3-15 8-18.3 22.2-18.3h1L93 75.3V77h44l1.8-21.5h-1.5C133.5 69 127.5 75 115.6 75h-1.4l25-46v-2zm41 3c2.2 0 4.3 1 2.2 5.3h-3.8c-2.2 7.5 1 12 8.2 12 5.6 0 8.8-4 8.8-10 0-8-5-11.3-11.2-11.3-6.3 0-12 3.6-14 11V27H145v2h5.7v46h-5.8v2h32.6v-2h-7.4V47c0-9.5 4.7-17 9.7-17zm40.5 22.3c-15 0-24.2 2.4-24.2 13 0 10.5 8.2 12.8 15.6 12.8 7.2 0 10.3-2.7 12-7.7 1.2 5 6 7.8 14.4 7.8 9 0 13-3.5 13.5-16l-1.7-.2c-.5 8.8-2.3 10.8-4.2 10.8-1.7 0-3-1.2-3-5.5V46c0-15.2-5.5-19.8-22-19.8-14.3 0-22 4-22 13 0 5 2.6 8.6 9 8.6 5.3 0 9.3-3.3 9.3-8.2 0-2-.3-3.4-.8-4.7H214c-.6-1.2-.8-2.2-.8-3 0-3.4 3-4.3 5-4.3 4.2 0 5.3 3.5 5.3 16.8v8h-3zM219 73.8c-2 0-2.7-1-2.7-8.6v-1.6c0-6.4 2-9.6 6.5-9.6h.7v9.8c0 6.7-2.5 10-4.5 10z"/></svg></a><div class=tagline>We Build Websites</div></div><div class="five wide computer only column"></div></header><div class="ui grid centered post"><div class="sixteen wide mobile sixteen wide tablet twelve wide computer column"><div class="ui raised padded segment"><h1 class="ui dividing header"><div class="ui image"><img src=/assets/images/team/avatars/amitaibu.jpg class="ui circular image"></div><div class=content><a href="/content/drupal-nodejs-pantheon-and-heroku/">Drupal, Node.js, Pantheon, and Heroku</a><div class="sub header">By Amitai Burstein (@amitaibu) // 19 Dec 2012</div></div><div class="right floated column"><a href=/blog class="ui teal right ribbon label">Blog post</a></div></h1><p>Some title, right?</p><p><a href=http://drupal.org/project/nodejs>Node.js</a> module for Drupal is so great and a time saver, I’ve got spare time to blog about how to set it up. Future me, we’ll thank me for doing so.</p><p>First, let’s define the goals for this blog post</p><ul><li>Learn how to setup the Node.js module and server on a <em>local</em> server</li><li>Setup on a remote server using Heroku and Pantheon</li></ul><h3 id=install-node>Install node</h3><p>Node.js module’s README.txt explains how to do it. I’m using Mac so for me it was a simple <code class=highlighter-rouge>brew install node</code>. Get the latest release of the Node.js module, and enable it. Download the node libraries needed by executing <code class=highlighter-rouge>npm install</code> from the Node.js module directory. That command will look at <code class=highlighter-rouge>package.json</code> and install all the dependencies. Ok, On to the interesting parts.</p><h3 id=local-server>Local Server</h3><p>Node.js module requires a simple configuration file that will tell it where the node.js server is running, and where the “backend” is (i.e. Drupal). Ignore the example in README.txt, eyes over here please. Assuming my Drupal site is on http://localhost/d7_dev here’s <code class=highlighter-rouge>nodejs.config.js</code>:</p><div class="language-javascript highlighter-rouge"><pre class=highlight><code><span class=nx>settings</span> <span class=o>=</span> <span class=p>{</span>
  <span class=na>scheme</span><span class=p>:</span> <span class=s1>'http'</span><span class=p>,</span>
  <span class=na>port</span><span class=p>:</span> <span class=mi>5000</span><span class=p>,</span>
  <span class=na>host</span><span class=p>:</span> <span class=s1>'localhost'</span><span class=p>,</span>
  <span class=na>resource</span><span class=p>:</span> <span class=s1>'/socket.io'</span><span class=p>,</span>
  <span class=na>serviceKey</span><span class=p>:</span> <span class=s1>'beejeebusRocks'</span><span class=p>,</span>
  <span class=na>backend</span><span class=p>:</span> <span class=p>{</span>
    <span class=na>port</span><span class=p>:</span> <span class=mi>80</span><span class=p>,</span>
    <span class=na>host</span><span class=p>:</span> <span class=s1>'localhost'</span><span class=p>,</span>
    <span class=na>scheme</span><span class=p>:</span> <span class=s1>'http'</span><span class=p>,</span>
    <span class=na>basePath</span><span class=p>:</span> <span class=s1>'/d7_dev'</span><span class=p>,</span>
    <span class=na>messagePath</span><span class=p>:</span> <span class=s1>'/nodejs/message'</span>
  <span class=p>},</span>
  <span class=na>transports</span><span class=p>:</span> <span class=p>[</span><span class=s1>'polling'</span><span class=p>,</span> <span class=s1>'websocket'</span><span class=p>],</span>
  <span class=na>debug</span><span class=p>:</span> <span class=kc>true</span>
<span class=p>};</span>
</code></pre></div><p>The first part tells Node.js module where the node.js server will live. In the above example it will be <code class=highlighter-rouge>http://localhost:5000</code>. Same host different ports.</p><p>The “backend” part tells the node.js server where our Drupal site is. The <code class=highlighter-rouge>serviceKey</code> is the secret code used by Drupal to communicate with the node.js server. In my example it’s also used as a special thank you for <strong>beejeebus</strong>, the module maintainer. Next, from the command line execute <code class=highlighter-rouge>node server.js</code>. If you defined the URL and port correctly (pay extra attention to all those leading and trailing slashes!) you should see</p><div class=highlighter-rouge><pre class=highlight><code>Started http server.
   info  - socket.io started
</code></pre></div><p>Visit <code class=highlighter-rouge>http://localhost:5000/</code> and the (confusing) message “Not found” should greet you. Wait, What? Why “Not found”, if it’s working?! The reason is that the node.js server is accepting only POST and any GET results with a 404.</p><p>Back to Drupal. In your <code class=highlighter-rouge>settings.php</code> add <code class=highlighter-rouge>$conf['nodejs_service_key'] = 'beejeebusRocks';</code>, which is the Drupal equivalent for the serviceKey in the JS configuration. Visit <code class=highlighter-rouge>admin/config/nodejs/config</code> and fill out the form, this time to let _Drupal know about the node.js server. Again, pay attention to leading and trailing slashes.</p><div class=highlighter-rouge><pre class=highlight><code>Node.js server host = localhost
port = 5000
</code></pre></div><h4>The Fun Part!</h4><ol><li>Enable "Nodejs Notifications" module</li><li>Open another browser in the background, and login as another user</li><li>Back as the administrator go to ``admin/config/nodejs/nodejs_notify/broadcast`` and broadcast your message</li><li>The message will appear using Growl in the second browser</li><li>Repeat 2 - 5 until you climax. Personally, It took me about 10 browsers open simultaneously to get there!</li></ol><h3>Deploy it!</h3><p>Ok, we had our fun on the local server time to see it in action, on a _real server. This time let’s start with the Drupal part. Probably the quickest way to get it up is to grab an account on <a href="https://www.getpantheon.com/">Pantheon</a> and create a Clean Drupal 7 installation (I did it two years ago, and haven’t regretted since…) Let’s say my new site is called <code class=highlighter-rouge>dev.gizra.gotpantheon.com</code> Add the module, and the service key in settings.php, yada yada yada. Indeed, we will still need to deal with the Node.js module configuration. Right after the Heroku section.</p><h4>The Heroku section</h4><p>Wow. Seriously. Those guys in Heroku made deployment of a node.js server really easy. After you sign up, and download the <a href=https://toolbelt.heroku.com>Heroku toolbelt</a> (a command line utility), you can read <a href=https://devcenter.heroku.com/articles/nodejs>this</a> quick introduction that will show you how easy it’s to deploy from the command line. If you know how to use git, you’ll know to use Heroku.</p><p>Git clone <a href=https://github.com/amitaibu/DrupalNodejsHeroku>amitaibu/DrupalNodejsHeroku</a> outside of the Drupal installation. Quick file overview: I’ve Copied <code class=highlighter-rouge>server.js</code> from the Node.js module. I’ve changed a bit the <code class=highlighter-rouge>package.json</code> so Heroku will be able to build it. I’ve added a default <code class=highlighter-rouge>nodejs.config.js</code> you <strong>will need to edit</strong> and add your own <code class=highlighter-rouge>serviceKey</code> and <code class=highlighter-rouge>backend.host</code>. Here is how my file looked</p><div class="language-javascript highlighter-rouge"><pre class=highlight><code><span class=nx>settings</span> <span class=o>=</span> <span class=p>{</span>
  <span class=na>scheme</span><span class=p>:</span> <span class=s1>'http'</span><span class=p>,</span>
  <span class=na>port</span><span class=p>:</span> <span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>PORT</span> <span class=o>||</span> <span class=mi>5000</span><span class=p>,</span>
  <span class=na>host</span><span class=p>:</span> <span class=s1>''</span><span class=p>,</span>
  <span class=na>resource</span><span class=p>:</span> <span class=s1>'/socket.io'</span><span class=p>,</span>
  <span class=na>serviceKey</span><span class=p>:</span> <span class=s1>'beejeebusRocks'</span><span class=p>,</span>
  <span class=na>backend</span><span class=p>:</span> <span class=p>{</span>
    <span class=na>host</span><span class=p>:</span> <span class=s1>'dev.gizra.gotpantheon.com'</span><span class=p>,</span>
    <span class=na>port</span><span class=p>:</span> <span class=mi>80</span><span class=p>,</span>
    <span class=na>scheme</span><span class=p>:</span> <span class=s1>'http'</span><span class=p>,</span>
    <span class=na>messagePath</span><span class=p>:</span> <span class=s1>'/nodejs/message'</span>
  <span class=p>},</span>
  <span class=na>transports</span><span class=p>:</span> <span class=p>[</span><span class=s1>'xhr-polling'</span><span class=p>],</span>
  <span class=na>debug</span><span class=p>:</span> <span class=kc>true</span>
<span class=p>};</span>
</code></pre></div><p>Notice several changes:</p><ul><li>backend.host is now pointing to my own Pantheon site. Remember to change it</li><li>The port of the node.js server is now ``process.env.PORT || 5000``. Heroku will make sure to inject that variable when executed, so our node.js server will listen on the right port</li><li>The transport mechanism is xhr-polling. Heroku still doesn't sup Websockets port, but bare in mind that it's the node.js server that gets the polling, _not the Drupal server</li></ul><p>Next, we can deploy it to Heroku.</p><div class="language-bash highlighter-rouge"><pre class=highlight><code><span class=gp>$ </span>heroku create
<span class=gp>$ </span>git push heroku master
</code></pre></div><p>(I also added a .gitignore file that will ignore <code class=highlighter-rouge>node_modules</code> in case you will <code class=highlighter-rouge>npm install</code>). Notice how not only the files are pushed to git, but Heroku now builds the dependencies and launches the server. In the end of the output you will see the URL of your new site. That’s the node.js server URL, Drupal will POST data to. You can also open it with <code class=highlighter-rouge>heroku open</code></p><h4>Back to Drupal</h4><p>Visit <code class=highlighter-rouge>admin/config/nodejs/config</code> and fill out the form. <em>My</em> configuration looked like this:</p><div class=highlighter-rouge><pre class=highlight><code>Node.js server host = nameless-brook-555.herokuapp.com
port = 80
</code></pre></div><p>Enable the Node.js modules, and start enjoying the work of other great people!</p></div></div><div class="twelve wide column computer only"><div class="ui borderless secondary menu"><a class=item href="/content/message-subscribe-new-subscription-system/"><i class="chevron left icon"></i> Message-subscribe - A New Subscription System</a><div class="right menu"><a class=item href="/content/migrate-and-baking-content/">Migrate, and baking content <i class="chevron right icon"></i></a></div></div></div><div class="twelve wide column"><div class="ui segment basic"></div></div></div></div><footer class="ui black inverted vertical footer segment padded"><div class="ui center aligned container"><div class="ui three column stackable inverted grid"><div class=column><address><div class=strong>Israel Headquarters</div><div>5 Brenner Street, Tel Aviv</div><a class=telephone href=tel:+97233731222>+972-3-3731222</a> // <a class=email href=mailto:info@gizra.com>info@gizra.com</a></address></div><div class="column icons"><a target=_blank href=https://twitter.com/gizra_drupal><i class="twitter huge icon"></i></a> <a target=_blank href=https://github.com/Gizra/gizra.com><i class="github huge icon"></i></a></div><div class=column><address><div class=strong>North America Office</div><div>350 N. Orleans Street, Suite 9000N, Chicago, IL 60647</div><a class=telephone href=tel:+13125857625>312-585-7625</a> // <a class=email href=mailto:usoffice@gizra.com>usoffice@gizra.com</a></address></div></div></div></footer></div><script src=/bower_components/anchor-js/anchor.min.js></script><script src=/assets/javascript/script.js></script></body></html>