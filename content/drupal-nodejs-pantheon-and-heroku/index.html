<!DOCTYPE html>
<html lang="en">
    <head>
      <meta charset="utf-8">
      <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
      
    

<title>Drupal, Node.js, Pantheon, and Heroku</title>


      <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
      <meta content="Gizra" property="og:site_name">

      
        <meta content="Drupal, Node.js, Pantheon, and Heroku" property="og:title">
      

      

      

      <!-- Favicon for all platforms -->
      <link rel="apple-touch-icon" sizes="180x180" href="/images/favicons/apple-touch-icon-180x180.4fe6.png">
      <link rel="icon" type="image/png" href="/images/favicons/favicon-32x32.c391.png" sizes="32x32">
      <link rel="icon" type="image/png" href="/images/favicons/favicon-194x194.2d07.png" sizes="194x194">
      <link rel="icon" type="image/png" href="/images/favicons/favicon-96x96.8557.png" sizes="96x96">
      <link rel="icon" type="image/png" href="/images/favicons/android-chrome-192x192.8b66.png" sizes="192x192">
      <link rel="icon" type="image/png" href="/images/favicons/favicon-16x16.a93c.png" sizes="16x16">
      <link rel="manifest" href="/images/favicons/manifest.json">
      <meta name="msapplication-TileColor" content="#000000">
      <meta name="msapplication-TileImage" content="/images/favicons/mstile-144x144.png">
      <meta name="theme-color" content="#ffffff">
      <!-- End favicon for all platforms -->

      <link rel="stylesheet" href="/css/main.e27e.css"/>
      <link href='http://fonts.googleapis.com/css?family=Abril+Fatface&text=gizra' rel='stylesheet' type='text/css'>
      <link href='https://fonts.googleapis.com/css?family=Hind:400,600,300,500' rel='stylesheet' type='text/css'>
      <link href='https://fonts.googleapis.com/css?family=Raleway:400,300,600,800' rel='stylesheet' type='text/css'>
      <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
      <!-- Google Analytics -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-6558346-3', 'auto');
  ga('send', 'pageview');

</script>
<!-- End Google Analytics -->


      <!-- Begin Inspectlet Embed Code -->
      <script type="text/javascript" id="inspectletjs">
      window.__insp = window.__insp || [];
      __insp.push(['wid', 314054580]);
      (function() {
      function ldinsp(){if(typeof window.__inspld != "undefined") return; window.__inspld = 1; var insp = document.createElement('script'); insp.type = 'text/javascript'; insp.async = true; insp.id = "inspsync"; insp.src = ('https:' == document.location.protocol ? 'https' : 'http') + '://cdn.inspectlet.com/inspectlet.js'; var x = document.getElementsByTagName('script')[0]; x.parentNode.insertBefore(insp, x); };
      setTimeout(ldinsp, 500); document.readyState != "complete" ? (window.attachEvent ? window.attachEvent('onload', ldinsp) : window.addEventListener('load', ldinsp, false)) : ldinsp();
      })();
      </script>
      <!-- End Inspectlet Embed Code -->

    </head>
    <body>

    <!-- Main content -->
    
  



  
    
      
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  


<header id="header-global">
  <div class="container">
    <div class="row">
      <div class="col-sm-12">
        
  

<span class="gizra-logo"><a href="/">gizra</a></span>
<h1 class="sr-only">Gizra</h1>
<nav id="nav" role="navigation" class="navbar navbar-default">
  <div class="navbar-header">
    <button data-target=".navbar-collapse" data-toggle="collapse" class="navbar-toggle" type="button">
      <span class="sr-only">Toggle navigation</span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
    </button>
  </div>
  <div class="navbar-collapse collapse">
    <ul class="nav navbar-nav">
      <li><a href="/#about" class="smooth-scroll-to">About</a></li>
      <li><a href="/services">Our Work</a></li>
      <li><a href="/team">Team</a></li>
      <li><a href="/blog">Blog</a></li>
      <li><a href="/fit">Do We Fit?</a></li>
      <li><a href="/contact">Contact</a></li>
    </ul>
  </div>
</nav>

      </div>
    </div>
  </div>
</header>
<article id="post-page">
  <div class="container">
    <div class="row">
      <div id="post-title" class="col-sm-10 col-sm-offset-1">
        <h1><a href="/content/drupal-nodejs-pantheon-and-heroku/">Drupal, Node.js, Pantheon, and Heroku </a></h1>
        <div class="post-author">By Amitai Burstein</div>
      </div>
    </div>
    <div class="row">
      <div id="post-data" class="col-sm-2 col-sm-offset-1">
  			<div id="post-label">
  		 		<a href="/blog"><span class="label label-default">Gizra Blog</span></a>
  			</div>
        <div class="date">19 Dec 2012</div>
        <section class="author-details">
          <div class="image-wrapper">
            <img src="/images/team/avatars/amitaibu.a340.jpg" class="img-circle img-responsive">
          </div>
          <div class="text-wrapper">
            <span class="name">Amitai Burstein</span>
            
              <span class="twitter">(@amitaibu)</span>
            
            <div class="title">CTO, Co-Owner</div>
            <div class="bio">Maintainer of Organic groups, the Message stack, and co-maintainer of Drupal 8's Entity reference. <a href="/content/the-about-story/">The about story</a>.</div>
          </div>
        </section>
        <div class="tags">
          <div class="title">Tags:</div>
          
            <ul class="inline">
              
              

  
    
      <li><a href="/tags.html#Node.js-ref">Node.js</a></li>
    
      <li><a href="/tags.html#Pantheoen-ref">Pantheoen</a></li>
    
      <li><a href="/tags.html#tutorial-ref">tutorial</a></li>
    
      <li><a href="/tags.html#Drupal-planet-ref">Drupal-planet</a></li>
    
  


            </ul>
          
        </div>
      </div>
      <div id="post-content" class="col-sm-8">

        <p>Some title, right?</p>

<p><a href="http://drupal.org/project/nodejs">Node.js</a> module for Drupal is so great and a time saver, I’ve got spare time to blog about how to set it up. Future me, we’ll thank me for doing so.</p>

<p>First, let’s define the goals for this blog post</p>

<ul>
<li>Learn how to setup the Node.js module and server on a <em>local</em> server</li>
<li>Setup on  a remote server using Heroku and Pantheon</li>
</ul>

<!-- more -->

<h3>Install node</h3>

<p>Node.js module&rsquo;s README.txt explains how to do it. I’m using Mac so for me it was a simple <code>brew install node</code>.
Get the latest release of the Node.js module, and enable it.
Download the node libraries needed by executing <code>npm install</code> from the Node.js module directory. That command will look at <code>package.json</code> and install all the dependencies.
Ok, On to the interesting parts.</p>

<h3>Local Server</h3>

<p>Node.js module requires a simple configuration file that will tell it where the node.js server is running, and where the &ldquo;backend&rdquo; is (i.e. Drupal). Ignore the example in README.txt, eyes over here please.
Assuming my Drupal site is on http://localhost/d7_dev here’s <code>nodejs.config.js</code>:</p>
<div class="highlight"><pre><code class="javascript language-javascript" data-lang="javascript"><span class="nx">settings</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">scheme</span><span class="o">:</span> <span class="s1">&#39;http&#39;</span><span class="p">,</span>
  <span class="nx">port</span><span class="o">:</span> <span class="mi">5000</span><span class="p">,</span>
  <span class="nx">host</span><span class="o">:</span> <span class="s1">&#39;localhost&#39;</span><span class="p">,</span>
  <span class="nx">resource</span><span class="o">:</span> <span class="s1">&#39;/socket.io&#39;</span><span class="p">,</span>
  <span class="nx">serviceKey</span><span class="o">:</span> <span class="s1">&#39;beejeebusRocks&#39;</span><span class="p">,</span>
  <span class="nx">backend</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">port</span><span class="o">:</span> <span class="mi">80</span><span class="p">,</span>
    <span class="nx">host</span><span class="o">:</span> <span class="s1">&#39;localhost&#39;</span><span class="p">,</span>
    <span class="nx">scheme</span><span class="o">:</span> <span class="s1">&#39;http&#39;</span><span class="p">,</span>
    <span class="nx">basePath</span><span class="o">:</span> <span class="s1">&#39;/d7_dev&#39;</span><span class="p">,</span>
    <span class="nx">messagePath</span><span class="o">:</span> <span class="s1">&#39;/nodejs/message&#39;</span>
  <span class="p">},</span>
  <span class="nx">transports</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;polling&#39;</span><span class="p">,</span> <span class="s1">&#39;websocket&#39;</span><span class="p">],</span>
  <span class="nx">debug</span><span class="o">:</span> <span class="kc">true</span>
<span class="p">};</span>
</code></pre></div>
<p>The first part tells Node.js module where the node.js server will live. In the above example it will be <code>http://localhost:5000</code>. Same host different ports.</p>

<p>The &ldquo;backend&rdquo; part tells the node.js server where our Drupal site is.
The <code>serviceKey</code> is the secret code used by Drupal to communicate with the node.js server. In my example it’s also used as a special thank you for <strong>beejeebus</strong>, the module maintainer.
Next, from the command line execute <code>node server.js</code>. If you defined the URL and port correctly (pay extra attention to all those leading and trailing slashes!) you should see</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">Started http server.
   info  - socket.io started
</code></pre></div>
<p>Visit <code>http://localhost:5000/</code> and the (confusing) message “Not found” should greet you. Wait, What? Why “Not found”, if it’s working?!
The reason is that the node.js server is accepting only POST and any GET results with a 404.</p>

<p>Back to Drupal. In your <code>settings.php</code> add <code>$conf[&#39;nodejs_service_key&#39;] = &#39;beejeebusRocks&#39;;</code>, which is the Drupal equivalent for the serviceKey in the JS configuration.
Visit <code>admin/config/nodejs/config</code> and fill out the form, this time to let _Drupal know about the node.js server. Again, pay attention to leading and trailing slashes.</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">Node.js server host = localhost
port = 5000
</code></pre></div>
<h4>The Fun Part!</h4>

<ol>
<li>Enable &ldquo;Nodejs Notifications&rdquo; module</li>
<li>Open another browser in the background, and login as another user</li>
<li>Back as the administrator go to &ldquo;admin/config/nodejs/nodejs_notify/broadcast&rdquo; and broadcast your message</li>
<li>The message will appear using Growl in the second browser</li>
<li>Repeat 2 - 5 until you climax. Personally, It took me about 10 browsers open simultaneously to get there!</li>
</ol>

<h3>Deploy it!</h3>

<p>Ok, we had our fun on the local server time to see it in action, on a _real server.
This time let&rsquo;s start with the Drupal part. Probably the quickest way to get it up is to grab an account on <a href="https://www.getpantheon.com/">Pantheon</a> and create a Clean Drupal 7 installation (I did it two years ago, and haven&rsquo;t regretted since&hellip;)
Let&rsquo;s say my new site is called <code>dev.gizra.gotpantheon.com</code>
Add the module, and the service key in settings.php, yada yada yada. Indeed, we will still need to deal with the Node.js module configuration. Right after the Heroku section.</p>

<h4>The Heroku section</h4>

<p>Wow. Seriously. Those guys in Heroku made deployment of a node.js server really easy. After you sign up, and download the <a href="https://toolbelt.heroku.com">Heroku toolbelt</a> (a command line utility), you can read <a href="https://devcenter.heroku.com/articles/nodejs">this</a> quick introduction that will show you how easy it&rsquo;s to deploy from the command line. If you know how to use git, you&rsquo;ll know to use Heroku.</p>

<p>Git clone <a href="https://github.com/amitaibu/DrupalNodejsHeroku">amitaibu/DrupalNodejsHeroku</a> outside of the Drupal installation.
Quick file overview:
I&rsquo;ve Copied <code>server.js</code> from the Node.js module.
I&rsquo;ve changed a bit the <code>package.json</code> so Heroku will be able to build it.
I&rsquo;ve added a default <code>nodejs.config.js</code> you <strong>will need to edit</strong> and add your own <code>serviceKey</code> and <code>backend.host</code>. Here is how my file looked</p>
<div class="highlight"><pre><code class="javascript language-javascript" data-lang="javascript"><span class="nx">settings</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">scheme</span><span class="o">:</span> <span class="s1">&#39;http&#39;</span><span class="p">,</span>
  <span class="nx">port</span><span class="o">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PORT</span> <span class="o">||</span> <span class="mi">5000</span><span class="p">,</span>
  <span class="nx">host</span><span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
  <span class="nx">resource</span><span class="o">:</span> <span class="s1">&#39;/socket.io&#39;</span><span class="p">,</span>
  <span class="nx">serviceKey</span><span class="o">:</span> <span class="s1">&#39;beejeebusRocks&#39;</span><span class="p">,</span>
  <span class="nx">backend</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">host</span><span class="o">:</span> <span class="s1">&#39;dev.gizra.gotpantheon.com&#39;</span><span class="p">,</span>
    <span class="nx">port</span><span class="o">:</span> <span class="mi">80</span><span class="p">,</span>
    <span class="nx">scheme</span><span class="o">:</span> <span class="s1">&#39;http&#39;</span><span class="p">,</span>
    <span class="nx">messagePath</span><span class="o">:</span> <span class="s1">&#39;/nodejs/message&#39;</span>
  <span class="p">},</span>
  <span class="nx">transports</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;xhr-polling&#39;</span><span class="p">],</span>
  <span class="nx">debug</span><span class="o">:</span> <span class="kc">true</span>
<span class="p">};</span>
</code></pre></div>
<p>Notice several changes:
<ul>
<li>backend.host is now pointing to my own Pantheon site. Remember to change it</li>
<li>The port of the node.js server is now <code>process.env.PORT || 5000</code>. Heroku will make sure to inject that variable when executed, so our node.js server will listen on the right port</li>
<li>The transport mechanism is xhr-polling. Heroku still doesn&rsquo;t sup Websockets port, but bare in mind that it&rsquo;s the node.js server that gets the polling, _not the Drupal server</li>
</ul></p>

<p>Next, we can deploy it to Heroku.</p>
<div class="highlight"><pre><code class="bash language-bash" data-lang="bash"><span class="nv">$ </span>heroku create
<span class="nv">$ </span>git push heroku master
</code></pre></div>
<p>(I also added a .gitignore file that will ignore <code>node_modules</code> in case you will <code>npm install</code>).
Notice how not only the files are pushed to git, but Heroku now builds the dependencies and launches the server. In the end of the output you will see the URL of your new site. That&rsquo;s the node.js server URL, Drupal will POST data to. You can also open it with <code>heroku open</code></p>

<h4>Back to Drupal</h4>

<p>Visit <code>admin/config/nodejs/config</code> and fill out the form. <em>My</em> configuration looked like this:</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">Node.js server host = nameless-brook-555.herokuapp.com
port = 80
</code></pre></div>
<p>Enable the Node.js modules, and start enjoying the work of other great people!</p>


      </div>
    </div>
  </div>
</article>
<section id="post-nav">
  <div class="container">
    <div class="row">
      <div class="col-sm-3 col-sm-offset-3 col-xs-6 previous">
        
        <a href="/content/message-subscribe-new-subscription-system/">
          <div id="previous-label" class="text-small">
            <span class="hidden-xs"><i class="fa fa-chevron-circle-left"></i>&nbsp;Message-subscribe - A New Subscription System</span>
            <span class="visible-xs"><i class="fa fa-chevron-circle-left"></i>&nbsp;Previous post</span>
          </div>
        </a>
        
      </div>
      <div class="col-sm-3 col-sm-offset-2 col-xs-6 next">
        
        <a href="/content/migrate-and-baking-content/">
          <div id="next-label" class="text-small">
            <span class="hidden-xs">Migrate, and baking content&nbsp;<i class="fa fa-chevron-circle-right"></i></span>
            <span class="visible-xs">Next post&nbsp;<i class="fa fa-chevron-circle-right"></i></span>
          </div>
        </a>
        
      </div>
    </div>
  </div>
</section>
<section>
  <div class="container">
    <div class="row">
      <div class="col-sm-8 col-sm-offset-3">
        <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_developer = 1;
    var disqus_shortname = 'gizra';
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

      </div>
    </div>
  </div>
</section>
    


    <!--Footer -->
    
  <div id="contact">
    <footer id="footer" role="contentinfo">
      <div class="footer-wrapper">
        <div class="background">
          <div class="container">
            <div class="row">
              <div class="col-sm-12">
                <h2 class="title">Talk to us</h2>
                <div class="clearfix">
                  <address>
                    <div class="strong">Israel Headquarters</div>
                    <span>5 Brenner Street, Tel Aviv</span>
                      <a class="telephone" href="tel:+97233731222">+972-3-3731222</a>
                    <a class="email" href="mailto:info@gizra.com">info@gizra.com</a>
                  </address>
                  <address class="separator">
                    <div class="strong">North America Office</div>
                    <span>106 West 32nd Street, 2nd Floor, New York, NY 10001</span>
                    <a class="telephone" href="tel:+13476864508">212-634-1687</a>
                    <a class="email" href="mailto:usoffice@gizra.com">usoffice@gizra.com</a>
                  </address>
                  <div class="separator social-links">
                    <span class="link github">
                      <a href="https://github.com/Gizra" target="_blank"><i class="fa fa-github-square"></i><span class="link-text">Gizra's Github Account</span></a>
                    </span>
                    <span class="link twitter">
                      <a href="https://twitter.com/gizra_drupal" target="_blank"><i class="fa fa-twitter-square"></i><span class="link-text">Gizra's Twitter Account</span></a>
                    </span>
                    <span class="link linkedin">
                      <a href="https://www.linkedin.com/company/gizra-ltd" target="_blank"><i class="fa fa-linkedin-square"></i><span class="link-text">Gizra's LinkedIn Page</span></a>
                    </span>
                    <span class="link facebook">
                      <a href="https://www.facebook.com/gizraltd/timeline" target="_blank"><i class="fa fa-facebook-square"></i><span class="link-text">Gizra's Facebook Page</span></a>
                    </span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </footer>
  </div>



    <script src="/js/plugins.c9ea.js"></script>

    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery-backstretch/2.0.4/jquery.backstretch.min.js"></script>

    <script src="/js/scripts.f755.js"></script>
    </body>
</html>
