<!DOCTYPE html><html><head><title>Drupal 8: Migrate Nodes with Attachments Easily</title><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta property=og:site_name content=Gizra><meta property=og:title content="Drupal 8: Migrate Nodes with Attachments Easily"><meta name=description content="Gizra is a web strategy, design, and
  development agency with an extensive track record in complex content
  management solutions in Drupal and Elm."><meta property=og:description content=""><meta name=twitter:card content="summary_large_image"/><meta name=twitter:site content="@gizra_drupal"/><meta property=og:image content=https://www.gizra.com/assets/images/posts/drupal-8-migrate/thumb.jpg><link rel=apple-touch-icon sizes=180x180 href=/assets/favicons/apple-touch-icon-180x180.png><link rel=icon type=image/png href=/assets/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/assets/favicons/favicon-194x194.png sizes=194x194><link rel=icon type=image/png href=/assets/favicons/favicon-96x96.png sizes=96x96><link rel=icon type=image/png href=/assets/favicons/android-chrome-192x192.png sizes=192x192><link rel=icon type=image/png href=/assets/favicons/favicon-16x16.png sizes=16x16><link rel=manifest href=/assets/favicons/manifest.json><meta name=msapplication-TileColor content=#000000><meta name=msapplication-TileImage content=/assets/favicons/mstile-144x144.png><meta name=theme-color content=#ffffff><link href="https://fonts.googleapis.com/css?family=Abril+Fatface&text=gizra" rel=stylesheet><link href="https://fonts.googleapis.com/css?family=Esteban" rel=stylesheet><link href="https://fonts.googleapis.com/css?family=Open+Sans:400,700" rel=stylesheet><link href="https://fonts.googleapis.com/css?family=Montserrat:500,700" rel=stylesheet><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.2.7/semantic.min.css integrity="sha256-wT6CFc7EKRuf7uyVfi+MQNHUzojuHN2pSw0YWFt2K5E=" crossorigin="anonymous"/><link rel=stylesheet href="/assets/stylesheets/style.css"/><script src=https://code.jquery.com/jquery-2.2.4.min.js integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.2.7/semantic.min.js integrity="sha256-flVaeawsBV96vCHiLmXn03IRJym7+ZfcLVvUWONCas8=" crossorigin=anonymous></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-6558346-3', 'auto');
  ga('send', 'pageview');</script></head><body class=pushable><div class="ui sidebar inverted vertical menu left"><a class="item active" href="/">Home</a> <a class=item href=/team>Team</a> <a class=item href=/blog>Blog</a> <a class=item href=/podcast>Podcast</a> <a class=item href=/projects>Projects</a> <a class=item href=/our-story>Our Story</a> <a class=item href=/contact>Contact</a></div><div class=pusher><div class="ui grid container"><header class=row><div class="five wide column menu bar"><div class="ui large secondary menu"><a class="item sidebar-toggle"><i class="big sidebar icon"></i> Menu</a></div></div><div class="six wide computer six wide tablet eleven wide mobile column center aligned"><a class=gizra-logo href="/"><svg xmlns=http://www.w3.org/2000/svg width=252 height=104><title>gizra</title><path fill=#E27058 fill-rule=evenodd d="M44.3 21.6c.2 3.5 3 5.4 6 5.4 3.5 0 6.7-2 6.7-7s-3.6-7.7-8.5-7.7c-4.3 0-10.3 2.5-10.3 11 0 1.7.2 3.4.6 5.3-3.4-2-6.5-2.6-11.6-2.6-16 0-22.7 7.6-22.7 17.5 0 8.7 4 13.7 12.2 16-8.2 5-12 7.8-12 13.8C4.7 78 8 83 20.7 83h10c11 0 13.4 2 13.4 7 0 6.7-5.8 11.3-17 11.3s-13.4-4.7-13.4-9c0-1.8.2-3.5 1-5.8l-6.4-3C4.5 84.8.2 87 .2 92c0 6.8 7.5 11.3 25.8 11.3 21.2 0 29.6-8.5 29.6-20 0-14.4-12-17.2-23.8-17.2H21c-5.5 0-6.6-.4-6.6-1.4 0-1 1-2 4.6-4.4 2.2.4 5.4.8 8.5.8C40.3 61 49 55 49 43c0-6.8-4-10.5-8-13.3-.6-2.5-.8-4.6-.8-6.3 0-6.5 3-7 4.5-7 2.2 0 2.8 1.7 2.5 3.4l-3 1.8zM22 41.2C22 29.7 24 28 27 28s4.6 1.4 4.6 13.2v5c0 11-1.8 12.7-4.6 12.7-3.2 0-5-2.3-5-12V41zM62 10c0 4.4 2 9.8 10.6 9.8 7.6 0 10.6-4.3 10.6-10 0-6.3-3.8-9.6-10.4-9.6C65 .2 62 5 62 10zm-5.4 17v2h6.2v46H57v2h31.2v-2h-6V27H56.7zm82.5 0H95l-1.4 20.2H95c4.3-15 8-18.3 22.2-18.3h1L93 75.3V77h44l1.8-21.5h-1.5C133.5 69 127.5 75 115.6 75h-1.4l25-46v-2zm41 3c2.2 0 4.3 1 2.2 5.3h-3.8c-2.2 7.5 1 12 8.2 12 5.6 0 8.8-4 8.8-10 0-8-5-11.3-11.2-11.3-6.3 0-12 3.6-14 11V27H145v2h5.7v46h-5.8v2h32.6v-2h-7.4V47c0-9.5 4.7-17 9.7-17zm40.5 22.3c-15 0-24.2 2.4-24.2 13 0 10.5 8.2 12.8 15.6 12.8 7.2 0 10.3-2.7 12-7.7 1.2 5 6 7.8 14.4 7.8 9 0 13-3.5 13.5-16l-1.7-.2c-.5 8.8-2.3 10.8-4.2 10.8-1.7 0-3-1.2-3-5.5V46c0-15.2-5.5-19.8-22-19.8-14.3 0-22 4-22 13 0 5 2.6 8.6 9 8.6 5.3 0 9.3-3.3 9.3-8.2 0-2-.3-3.4-.8-4.7H214c-.6-1.2-.8-2.2-.8-3 0-3.4 3-4.3 5-4.3 4.2 0 5.3 3.5 5.3 16.8v8h-3zM219 73.8c-2 0-2.7-1-2.7-8.6v-1.6c0-6.4 2-9.6 6.5-9.6h.7v9.8c0 6.7-2.5 10-4.5 10z"/></svg></a><div class=tagline>We Build Websites</div></div><div class="five wide computer only column"></div></header><div class="ui grid centered post"><div class="sixteen wide mobile sixteen wide tablet twelve wide computer column"><div class="ui raised padded segment"><h1 class="ui dividing header"><div class="ui image"><img src=/assets/images/team/avatars/RoySegall.jpg class="ui circular image"></div><div class=content><a href="/content/drupal-8-attachment-migration/">Drupal 8: Migrate Nodes with Attachments Easily</a><div class="sub header">By Roy Segall // 08 Jun 2016</div></div><div class="right floated column"><a href=/blog class="ui teal right ribbon big label">Blog Post</a></div></h1><p>Drupal-8-manina is at its highest. Modules are being ported, blog posts are being written, and new sites are being coded, so we in Gizra decided to join the party.</p><p>We started with a simple site that will replace an existing static site. But we needed to migrate node attachments, and we just couldn’t find an existing solution. Well, it was time to reach out to the community</p><blockquote class=twitter-tweet data-lang=en><p lang=en dir=ltr>Any example of <a href="https://twitter.com/hashtag/Drupal?src=hash">#Drupal</a> 8 migration of files/ images out there? (including copy from source into public:// )</p>&mdash; Amitai Burstein (@amitaibu) <a href=https://twitter.com/amitaibu/status/718441947325677569>April 8, 2016</a></blockquote><script async src=//platform.twitter.com/widgets.js charset=utf-8></script><p>A few minutes after the tweet was published, we received a great hint from the fine folks at <a href="https://evolvingweb.ca/">Evoloving Web</a>. They were already migrating files into Drupal 8 from Drupal 7, and were kind enough to <a href=https://evolvingweb.ca/blog/bringing-files-along-for-ride-to-d8>blog post</a> about it.</p><p>However, we were still missing another piece of the puzzle, as we also wanted to migrate files from an outside directory directly into Drupal. I gave my good friend <a href=https://twitter.com/jsacksick>@jsacksick</a> a poke (it’s easy, as he sits right in front of me), and he gave me the answer on a silver platter.</p><div class="ui segments"><div class="ui attached center aligned segment"><div class="ui image"><img src="https://www.gizra.com/assets/images/posts/drupal-8-migrate/image1.jpg"/></div></div><div class="ui attached center aligned caption segment">Post has a happy end - we were able to migrate files and attach to a node!</div></div><h2 id=an-example-for-super-heroes>An example for super heroes</h2><p>For this blog post I created a dummy Drupal 8 <a href=https://github.com/RoySegall/comics_migration>installation profile</a> with way too much information about super heroes. The migration module can migrate <a href=https://github.com/RoySegall/comics_migration/tree/master/web/modules/custom/comics_migration/migration_assets/images>some images</a> along with some <a href=https://github.com/RoySegall/comics_migration/blob/master/web/modules/custom/comics_migration/migration_assets/heroes.csv>CSV data</a> about them.</p><p>If you’ll look closely you can see that I’ve attached an SQL dump with raw tables. This raw table will be the source that eventually will migrated into nodes, and you can read <a href="/content/migration-best-practices/">here</a> how it was created with <a href=https://www.drupal.org/project/csv2sql>csv2sql</a>.</p><h2 id=basic-structure-of-migration>Basic structure of migration</h2><p>The description of the mapping between the source table and the destination node type is in a <a href=https://github.com/RoySegall/comics_migration/blob/master/web/modules/custom/comics_migration/config/install/migrate.migration.superheroes.yml>yaml file</a>.</p><p>Let’s go over the interesting parts of the <code class=highlighter-rouge>process</code>:</p><div class="language-yaml highlighter-rouge"><div class=highlight><pre class=highlight><code><span class=na>process</span><span class=pi>:</span>
  <span class=na>type</span><span class=pi>:</span>
    <span class=na>plugin</span><span class=pi>:</span> <span class=s>default_value</span>
    <span class=na>default_value</span><span class=pi>:</span> <span class=s>super_heroes</span>
  <span class=na>uid</span><span class=pi>:</span>
    <span class=na>plugin</span><span class=pi>:</span> <span class=s>default_value</span>
    <span class=na>default_value</span><span class=pi>:</span> <span class=s>1</span>
  <span class=na>title</span><span class=pi>:</span> <span class=s>_title</span>
  <span class=na>field_image</span><span class=pi>:</span>
    <span class=na>source</span><span class=pi>:</span> <span class=s>_image</span>
    <span class=na>plugin</span><span class=pi>:</span> <span class=s>file_import</span>
  <span class=na>field_alter_ego</span><span class=pi>:</span> <span class=s>_alter_ego</span>
  <span class=s1>'</span><span class=s>body/value'</span><span class=pi>:</span> <span class=s>_description</span>
</code></pre></div></div><p>In Drupal 7, because we wanted to prepare the value before populating the entity fields, we did it in a <a href=https://github.com/openscholar/openscholar/blob/SCHOLAR-3.x/openscholar/modules/os/modules/os_migrate_demo/handlers/node/project.inc#L33-L38>prepare method</a>. In Drupal 8 we have <a href=https://github.com/RoySegall/comics_migration/blob/master/web/modules/custom/comics_migration/src/Plugin/migrate/process/FileImport.php>process plugins</a>.</p><p>For example, the <code class=highlighter-rouge>default_value</code> plugin will populate the (configurable) field of the entity with a raw value like the name of a content type or a user ID, in case we are migrating all the nodes with the same author (e.g. user ID 1).</p><p>But we can, of course, have our own logic. In the <a href=https://github.com/RoySegall/comics_migration/blob/master/web/modules/custom/comics_migration/src/Plugin/migrate/process/FileImport.php#L21>transform</a> method of the process plugin we can massage our data and return any value which will eventually populate the field.</p><p>In our case, the <code class=highlighter-rouge>transform</code> method is responsible for adding the new file into Drupal using <code class=highlighter-rouge>file_unmanaged_copy</code> and friends.</p><h2 id=conclusion>Conclusion</h2><p>Some of the know hows and best practices are still missing from Drupal 8. But they can and should be re-learned and re-published. So remember kids, if you ever feel frustrated about not finding a solution, always reach out to smart community members and then write a post about it, so everybody can profit.</p></div></div><div class="twelve wide column computer only"><div class="ui borderless secondary menu"><a class=item href="/content/gizra-way-webinar-budget-goggles/"><i class="chevron left icon"></i> The Gizra Way Webinar: Budget Goggles and the Time-Boxed Project</a><div class="right menu"><a class=item href="/content/og-message-stack-drupal8/">Organic Groups and Message Stack in Drupal 8 <i class="chevron right icon"></i></a></div></div></div><div class="twelve wide column"><div class="ui segment basic"><div id=disqus_thread></div><script type=text/javascript>var disqus_shortname = 'gizra';
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();</script><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div></div></div></div><footer class="ui black inverted vertical footer segment padded"><div class="ui center aligned container"><div class="ui three column stackable inverted grid"><div class=column><address><div class=strong>Israel Headquarters</div><div>5 Brenner Street, Tel Aviv</div><a class=telephone href=tel:+97233731222>+972-3-3731222</a> // <a class=email href=mailto:info@gizra.com>info@gizra.com</a></address></div><div class="column icons"><a target=_blank href=https://twitter.com/gizra_drupal><i class="twitter huge icon"></i></a> <a target=_blank href=https://github.com/Gizra/gizra.com><i class="github huge icon"></i></a></div><div class=column><address><div class=strong>North America Office</div><div>350 N. Orleans Street, Suite 9000N, Chicago, IL 60654</div><a class=telephone href=tel:+13125857625>312-585-7625</a> // <a class=email href=mailto:usoffice@gizra.com>usoffice@gizra.com</a></address></div></div></div></footer></div><script src=/bower_components/anchor-js/anchor.min.js></script><script src=/assets/javascript/script.js></script></body></html>