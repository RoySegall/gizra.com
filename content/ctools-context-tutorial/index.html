<!DOCTYPE html><html><head><title>CTools context tutorial</title><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta property=og:site_name content=Gizra><meta property=og:title content="CTools context tutorial"><link rel=apple-touch-icon sizes=180x180 href=/assets/favicons/apple-touch-icon-180x180.png><link rel=icon type=image/png href=/assets/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/assets/favicons/favicon-194x194.png sizes=194x194><link rel=icon type=image/png href=/assets/favicons/favicon-96x96.png sizes=96x96><link rel=icon type=image/png href=/assets/favicons/android-chrome-192x192.png sizes=192x192><link rel=icon type=image/png href=/assets/favicons/favicon-16x16.png sizes=16x16><link rel=manifest href=/assets/favicons/manifest.json><meta name=msapplication-TileColor content=#000000><meta name=msapplication-TileImage content=/assets/favicons/mstile-144x144.png><meta name=theme-color content=#ffffff><link href="https://fonts.googleapis.com/css?family=Abril+Fatface&text=gizra" rel=stylesheet><link href="https://fonts.googleapis.com/css?family=Esteban" rel=stylesheet><link href="https://fonts.googleapis.com/css?family=Montserrat:500,700" rel=stylesheet><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.2.7/semantic.min.css integrity="sha256-wT6CFc7EKRuf7uyVfi+MQNHUzojuHN2pSw0YWFt2K5E=" crossorigin="anonymous"/><link rel=stylesheet href="/assets/stylesheets/style.css"/><script src=https://code.jquery.com/jquery-2.2.4.min.js integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.2.7/semantic.min.js integrity="sha256-flVaeawsBV96vCHiLmXn03IRJym7+ZfcLVvUWONCas8=" crossorigin=anonymous></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-6558346-3', 'auto');
  ga('send', 'pageview');</script></head><body class=pushable><div class="ui sidebar inverted vertical menu left"><a class="item active" href="/">Home</a> <a class=item href=/team>Team</a> <a class=item href=/blog>Blog</a> <a class=item href=/projects>Projects</a> <a class=item href=/our-story>Our Story</a> <a class=item href=/contact>Contact</a></div><div class=pusher><div class="ui grid container"><header class=row><div class="five wide column menu bar"><div class="ui large secondary menu"><a class="item sidebar-toggle"><i class="big sidebar icon"></i> Menu</a></div></div><div class="six wide computer six wide tablet eleven wide mobile column center aligned"><a class=gizra-logo href="/"><svg xmlns=http://www.w3.org/2000/svg width=252 height=104><title>gizra</title><path fill=#E27058 fill-rule=evenodd d="M44.3 21.6c.2 3.5 3 5.4 6 5.4 3.5 0 6.7-2 6.7-7s-3.6-7.7-8.5-7.7c-4.3 0-10.3 2.5-10.3 11 0 1.7.2 3.4.6 5.3-3.4-2-6.5-2.6-11.6-2.6-16 0-22.7 7.6-22.7 17.5 0 8.7 4 13.7 12.2 16-8.2 5-12 7.8-12 13.8C4.7 78 8 83 20.7 83h10c11 0 13.4 2 13.4 7 0 6.7-5.8 11.3-17 11.3s-13.4-4.7-13.4-9c0-1.8.2-3.5 1-5.8l-6.4-3C4.5 84.8.2 87 .2 92c0 6.8 7.5 11.3 25.8 11.3 21.2 0 29.6-8.5 29.6-20 0-14.4-12-17.2-23.8-17.2H21c-5.5 0-6.6-.4-6.6-1.4 0-1 1-2 4.6-4.4 2.2.4 5.4.8 8.5.8C40.3 61 49 55 49 43c0-6.8-4-10.5-8-13.3-.6-2.5-.8-4.6-.8-6.3 0-6.5 3-7 4.5-7 2.2 0 2.8 1.7 2.5 3.4l-3 1.8zM22 41.2C22 29.7 24 28 27 28s4.6 1.4 4.6 13.2v5c0 11-1.8 12.7-4.6 12.7-3.2 0-5-2.3-5-12V41zM62 10c0 4.4 2 9.8 10.6 9.8 7.6 0 10.6-4.3 10.6-10 0-6.3-3.8-9.6-10.4-9.6C65 .2 62 5 62 10zm-5.4 17v2h6.2v46H57v2h31.2v-2h-6V27H56.7zm82.5 0H95l-1.4 20.2H95c4.3-15 8-18.3 22.2-18.3h1L93 75.3V77h44l1.8-21.5h-1.5C133.5 69 127.5 75 115.6 75h-1.4l25-46v-2zm41 3c2.2 0 4.3 1 2.2 5.3h-3.8c-2.2 7.5 1 12 8.2 12 5.6 0 8.8-4 8.8-10 0-8-5-11.3-11.2-11.3-6.3 0-12 3.6-14 11V27H145v2h5.7v46h-5.8v2h32.6v-2h-7.4V47c0-9.5 4.7-17 9.7-17zm40.5 22.3c-15 0-24.2 2.4-24.2 13 0 10.5 8.2 12.8 15.6 12.8 7.2 0 10.3-2.7 12-7.7 1.2 5 6 7.8 14.4 7.8 9 0 13-3.5 13.5-16l-1.7-.2c-.5 8.8-2.3 10.8-4.2 10.8-1.7 0-3-1.2-3-5.5V46c0-15.2-5.5-19.8-22-19.8-14.3 0-22 4-22 13 0 5 2.6 8.6 9 8.6 5.3 0 9.3-3.3 9.3-8.2 0-2-.3-3.4-.8-4.7H214c-.6-1.2-.8-2.2-.8-3 0-3.4 3-4.3 5-4.3 4.2 0 5.3 3.5 5.3 16.8v8h-3zM219 73.8c-2 0-2.7-1-2.7-8.6v-1.6c0-6.4 2-9.6 6.5-9.6h.7v9.8c0 6.7-2.5 10-4.5 10z"/></svg></a><div class=tagline>We Build Websites</div></div><div class="five wide computer only column"></div></header><div class="ui grid centered post"><div class="sixteen wide mobile sixteen wide tablet twelve wide computer column"><div class="ui raised padded segment"><h1 class="ui dividing header"><div class="ui image"><img src=/assets/images/team/avatars/amitaibu.jpg class="ui circular image"></div><div class=content><a href="/content/ctools-context-tutorial/">CTools context tutorial</a><div class="sub header">By Amitai Burstein (@amitaibu) // 11 May 2011</div></div><div class="right floated column"><a href=/blog class="ui teal right ribbon big label">Blog Post</a></div></h1><p>Why should you use panels node-preview-example module? You shouldn’t, it’s just an example ;)</p><p>This post covers how to build a CTools content-type plugin that has context. CTools “Context” should not be mistaken with the context module. Context is CTools way of saying, my plugin (read, block) shouldn’t be dumb. If it requires a node or a user to extract data from, then it should let others know about it. “Others” in our case is Page manager module. It will load the context for the plugins and hand it over. In fact, if the context is not present it will not even bother loading the plugin.</p><p>I have created an example module called node-preview-example, that you can simply download and enable, create an Article page, and see how Panels is now showing the body field on the left and on the right a (silly) “Summary” of the node – this is our plugin.</p><div class=highlighter-rouge><pre class=highlight><code>drush dl ctools panels features
drush en ctools page_manager panels features
</code></pre></div><p>And the example module is in my <a href=http://drupal.org/sandbox/noam.hrz/1148086>sandbox</a>:</p><div class=highlighter-rouge><pre class=highlight><code>git clone http://git.drupal.org/sandbox/noam.hrz/1148086.git node_preview_example
</code></pre></div><p>Let’s go over the important parts in the code.</p><div class="language-php highlighter-rouge"><pre class=highlight><code><span class=cp>&lt;?php</span>

<span class=sd>/**
 * Plugin definition.
 */</span>
<span class=nv>$plugin</span> <span class=o>=</span> <span class=k>array</span><span class=p>(</span>
  <span class=o>...</span>

  <span class=s1>'required context'</span> <span class=o>=&gt;</span> <span class=k>array</span><span class=p>(</span>
    <span class=k>new</span> <span class=nx>ctools_context_required</span><span class=p>(</span><span class=nx>t</span><span class=p>(</span><span class=s1>'User'</span><span class=p>),</span> <span class=s1>'user'</span><span class=p>),</span>
    <span class=k>new</span> <span class=nx>ctools_context_required</span><span class=p>(</span><span class=nx>t</span><span class=p>(</span><span class=s1>'Node'</span><span class=p>),</span> <span class=s1>'node'</span><span class=p>),</span>
  <span class=p>),</span>
  <span class=o>...</span>
<span class=p>);</span>
<span class=cp>?&gt;</span>
</code></pre></div><p>The plugin definition is where we let the system know we need a user object and a node object to operate on.</p><p>Next the render callback can use those context, after making sure they are valid.</p><div class="language-php highlighter-rouge"><pre class=highlight><code><span class=cp>&lt;?php</span>
<span class=sd>/**
 * Render callback.
 */</span>
<span class=k>function</span> <span class=nf>node_preview_example_summary_content_type_render</span><span class=p>(</span><span class=nv>$subtype</span><span class=p>,</span> <span class=nv>$conf</span><span class=p>,</span> <span class=nv>$args</span><span class=p>,</span> <span class=nv>$context</span><span class=p>)</span> <span class=p>{</span>
  <span class=c1>// Seperating the context to two different variables
</span>  <span class=k>list</span><span class=p>(</span><span class=nv>$user_context</span><span class=p>,</span> <span class=nv>$node_context</span><span class=p>)</span> <span class=o>=</span> <span class=nv>$context</span><span class=p>;</span>

  <span class=c1>// Make sure that context variable arent empty.
</span>  <span class=k>if</span> <span class=p>(</span><span class=k>empty</span><span class=p>(</span><span class=nv>$user_context</span><span class=p>)</span> <span class=o>||</span> <span class=k>empty</span><span class=p>(</span><span class=nv>$user_context</span><span class=o>-&gt;</span><span class=na>data</span><span class=p>))</span> <span class=p>{</span>
    <span class=k>return</span><span class=p>;</span>
  <span class=p>}</span>

  <span class=k>if</span> <span class=p>(</span><span class=k>empty</span><span class=p>(</span><span class=nv>$node_context</span><span class=p>)</span> <span class=o>||</span> <span class=k>empty</span><span class=p>(</span><span class=nv>$node_context</span><span class=o>-&gt;</span><span class=na>data</span><span class=p>))</span> <span class=p>{</span>
    <span class=k>return</span><span class=p>;</span>
  <span class=p>}</span>

  <span class=c1>// Above we made sure we got the context.
</span>  <span class=nv>$node</span> <span class=o>=</span> <span class=nv>$node_context</span><span class=o>-&gt;</span><span class=na>data</span><span class=p>;</span>

  <span class=o>...</span>
<span class=p>}</span>
<span class=cp>?&gt;</span>
</code></pre></div><p>As you can see, it didn’t take much to get the context working, but it gives a lot of power:</p><ul><li>Plugins without satisfied context will not appear in the plugins list, so a user can't add them by mistake</li><li>There is one single way for plugins to get a context, unlike "dumb" blocks that each one needs to find out where they are (e.g. ``menu_get_item()`` over and over again).</li></ul><p>If you listen to talks about Butler module, and having a plugin and context system in D8 - it will probably very similar or at least learn a lot from CTools plugins and context system, so you know you are on the right path.</p></div></div><div class="twelve wide column computer only"><div class="ui borderless secondary menu"><a class=item href="/content/data-migration-part-2/"><i class="chevron left icon"></i> Data Migration - part 2</a><div class="right menu"><a class=item href="/content/og-7x-11-rc2-out/">OG 7.x-1.1-RC2 is out! <i class="chevron right icon"></i></a></div></div></div><div class="twelve wide column"><div class="ui segment basic"><div id=disqus_thread></div><script type=text/javascript>var disqus_shortname = 'gizra';
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();</script><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div></div></div></div><footer class="ui black inverted vertical footer segment padded"><div class="ui center aligned container"><div class="ui three column stackable inverted grid"><div class=column><address><div class=strong>Israel Headquarters</div><div>5 Brenner Street, Tel Aviv</div><a class=telephone href=tel:+97233731222>+972-3-3731222</a> // <a class=email href=mailto:info@gizra.com>info@gizra.com</a></address></div><div class="column icons"><a target=_blank href=https://twitter.com/gizra_drupal><i class="twitter huge icon"></i></a> <a target=_blank href=https://github.com/Gizra/gizra.com><i class="github huge icon"></i></a></div><div class=column><address><div class=strong>North America Office</div><div>350 N. Orleans Street, Suite 9000N, Chicago, IL 60647</div><a class=telephone href=tel:+13125857625>312-585-7625</a> // <a class=email href=mailto:usoffice@gizra.com>usoffice@gizra.com</a></address></div></div></div></footer></div><script src=/bower_components/anchor-js/anchor.min.js></script><script src=/assets/javascript/script.js></script></body></html>