<!DOCTYPE html><html><head><title>Migration Best Practices</title><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta property=og:site_name content=Gizra><meta property=og:title content="Migration Best Practices"><meta property=og:image content=https://www.gizra.com/assets/images/posts/migration-best-practices/thumb.jpg><link rel=apple-touch-icon sizes=180x180 href=/assets/favicons/apple-touch-icon-180x180.png><link rel=icon type=image/png href=/assets/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/assets/favicons/favicon-194x194.png sizes=194x194><link rel=icon type=image/png href=/assets/favicons/favicon-96x96.png sizes=96x96><link rel=icon type=image/png href=/assets/favicons/android-chrome-192x192.png sizes=192x192><link rel=icon type=image/png href=/assets/favicons/favicon-16x16.png sizes=16x16><link rel=manifest href=/assets/favicons/manifest.json><meta name=msapplication-TileColor content=#000000><meta name=msapplication-TileImage content=/assets/favicons/mstile-144x144.png><meta name=theme-color content=#ffffff><link href="https://fonts.googleapis.com/css?family=Abril+Fatface&text=gizra" rel=stylesheet><link href="https://fonts.googleapis.com/css?family=Esteban" rel=stylesheet><link href="https://fonts.googleapis.com/css?family=Montserrat:500,700" rel=stylesheet><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.2.7/semantic.min.css integrity="sha256-wT6CFc7EKRuf7uyVfi+MQNHUzojuHN2pSw0YWFt2K5E=" crossorigin="anonymous"/><link rel=stylesheet href="/assets/stylesheets/style.css"/><script src=https://code.jquery.com/jquery-2.2.4.min.js integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.2.7/semantic.min.js integrity="sha256-flVaeawsBV96vCHiLmXn03IRJym7+ZfcLVvUWONCas8=" crossorigin=anonymous></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-6558346-3', 'auto');
  ga('send', 'pageview');</script></head><body class=pushable><div class="ui sidebar inverted vertical menu left"><a class="item active" href="/">Home</a> <a class=item href=/team>Team</a> <a class=item href=/blog>Blog</a> <a class=item href=/projects>Projects</a> <a class=item href=/our-story>Our Story</a> <a class=item href=/contact>Contact</a></div><div class=pusher><div class="ui grid container"><header class=row><div class="five wide column menu bar"><div class="ui large secondary menu"><a class="item sidebar-toggle"><i class="big sidebar icon"></i> Menu</a></div></div><div class="six wide computer six wide tablet eleven wide mobile column center aligned"><a class=gizra-logo href="/"><svg xmlns=http://www.w3.org/2000/svg width=252 height=104><title>gizra</title><path fill=#E27058 fill-rule=evenodd d="M44.3 21.6c.2 3.5 3 5.4 6 5.4 3.5 0 6.7-2 6.7-7s-3.6-7.7-8.5-7.7c-4.3 0-10.3 2.5-10.3 11 0 1.7.2 3.4.6 5.3-3.4-2-6.5-2.6-11.6-2.6-16 0-22.7 7.6-22.7 17.5 0 8.7 4 13.7 12.2 16-8.2 5-12 7.8-12 13.8C4.7 78 8 83 20.7 83h10c11 0 13.4 2 13.4 7 0 6.7-5.8 11.3-17 11.3s-13.4-4.7-13.4-9c0-1.8.2-3.5 1-5.8l-6.4-3C4.5 84.8.2 87 .2 92c0 6.8 7.5 11.3 25.8 11.3 21.2 0 29.6-8.5 29.6-20 0-14.4-12-17.2-23.8-17.2H21c-5.5 0-6.6-.4-6.6-1.4 0-1 1-2 4.6-4.4 2.2.4 5.4.8 8.5.8C40.3 61 49 55 49 43c0-6.8-4-10.5-8-13.3-.6-2.5-.8-4.6-.8-6.3 0-6.5 3-7 4.5-7 2.2 0 2.8 1.7 2.5 3.4l-3 1.8zM22 41.2C22 29.7 24 28 27 28s4.6 1.4 4.6 13.2v5c0 11-1.8 12.7-4.6 12.7-3.2 0-5-2.3-5-12V41zM62 10c0 4.4 2 9.8 10.6 9.8 7.6 0 10.6-4.3 10.6-10 0-6.3-3.8-9.6-10.4-9.6C65 .2 62 5 62 10zm-5.4 17v2h6.2v46H57v2h31.2v-2h-6V27H56.7zm82.5 0H95l-1.4 20.2H95c4.3-15 8-18.3 22.2-18.3h1L93 75.3V77h44l1.8-21.5h-1.5C133.5 69 127.5 75 115.6 75h-1.4l25-46v-2zm41 3c2.2 0 4.3 1 2.2 5.3h-3.8c-2.2 7.5 1 12 8.2 12 5.6 0 8.8-4 8.8-10 0-8-5-11.3-11.2-11.3-6.3 0-12 3.6-14 11V27H145v2h5.7v46h-5.8v2h32.6v-2h-7.4V47c0-9.5 4.7-17 9.7-17zm40.5 22.3c-15 0-24.2 2.4-24.2 13 0 10.5 8.2 12.8 15.6 12.8 7.2 0 10.3-2.7 12-7.7 1.2 5 6 7.8 14.4 7.8 9 0 13-3.5 13.5-16l-1.7-.2c-.5 8.8-2.3 10.8-4.2 10.8-1.7 0-3-1.2-3-5.5V46c0-15.2-5.5-19.8-22-19.8-14.3 0-22 4-22 13 0 5 2.6 8.6 9 8.6 5.3 0 9.3-3.3 9.3-8.2 0-2-.3-3.4-.8-4.7H214c-.6-1.2-.8-2.2-.8-3 0-3.4 3-4.3 5-4.3 4.2 0 5.3 3.5 5.3 16.8v8h-3zM219 73.8c-2 0-2.7-1-2.7-8.6v-1.6c0-6.4 2-9.6 6.5-9.6h.7v9.8c0 6.7-2.5 10-4.5 10z"/></svg></a><div class=tagline>We Build Websites</div></div><div class="five wide computer only column"></div></header><div class="ui grid centered post"><div class="sixteen wide mobile sixteen wide tablet twelve wide computer column"><div class="ui raised padded segment"><h1 class="ui dividing header"><div class="ui image"><img src=/assets/images/team/avatars/HelenaEksler.jpg class="ui circular image"></div><div class=content><a href="/content/migration-best-practices/">Migration Best Practices</a><div class="sub header">By Helena Eksler // 01 Apr 2016</div></div><div class="right floated column"><a href=/blog class="ui teal right ribbon big label">Blog Post</a></div></h1><p>The wonderful Migrate module is used in every one of our projects, whether we have actual legacy content, or “just” want to create dummy and <a href="https://www.gizra.com/content/xss-attack/">XSS content</a>.</p><p>So you received from your client a scary looking SQL dump or Excel file with old website data. Where should you start?</p><p>Here are some of the best practices we apply in Gizra to ensure a smooth migration project, with the least possible amount of surprises or bugs.</p><h2 id=discovery-phase>Discovery phase</h2><p>A good discovery phase before doing any actual coding is key to the success of the project. We believe it’s a good idea to do it as part of the <a href="https://www.gizra.com/content/budget-goggles/">price estimation</a>.</p><h3 id=understand-the-data>Understand the data</h3><p>The first step is to understand how to map the old data into Drupal’s entities - which data should be a node and which one a taxonomy term.<br/>As always, we try to map the “real world” into Drupal entities. An article, for example, is obviously a piece of content, so it needs to be a node, and not a taxonomy term. However there are more aspects to consider like the number of fields, semantic meaning of the content, and whether hierarchy is needed or not. It’s also worth noting that this is the exact time to think about improvements to the data structure.</p><p>There are some cases where content types were separate in the old website for historical reasons that can be merged and vice versa. Our rule of thumb is that the content type should try to map as much as possible the reality. That is, a “case study” content type might have very similar fields to an “article” content type but semantically they are different, thus they should be two different content types.</p><p>After you decide what fields your content type will have, pay careful attention to the data itself. If an article “topic” is a set of values that are constantly repeating, then naturally you would prefer to convert the field to a select list or even to a proper taxonomy term. Notice variants in the same data (“Politics” vs “politics”) and make the extra effort to sanitize and clean the data.</p><h3 id=dont-migrate-what-you-dont-need>Don’t migrate what you don’t need</h3><p>Not all of the existing data really needs to be migrated. For example, past events may not add much or any value to the new site. It’s up to you to present to the client the possibility to save some money on a low impact migrate and shift resources to something more important.</p><h3 id=dont-go-fully-automatic-for-nothing>Don’t go fully automatic for nothing</h3><p>Doing manual migration is fine. As part of the discovery phase figure out how many items per content type need to be migrated. If it is less than 50 offer the client to do it manually. Yes, you may “lose” some billable hours, but you gained the client’s trust.</p><h2 id=development-phase>Development phase</h2><h3 id=convert-to-sql>Convert to SQL</h3><p>If you received your data in csv format it is advised to convert it to SQL. Your migrate may work fine with a few hundreds lines, but it will choke if you have more - there’s no primary key column in CSV, so it basically loops over the same rows again and again.</p><p>SQL also provides another layer of safety, since it won’t accept wrong data. For example strings cannot be inserted into <code class=highlighter-rouge>Int</code> columns, so if you get an SQL error, you can easily find where the data is corrupted.</p><p>We got you covered with our <a href=https://github.com/Gizra/csv2sql#csv-to-sql-for-drupal>csv2sql</a>.</p><h2 id=content-during-development>Content during development</h2><p>While you are developing the platform and constantly rebuilding the site from scratch, of course you don’t want to wait hours for the import of all the data. You can add some dummy data, but a better approach would be to take about 50 rows from each table/content type. However, don’t take 50 consecutive rows, but rather take random rows to increase the chances of hitting data corruption or just plain bugs in development instead of in production.</p><h2 id=migrations-testing>Migrations testing</h2><p>Automatic tests are great, right?<br/>They catch bugs, and make you feel more confident about your code base, right?</p><p>So write automatic tests for your migration scripts, and wire them to Travis CI!</p><p>It’s obvious that when you have a huge amount of content you can’t check every single piece of content. But even little of coverage is better than none.</p><p>Start writing tests during the development against smaller subset of content (e.g. those 50 rows mentioned earlier). There is no need to create complicated scenarios for migration of content testing, you should simply check that the fields contain the correct data (texts, images), and that references are set correctly.</p><p>The crucial part in the tests requires your QA person to <em>visually</em> compare the old data with the new data. Once this is done, your automatic tests make sure there is no regression.</p><p>And please, don’t think writing those tests is a waste of time. On the contrary, it <em>saves</em> you so much effort chasing horrible regressions. Here’s an example of a <a href="https://www.gizra.com/content/behat-the-right-way/">properly written</a> Behat test.</p><div class="language-gherkin highlighter-rouge"><pre class=highlight><code><span class=nt>@api</span>
  <span class=kn>Scenario Outline</span><span class=p>:</span> Login to site, and check a article content.
    <span class=nf>Given</span> I login with user <span class=s>"test"</span>
    <span class=nf>When</span>  I visit <span class=s>"&lt;Title&gt;"</span> node of type <span class=s>"article"</span>
    <span class=nf>Then</span>  I should see the title <span class=s>"&lt;Title&gt;"</span>
    <span class=nf>And</span>   I should see the <span class=s>"description"</span> field <span class=s>"&lt;Description&gt;"</span>
    <span class=nf>And</span>   I should see the <span class=s>"tag"</span> field <span class=s>"&lt;Tag&gt;"</span>
    <span class=nf>And</span>   I should see <span class=s>"&lt;Number of pictures&gt;"</span> pictures in <span class=s>"images"</span> section


  <span class=nn>Examples</span><span class=p>:</span>
    <span class=p>|</span> <span class=nv>Title</span>       <span class=p>|</span>          <span class=nv>Description</span>     <span class=p>|</span>      <span class=nv>Tag</span>      <span class=p>|</span> <span class=nv>Number</span> <span class=nv>of</span> <span class=nv>pictures</span> <span class=p>|</span>
    <span class=p>|</span> <span class=n>Curabitur</span>   <span class=p>|</span> <span class=n>Nam</span> <span class=n>sed</span> <span class=n>ex</span> <span class=n>vitae</span> <span class=n>arcu</span>    <span class=p>|</span> <span class=n>Education</span>     <span class=p>|</span> <span class=n>1</span>                  <span class=p>|</span>
    <span class=p>|</span> <span class=n>Quisque</span>     <span class=p>|</span> <span class=n>Praesent</span> <span class=n>maximus</span> <span class=n>a</span> <span class=n>mi</span> <span class=n>si</span> <span class=p>|</span> <span class=n>Science</span>       <span class=p>|</span> <span class=n>0</span>                  <span class=p>|</span>
    <span class=p>|</span> <span class=n>Lorem</span> <span class=n>ipsum</span> <span class=p>|</span> <span class=n>Aenean</span> <span class=n>sem</span> <span class=n>lectus,</span> <span class=n>porta</span> <span class=p>|</span> <span class=n>Entertainment</span> <span class=p>|</span> <span class=n>2</span>                  <span class=p>|</span>
</code></pre></div><p>Of course, don’t forget that when the migration is ready, run some final tests against the site with all the content.</p><div class="ui segments"><div class="ui attached center aligned segment"><div class="ui image"><img src="https://www.gizra.com/assets/images/posts/migration-best-practices/image1.jpg"/></div></div></div><h2 id=getting-the-data-for-testing>Getting the data for testing</h2><p>Since you will migrate data from SQL tables (thanks to csv2sql), it should be easy to get data already prepared for tests using MySQL queries in phpMyAdmin.</p><p>Here is an example of an SQL query to get data from the sql table which will take the <code class=highlighter-rouge>_title</code> and <code class=highlighter-rouge>_description</code> from each 100th line of the <code class=highlighter-rouge>_raw_article</code> table.</p><p>The sql query selects the fields you want to check in your automatic test from every 100th line, and adds empty placeholders (i.e. <code class=highlighter-rouge>leftPipe</code> and <code class=highlighter-rouge>rightPipe</code>) that will be converted to pipes in the beginning and in the end of each line during the export.</p><div class="language-sql highlighter-rouge"><pre class=highlight><code><span class=k>SELECT</span> <span class=s1>''</span> <span class=k>as</span> <span class=n>leftPipe</span><span class=p>,</span> <span class=nv>`_title`</span><span class=p>,</span><span class=nv>`_description`</span><span class=p>,</span> <span class=s1>''</span> <span class=k>as</span> <span class=n>rightPipe</span> <span class=k>FROM</span> <span class=nv>`_raw_article`</span> <span class=k>WHERE</span> <span class=p>(</span><span class=nv>`_raw_video`</span><span class=p>.</span><span class=nv>`__id`</span> <span class=o>%</span> <span class=mi>100</span><span class=p>)</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</code></pre></div><p>Now you can use phpMyAdmin to export the result table to CSV format. You can download the data as a CSV file or directly copy it:</p><div class="ui segments"><div class="ui attached center aligned segment"><div class="ui image"><img src="https://www.gizra.com/assets/images/posts/migration-best-practices/image3.jpg"/></div></div><div class="ui attached center aligned caption segment">Export result of the query.</div></div><div class="ui segments"><div class="ui attached center aligned segment"><div class="ui image"><img src="https://www.gizra.com/assets/images/posts/migration-best-practices/image4.jpg"/></div></div><div class="ui attached center aligned caption segment">Use custom settings.</div></div><div class="ui segments"><div class="ui attached center aligned segment"><div class="ui image"><img src="https://www.gizra.com/assets/images/posts/migration-best-practices/image5.jpg"/></div></div><div class="ui attached center aligned caption segment">Use CSV format, separate columns with pipes.</div></div><p>Here’s the output you will get, ready to be added to your Behat test:</p><div class="language-gherkin highlighter-rouge"><pre class=highlight><code>  <span class=p>|</span> <span class=nv>Ludwig</span> <span class=nv>Blum</span>    <span class=p>|</span> <span class=nv>The</span> <span class=nv>Israeli</span> <span class=nv>Ambassador</span> <span class=p>|</span>
  <span class=p>|</span> <span class=n>Julia</span> <span class=n>Lagusker</span> <span class=p>|</span> <span class=n>Julia</span> <span class=n>Lagusker</span>         <span class=p>|</span>
  <span class=p>|</span> <span class=n>Noah</span> <span class=n>Heymann</span>   <span class=p>|</span> <span class=n>Interview</span> <span class=n>the</span> <span class=n>artist</span>   <span class=p>|</span>
</code></pre></div><h2 id=known-pitfalls>Known pitfalls</h2><ul><li>Some images may be missing. A <a href=https://gist.github.com/HelenaEksler/e01a3572afc39f189ecc>bash script</a>, for example, can help you identify which.</li><li>The text of content may be polluted with messy HTML. Worse, it may even have broken links. Don’t leave it to the end and deal with this early on, as it can be a tough one.</li><li>If your data should be translated decide in advance what to do if some translated items are missing.</li></ul><p>That’s it, I’d love to hear other best practices devs are applying to their migration projects.</p></div></div><div class="twelve wide column computer only"><div class="ui borderless secondary menu"><a class=item href="/content/docker-travis-ci/"><i class="chevron left icon"></i> Docker and Travis-CI</a><div class="right menu"><a class=item href="/content/job-post-goes-viral/">A Job Posting Goes Viral <i class="chevron right icon"></i></a></div></div></div><div class="twelve wide column"><div class="ui segment basic"><div id=disqus_thread></div><script type=text/javascript>var disqus_shortname = 'gizra';
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();</script><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div></div></div></div><footer class="ui black inverted vertical footer segment padded"><div class="ui center aligned container"><div class="ui three column stackable inverted grid"><div class=column><address><div class=strong>Israel Headquarters</div><div>5 Brenner Street, Tel Aviv</div><a class=telephone href=tel:+97233731222>+972-3-3731222</a> // <a class=email href=mailto:info@gizra.com>info@gizra.com</a></address></div><div class="column icons"><a target=_blank href=https://twitter.com/gizra_drupal><i class="twitter huge icon"></i></a> <a target=_blank href=https://github.com/Gizra/gizra.com><i class="github huge icon"></i></a></div><div class=column><address><div class=strong>North America Office</div><div>350 N. Orleans Street, Suite 9000N, Chicago, IL 60647</div><a class=telephone href=tel:+13125857625>312-585-7625</a> // <a class=email href=mailto:usoffice@gizra.com>usoffice@gizra.com</a></address></div></div></div></footer></div><script src=/bower_components/anchor-js/anchor.min.js></script><script src=/assets/javascript/script.js></script></body></html>