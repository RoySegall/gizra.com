<!DOCTYPE html><html><head><title>Integrating Javascript into Elm: Alternatives to Ports</title><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta property=og:site_name content=Gizra><meta property=og:title content="Integrating Javascript into Elm: Alternatives to Ports"><meta name=description content="How can you integrate some Javascript into Elm when ports won't quite do?"><meta property=og:description content="How can you integrate some Javascript into Elm when ports won't quite do?"><meta name=twitter:card content="summary_large_image"/><meta name=twitter:site content="@gizra_drupal"/><meta property=og:image content=https://www.gizra.com/assets/images/posts/elm-port-alternatives/thumb.jpg><link rel=apple-touch-icon sizes=180x180 href=/assets/favicons/apple-touch-icon-180x180.png><link rel=icon type=image/png href=/assets/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/assets/favicons/favicon-194x194.png sizes=194x194><link rel=icon type=image/png href=/assets/favicons/favicon-96x96.png sizes=96x96><link rel=icon type=image/png href=/assets/favicons/android-chrome-192x192.png sizes=192x192><link rel=icon type=image/png href=/assets/favicons/favicon-16x16.png sizes=16x16><link rel=manifest href=/assets/favicons/manifest.json><meta name=msapplication-TileColor content=#000000><meta name=msapplication-TileImage content=/assets/favicons/mstile-144x144.png><meta name=theme-color content=#ffffff><link href="https://fonts.googleapis.com/css?family=Abril+Fatface&text=gizra" rel=stylesheet><link href="https://fonts.googleapis.com/css?family=Esteban" rel=stylesheet><link href="https://fonts.googleapis.com/css?family=Open+Sans:400,700" rel=stylesheet><link href="https://fonts.googleapis.com/css?family=Montserrat:500,700" rel=stylesheet><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.2.7/semantic.min.css integrity="sha256-wT6CFc7EKRuf7uyVfi+MQNHUzojuHN2pSw0YWFt2K5E=" crossorigin="anonymous"/><link rel=stylesheet href="/assets/stylesheets/style.css"/><script src=https://code.jquery.com/jquery-2.2.4.min.js integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.2.7/semantic.min.js integrity="sha256-flVaeawsBV96vCHiLmXn03IRJym7+ZfcLVvUWONCas8=" crossorigin=anonymous></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-6558346-3', 'auto');
  ga('send', 'pageview');</script></head><body class=pushable><div class="ui sidebar inverted vertical menu left"><a class="item active" href="/">Home</a> <a class=item href=/team>Team</a> <a class=item href=/blog>Blog</a> <a class=item href=/podcast>Podcast</a> <a class=item href=/projects>Projects</a> <a class=item href=/our-story>Our Story</a> <a class=item href=/contact>Contact</a></div><div class=pusher><div class="ui grid container"><header class=row><div class="five wide column menu bar"><div class="ui large secondary menu"><a class="item sidebar-toggle"><i class="big sidebar icon"></i> Menu</a></div></div><div class="six wide computer six wide tablet eleven wide mobile column center aligned"><a class=gizra-logo href="/"><svg xmlns=http://www.w3.org/2000/svg width=252 height=104><title>gizra</title><path fill=#E27058 fill-rule=evenodd d="M44.3 21.6c.2 3.5 3 5.4 6 5.4 3.5 0 6.7-2 6.7-7s-3.6-7.7-8.5-7.7c-4.3 0-10.3 2.5-10.3 11 0 1.7.2 3.4.6 5.3-3.4-2-6.5-2.6-11.6-2.6-16 0-22.7 7.6-22.7 17.5 0 8.7 4 13.7 12.2 16-8.2 5-12 7.8-12 13.8C4.7 78 8 83 20.7 83h10c11 0 13.4 2 13.4 7 0 6.7-5.8 11.3-17 11.3s-13.4-4.7-13.4-9c0-1.8.2-3.5 1-5.8l-6.4-3C4.5 84.8.2 87 .2 92c0 6.8 7.5 11.3 25.8 11.3 21.2 0 29.6-8.5 29.6-20 0-14.4-12-17.2-23.8-17.2H21c-5.5 0-6.6-.4-6.6-1.4 0-1 1-2 4.6-4.4 2.2.4 5.4.8 8.5.8C40.3 61 49 55 49 43c0-6.8-4-10.5-8-13.3-.6-2.5-.8-4.6-.8-6.3 0-6.5 3-7 4.5-7 2.2 0 2.8 1.7 2.5 3.4l-3 1.8zM22 41.2C22 29.7 24 28 27 28s4.6 1.4 4.6 13.2v5c0 11-1.8 12.7-4.6 12.7-3.2 0-5-2.3-5-12V41zM62 10c0 4.4 2 9.8 10.6 9.8 7.6 0 10.6-4.3 10.6-10 0-6.3-3.8-9.6-10.4-9.6C65 .2 62 5 62 10zm-5.4 17v2h6.2v46H57v2h31.2v-2h-6V27H56.7zm82.5 0H95l-1.4 20.2H95c4.3-15 8-18.3 22.2-18.3h1L93 75.3V77h44l1.8-21.5h-1.5C133.5 69 127.5 75 115.6 75h-1.4l25-46v-2zm41 3c2.2 0 4.3 1 2.2 5.3h-3.8c-2.2 7.5 1 12 8.2 12 5.6 0 8.8-4 8.8-10 0-8-5-11.3-11.2-11.3-6.3 0-12 3.6-14 11V27H145v2h5.7v46h-5.8v2h32.6v-2h-7.4V47c0-9.5 4.7-17 9.7-17zm40.5 22.3c-15 0-24.2 2.4-24.2 13 0 10.5 8.2 12.8 15.6 12.8 7.2 0 10.3-2.7 12-7.7 1.2 5 6 7.8 14.4 7.8 9 0 13-3.5 13.5-16l-1.7-.2c-.5 8.8-2.3 10.8-4.2 10.8-1.7 0-3-1.2-3-5.5V46c0-15.2-5.5-19.8-22-19.8-14.3 0-22 4-22 13 0 5 2.6 8.6 9 8.6 5.3 0 9.3-3.3 9.3-8.2 0-2-.3-3.4-.8-4.7H214c-.6-1.2-.8-2.2-.8-3 0-3.4 3-4.3 5-4.3 4.2 0 5.3 3.5 5.3 16.8v8h-3zM219 73.8c-2 0-2.7-1-2.7-8.6v-1.6c0-6.4 2-9.6 6.5-9.6h.7v9.8c0 6.7-2.5 10-4.5 10z"/></svg></a><div class=tagline>We Build Websites</div></div><div class="five wide computer only column"></div></header><div class="ui grid centered post"><div class="sixteen wide mobile sixteen wide tablet twelve wide computer column"><div class="ui raised padded segment"><h1 class="ui dividing header"><div class="ui image"><img src=/assets/images/team/avatars/rgrempel.jpg class="ui circular image"></div><div class=content><a href="/content/elm-port-alternatives/">Integrating Javascript into Elm: Alternatives to Ports</a><div class="sub header">By Ryan Rempel (@rgrempel) // 05 Jan 2018</div></div><div class="right floated column"><a href=/blog class="ui teal right ribbon big label">Blog Post</a></div></h1><p>Once you start writing apps (and packages) in <a href="http://elm-lang.org/">Elm</a>, it’s tempting to avoid the rough-and-tumble world of Javascript as much as possible. Yet when implementing features for paying clients, it doesn’t always make sense to take things that already have a Javascript implementation and re-implement them in pure Elm. In fact, sometimes it isn’t even possible!</p><p>Now, Elm has a very fine mechanism for integrating bits of Javascript when necessary – <a href=https://guide.elm-lang.org/interop/javascript.html>ports</a>! Yet ports aren’t always the right answer, and there are several alternatives which can be useful in certain situations.</p><p>For the purposes of this post, I’m going to assume that you’re familiar with the many cases in which ports work well, and focus instead on a few cases where you might want to try something else:</p><ul><li>When you want synchronous answers.</li><li>When you need some context when you get the answer.</li><li>When you want to manage parts of the DOM using Javascript.</li></ul><h2 id=getting-immediate-answers>Getting Immediate Answers</h2><p>One characteristic of ports in Elm is that they are inherently asynchronous. There are “outgoing” ports, which send messages from Elm to Javascript. There are “incoming” ports, which send messages from Javascript to Elm. Suppose your Elm code wants to ask a question that Javascript code can answer. You can send a message on an outgoing port, and the Javascript code which is listening there can send the answer on an incoming port. However, the answer will arrive asynchronously. It’s not just a function call on the Elm side, where you could immediately use the answer in the current computation. Instead, the answer will arrive sometime in the future, through a message passed to your <code class=highlighter-rouge>update</code> function.</p><p>Now, there are important reasons why ports work this way. Basically, it means that you don’t need to worry about whether your Javascript code is “pure” and free of side-effects. Instead, the ports mechanism treats all Javascript as if it were impure or effectful, and forces all communication through the <code class=highlighter-rouge>update</code> mechanism.</p><p>Yet it is certainly possible to write Javascript that is pure and free of side-effects – and sometimes it’s necessary to have Elm treat it that way. In those cases, your only alternative is to write a “kernel module” (what we used to call a “native module”). This isn’t actually that hard, but there is a bit of a taboo against explaining how to do it. I suppose the attitude is that if you can’t figure it out on your own, you probably won’t avoid shooting yourself in the foot with it. So, I’ll say no more, except that the source code for Elm’s core libraries is very illuminating.</p><h2 id=associating-questions-and-answers>Associating Questions and Answers</h2><p>Even in cases where the things you want to do in Javascript are necessarily asynchronous, Elm’s port mechanism is strangely unhelpful when you need to associate questions with answers. Consider the <a href=https://guide.elm-lang.org/interop/javascript.html>example</a> given in the Elm docs, for integrating a Javascript spell-checking mechanism. It imagines two ports – one for sending strings from Elm to Javascript, and one for Javascript to send suggestions back to Elm.</p><div class="language-elm highlighter-rouge"><div class=highlight><pre class=highlight><code>    <span class=c1>-- port for sending strings out to JavaScript</span>
    <span class=k>port</span> <span class=n>check</span> <span class=p>:</span> <span class=kt>String</span> <span class=o>-&gt;</span> <span class=kt>Cmd</span> <span class=n>msg</span>

    <span class=c1>-- port for listening for suggestions from JavaScript</span>
    <span class=k>port</span> <span class=n>suggestions</span> <span class=p>:</span> <span class=p>(</span><span class=kt>List</span> <span class=kt>String</span> <span class=o>-&gt;</span> <span class=n>msg</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=kt>Sub</span> <span class=n>msg</span>
</code></pre></div></div><p>Notice that there is nothing in the response which provides any context. It’s just a list of suggestions, with no reference to the question you asked. So, if it’s possible to have more than one <code class=highlighter-rouge>check</code> in-flight at a time (this is asynchronous, after all), then there’s nothing here to tell you which answer goes with which question.</p><h3 id=manually>Manually</h3><p>Now, in some cases this can be easily fixed. For instance, you could imagine a helpful change in the API quoted above – one could include the input along with the response:</p><div class="language-elm highlighter-rouge"><div class=highlight><pre class=highlight><code>    <span class=k>port</span> <span class=n>suggestions</span> <span class=p>:</span> <span class=p>((</span><span class=kt>String</span><span class=o>,</span> <span class=kt>List</span> <span class=kt>String</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>msg</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=kt>Sub</span> <span class=n>msg</span>
</code></pre></div></div><p>I’ve used this kind of approach, and it can work, but it’s often more awkward than this simple example. Often, you need to retain more context than just a simple string (for example, a position in a document). You may need to encode and decode the context to a JSON value, since it won’t necessarily be limited to the types that ports can handle without help.</p><p>It definitely seems awkward by comparison to how tasks work in Elm. With tasks, you can keep a bunch of state <strong>implicitly</strong>, without having to explicitly supply the context to the task, and have the task supply the context back. If checking suggestions were a task, you could do something like this:</p><div class="language-elm highlighter-rouge"><div class=highlight><pre class=highlight><code>    <span class=k>let</span>
        <span class=n>context</span> <span class=o>=</span>
            <span class=o>...</span>
    <span class=k>in</span>
        <span class=n>checkSuggestions</span> <span class=n>wordToCheck</span>
            <span class=o>|&gt;</span> <span class=kt>Task</span><span class=o>.</span><span class=n>attempt</span> <span class=p>(</span><span class=kt>HandleSuggestions</span> <span class=n>context</span><span class=p>)</span>
</code></pre></div></div><p>Eventually, your <code class=highlighter-rouge>update</code> function is going to be called with a <code class=highlighter-rouge>HandleSuggestions</code> message that has two parameters: the context, and the result of attempting the task. But, unlike with ports, the implementation of the task doesn’t have to know about the context – it doesn’t need to accept the context as a parameter and pass it back with the suggestions. It can just provide the suggestions and let Elm worry about remembering the context.</p><p>The reason that ports don’t already work this way is a little subtle. Fundamentally, the problem is said to be that it would <a href=https://groups.google.com/forum/#!topic/elm-dev/kNKilHjUYqo>work too well</a>, thus leading to greater use of Javascript within Elm than is considered desirable.</p><h3 id=with-porter>With <code class=highlighter-rouge>Porter</code></h3><p>However, there is an interesting package (which I haven’t tried yet) that looks as though it would allow you to use ports with some of the elegance of tasks. <a href=http://package.elm-lang.org/packages/peterszerzo/elm-porter/latest>peterszerzo/elm-porter</a>. After some setup, this package allows you to specify handlers for port responses on a per-request basis. So, the above code would translate (with the appropriate setup) into something roughly like:</p><div class="language-elm highlighter-rouge"><div class=highlight><pre class=highlight><code>    <span class=k>let</span>
        <span class=n>context</span> <span class=o>=</span>
            <span class=o>...</span>
    <span class=k>in</span>
        <span class=kt>Porter</span><span class=o>.</span><span class=n>send</span> <span class=p>(</span><span class=kt>HandleSuggestions</span> <span class=n>context</span><span class=p>)</span> <span class=n>wordToCheck</span>
            <span class=o>|&gt;</span> <span class=kt>Cmd</span><span class=o>.</span><span class=n>map</span> <span class=kt>PortMsg</span>
</code></pre></div></div><p>The Javascript code does receive an ID which it needs to include in the response, but that’s it – the rest of the book-keeping is handled by the <code class=highlighter-rouge>Porter</code> module. It remembers the context you provide with the request, and supplies it back to you when the response arrives.</p><p>So, that looks like a promising approach, which I’m planning to try on the next suitable occasion. However, it still doesn’t have all the elegance of tasks. For one thing, there is some setup that I haven’t shown you (the usual integration of <code class=highlighter-rouge>PortMsg</code> with the Elm architecture, and some configuration). Plus, what you eventually get is a <code class=highlighter-rouge>Cmd</code> rather than a <code class=highlighter-rouge>Task</code>, so your ability to deal with intermediate results is limited. For instance, you can’t do neat stuff like chaining several tasks together before feeding things back into your <code class=highlighter-rouge>update</code> function.</p><div class="language-elm highlighter-rouge"><div class=highlight><pre class=highlight><code>    <span class=k>let</span>
        <span class=n>context</span> <span class=o>=</span>
            <span class=o>...</span>
    <span class=k>in</span>
        <span class=n>checkSuggestions</span> <span class=n>wordToCheck</span>
            <span class=o>|&gt;</span> <span class=kt>Task</span><span class=o>.</span><span class=n>andThen</span> <span class=n>doAnotherTaskThatDependsOnTheResult</span>
            <span class=o>|&gt;</span> <span class=kt>Task</span><span class=o>.</span><span class=n>attempt</span> <span class=p>(</span><span class=kt>HandleSuggestions</span> <span class=n>context</span><span class=p>)</span>
</code></pre></div></div><p>But, I recently came across another interesting alternative that fits some niches very nicely – service-workers.</p><h3 id=with-service-workers>With Service Workers</h3><p>If you’re not familiar with <a href="https://developers.google.com/web/fundamentals/primers/service-workers/">service workers</a>, they are essentially a mechanism for running Javascript code in a special context that can act “behind the scenes” of your web app – amongst other things, intercepting network requests and serving them from a cache, if necessary.</p><p>The complexity of setting up a service worker is such that you wouldn’t want to do it just for the sake of something you could do with ports. Plus, service workers require a relatively recent version of Chrome or Firefox (though Safari support is said to be coming). However, I was recently working on a project that uses a service-worker anyway, and realized that it provided a very nice way of doing Javascript interop with Elm.</p><p>Here’s how it can work.</p><ul><li><p>Your service worker can listen for the <code class=highlighter-rouge>fetch</code> event, which represents an HTTP request your app is making. Normally, you’d check the URL, and then possibly answer the request from the cache, or let the browser handle the request in the usual way.</p></li><li><p>However, you can determine what response to provide however you like. So, you can check for a specially-defined URL that represents a specific question, take a look at the JSON the app has provided, and construct a response in whatever manner is appropriate.</p></li></ul><p>In other words, you can treat the special URL as if it were a kind of function call, and the JSON body as if it were the parameters provided to the function. Thus, from the Elm app’s point of view, you:</p><ul><li>construct an HTTP request to a special URL;</li><li>provide some JSON which represents the question you are asking; and</li><li>decode the answer that you get.</li></ul><p>But no network request is actually made. Instead, the request is intercepted by your Javascript service-worker code, which can construct a response as it wishes.</p><p>Why might this be an attractive option? Well, HTTP requests are pretty nice in Elm. You can encode the JSON to provide, decode the JSON that comes back, and you get a task that can be chained and can carry along implicit context. You even have a well-defined way of handling errors. It’s a pleasant, well-understood mechanism. So, it’s nice to be able to re-use this familiar mechanism to invoke arbitrary Javascript code inside the service-worker.</p><p>Now, one difficulty is that the service-worker does not have direct access to the DOM. A service-worker can access the DOM indirectly via <code class=highlighter-rouge>postMessage</code>, so that may be a feasible approach (I haven’t tried it). Otherwise, doing Javascript interop via a service worker would be limited to operations that don’t need the DOM.</p><h2 id=managing-foreign-dom>Managing Foreign DOM</h2><p>In fact, none of the techniques I’ve discussed so far handle the case where you have some Javascript code that wants to “manage” parts of the DOM. Consider how Javascript libraries like <a href="https://www.tinymce.com/">TinyMCE</a> or <a href="http://www.dropzonejs.com/">DropzoneJS</a> work.</p><ul><li><p>You put a special <code class=highlighter-rouge>div</code> in your HTML with a particular ID and/or class.</p></li><li><p>You call a function that initializes your <code class=highlighter-rouge>div</code> and sets up some listeners for events emitted by it.</p></li><li><p>The library writes some content inside the <code class=highlighter-rouge>div</code>, the user interacts with it, and events are emitted.</p></li></ul><p>So, how can you integrate this into an Elm app?</p><h3 id=special-div>Special <code class=highlighter-rouge>div</code></h3><p>The first thing you’ll need to consider is how you write out the special <code class=highlighter-rouge>div</code>. The Javascript library is going to “manage” the content of that <code class=highlighter-rouge>div</code>, writing and re-writing nodes within it. But Elm’s virtual DOM doesn’t expect that – it expects to be the only thing that can change the DOM underneath Elm’s root node. This has a couple of implications.</p><ul><li><p>Elm’s virtual DOM is going to feel free to destroy and recreate the special <code class=highlighter-rouge>div</code> when it (or an ancestor) moves relative to other nodes. But you won’t want that – you’ll want the special <code class=highlighter-rouge>div</code> to remain intact and be moved, rather than destroyed and recreated. Otherwise, the content written by the Javascript library will be lost.</p></li><li><p>Elm has some optimizations in its virtual DOM which depend on a match between the virtual DOM and the real DOM. If there are things in the real DOM that the virtual DOM didn’t put there, these optimizations can produce strange bugs when updating the DOM.</p></li></ul><p>The solution is to make the special <code class=highlighter-rouge>div</code> a <code class=highlighter-rouge>keyed</code> node. Using keys to construct your nodes gives the virtual DOM a kind of index so that it can track nodes that should be considered equivalent, even if they move around. So, if your special <code class=highlighter-rouge>div</code> moves, it will actually be moved by the virtual DOM, not destroyed and recreated. And, the keyed nodes also side-step the optimizations which can otherwise cause trouble when there are things in the real DOM that the virtual DOM didn’t put there.</p><p>(To be completely safe, you’ll need to use <code class=highlighter-rouge>keyed</code> nodes for all the ancestors of the special <code class=highlighter-rouge>div</code>, since destroying and recreating any of those ancestors would destroy and recreate the special <code class=highlighter-rouge>div</code> itself).</p><h3 id=initialization>Initialization</h3><p>Having created the special <code class=highlighter-rouge>div</code>, how can you go about initializing it?</p><p>The actual act of initialization is easily enough done via ports. You can simply set up a port which accepts a DOM id, finds the node with that ID, and runs the Javascript needed to initalize the node. The hard part is knowing <strong>when</strong> to do this.</p><p>One minor difficulty is that Elm’s virtual DOM operates on a bit of a delay. Instead of writing each change to the DOM as each update takes place, it uses <code class=highlighter-rouge>requestAnimationFrame</code> to throttle the DOM changes, only making them as often as the screen will refresh. So, your Javascript code will need to wait a bit for the special <code class=highlighter-rouge>div</code> to appear.</p><p>By itself, this is easily handled. If you know that the virtual DOM is about to write out your special <code class=highlighter-rouge>div</code> for the first time, your Javascript code can itself use <code class=highlighter-rouge>requestAnimationFrame</code> to wait for a screen refresh. This turns out (at least in the current implementaton) to reliably trigger after the virtual DOM has done its work.</p><p>The harder part is knowing that the virtual DOM is about to write out your special <code class=highlighter-rouge>div</code> for the first time. In one way, it is your <code class=highlighter-rouge>view</code> function which controls when this happens – after all, the special <code class=highlighter-rouge>div</code> must be contained in your <code class=highlighter-rouge>view</code> function. However, it is fundametal to the Elm architecture that your <code class=highlighter-rouge>view</code> function depends on states, not transitions. It merely takes your <code class=highlighter-rouge>Model</code> and produces some <code class=highlighter-rouge>Html</code>. There is nothing within the <code class=highlighter-rouge>view</code> function that lets you know whether this is the first time your special <code class=highlighter-rouge>div</code> is going to be written.</p><p>Even if your <code class=highlighter-rouge>view</code> function knew when the special <code class=highlighter-rouge>div</code> would first be written, there isn’t anything you can do from your <code class=highlighter-rouge>view</code> function to send a message to a port. That can only be done from your <code class=highlighter-rouge>update</code> function. But, it awkward to ask your <code class=highlighter-rouge>update</code> function to handle this. Consider the questions it must answer:</p><ul><li><p>Given the current model, will the special <code class=highlighter-rouge>div</code> already have been drawn?</p></li><li><p>If not, will it be drawn given the new model that I will return?</p></li></ul><p>In effect, your <code class=highlighter-rouge>update</code> function needs to answer some questions about what your <code class=highlighter-rouge>view</code> function is about to do. Now, you can imagine doing this. Two approaches are possible:</p><ul><li><p>You can identify every state transition (i.e. every message) that will make your <code class=highlighter-rouge>view</code> function draw your special <code class=highlighter-rouge>div</code> for the first time.</p></li><li><p>You can write a function <code class=highlighter-rouge>willDrawMySpecialDiv</code> which, given your model, determines whether your <code class=highlighter-rouge>view</code> function will draw the special <code class=highlighter-rouge>div</code>. Then, you can apply that function to the current model, to see whether it will already have been drawn, and apply it to the new model you’re returning, to see whether it is about to be drawn.</p></li></ul><p>Yet both of these approaches have difficulties. Identifying all the state transitions that will write your special <code class=highlighter-rouge>div</code> for the first time can work in simple cases, but it is error prone – it’s easy to miss some of them.</p><p>Using a <code class=highlighter-rouge>willDrawMySpecialDiv</code> function has other problems. You will need to keep your actual <code class=highlighter-rouge>view</code> function in sync with <code class=highlighter-rouge>willDrawMySpecialDiv</code>. Worse, in a modular app, the dispatch of your <code class=highlighter-rouge>update</code> function typicaly depends on the <code class=highlighter-rouge>Msg</code>, but the dispatch of your <code class=highlighter-rouge>view</code> function typcially depends on something in the <code class=highlighter-rouge>Model</code>, such as a <code class=highlighter-rouge>Page</code> or the like. So, reliably determining <code class=highlighter-rouge>willDrawMySpecialDiv</code> in a modular app requires another round of function dispatch from the top-level of the app down. It’s not a concern that can be handled wholly within a single module. To put it another way, the answer you get to <code class=highlighter-rouge>willDrawMySpecialDiv</code> may change even if the <code class=highlighter-rouge>update</code> function in your particular module is never invoked.</p><p>Now, despite these difficulties, particular cases can be made to work – you just have to think through the particular features of the way your app is organized that allow you to know when your special <code class=highlighter-rouge>div</code> will be written for the first time. Sometimes, it’s entirely straightforward. But, having done this a few times, I wondered whether there might be a more general, less awkward solution.</p><p>The idea which occurred to me was this. What if, in our <code class=highlighter-rouge>view</code> function, we wrote out a <code class=highlighter-rouge>&lt;script&gt;</code> tag, right next to our special div? Browsers <strong>execute</strong> script tags once they’ve been written. Now, normally this would be a terrible idea, an awful hack. After all, the <code class=highlighter-rouge>view</code> function is supposed to be free of side-effects, and (sometimes) executing a script sure seems like a side-effect. But, consider how well this fits our needs:</p><ul><li><p>If our <code class=highlighter-rouge>view</code> function writes the <code class=highlighter-rouge>script</code> tag next to the special div, it will necessarily be written only when the special div is written, and not otherwise.</p></li><li><p>So, the script will run only when the special div has been written.</p></li><li><p>And, it won’t run again until the nodes are destroyed and re-created (which we ensure only happens when we intend, using <code class=highlighter-rouge>keyed</code> nodes).</p></li></ul><p>Isn’t that lovely? It turns out to work quite well – it looks something like this:</p><div class="language-elm highlighter-rouge"><div class=highlight><pre class=highlight><code>    <span class=n>script</span> <span class=p>:</span> <span class=kt>String</span> <span class=o>-&gt;</span> <span class=kt>Html</span> <span class=n>any</span>
    <span class=n>script</span> <span class=n>code</span> <span class=o>=</span>
        <span class=n>node</span> <span class=s>"</span><span class=s2>script"</span>
            <span class=p>[]</span>
            <span class=p>[</span> <span class=n>text</span> <span class=n>code</span> <span class=p>]</span>

    <span class=n>view</span> <span class=p>:</span> <span class=kt>Model</span> <span class=o>-&gt;</span> <span class=kt>Html</span> <span class=kt>Msg</span>
    <span class=n>view</span> <span class=n>model</span> <span class=o>=</span>
        <span class=o>...</span>
        <span class=p>[</span> <span class=n>div</span>
            <span class=p>[</span> <span class=n>id</span> <span class=s>"</span><span class=s2>dropzone"</span>
            <span class=o>,</span> <span class=n>on</span> <span class=s>"</span><span class=s2>dropzonecomplete"</span> <span class=p>(</span><span class=kt>Json</span><span class=o>.</span><span class=kt>Decode</span><span class=o>.</span><span class=n>map</span> <span class=kt>DropZoneComplete</span> <span class=n>decodeDropZoneFile</span><span class=p>)</span>
            <span class=p>]</span>
            <span class=p>[]</span>
                <span class=o>|&gt;</span> <span class=n>keyed</span> <span class=s>"</span><span class=s2>dropzone"</span>

        <span class=c1>-- This runs the function from our `app.js` at the precise moment this gets</span>
        <span class=c1>-- written to the DOM. Isn't that convenient?</span>
        <span class=o>,</span> <span class=n>script</span> <span class=s>"</span><span class=s2>bindDropZone()"</span>
            <span class=o>|&gt;</span> <span class=n>keyed</span> <span class=s>"</span><span class=s2>script"</span>
        <span class=p>]</span>
        <span class=o>...</span>
</code></pre></div></div><p>As noted above, the guts of the initialization happens in a Javascript function defined externally. This keeps the <code class=highlighter-rouge>&lt;script&gt;</code> node itself pretty simple, but it could be more complex if necessary.</p><p>So, this turns out to be a pretty convenient way to handle the initialization of DOM nodes by Javascript libraries that want to manage some DOM. But, initialization isn’t our only need – what about the events which those libraries generate?</p><h3 id=handling-events>Handling Events</h3><p>When you initialize your special <code class=highlighter-rouge>div</code>, you’ll want to set up some listeners for events that it generates. For instance, for DropzoneJS, you’ll want to know when a file has been uploaded. Or, for TinyMCE, you’ll want to know when the content has been edited.</p><p>One approach would be to set up Javascript listeners, which in turn send messages to an incoming Elm port. This works, but it has the “context” awkwardness which I identified above. Consider the case where there are several instances of your special <code class=highlighter-rouge>div</code>, and you need to deal with events from one differently than events from another. Of course, you can initialize each one with some context, provide the context back with each event, and then use the context in dispatching the subscription to the port.</p><p>That works, but it is a bit awkward and verbose, compared with how we usually handle events in views. Usually, we just use <code class=highlighter-rouge>Html.Events.on</code> to attach an Elm listener to some event, and we can then route it using the familiar <code class=highlighter-rouge>Html.map</code> to provide some context, without having to communicate that context to the Javascript side and feed it back to Elm.</p><p>Well, if you look carefully at the sample code I quoted above, that’s exactly what I’ve done for some DropzoneJS events. Here’s the key bit again:</p><div class="language-elm highlighter-rouge"><div class=highlight><pre class=highlight><code>    <span class=n>div</span>
        <span class=p>[</span> <span class=n>id</span> <span class=s>"</span><span class=s2>dropzone"</span>
        <span class=o>,</span> <span class=n>on</span> <span class=s>"</span><span class=s2>dropzonecomplete"</span> <span class=p>(</span><span class=kt>Json</span><span class=o>.</span><span class=kt>Decode</span><span class=o>.</span><span class=n>map</span> <span class=kt>DropZoneComplete</span> <span class=n>decodeDropZoneFile</span><span class=p>)</span>
        <span class=p>]</span>
        <span class=p>[]</span>
</code></pre></div></div><p>Notice the <code class=highlighter-rouge>on "dropzonecomplete"</code>. Instead of subscribing to a message from a port, we’re listening for an event on a DOM node, in the usual way. We supply a decoder for the event (<code class=highlighter-rouge>decodeDropZoneFile</code>), and a tag to route it to our <code class=highlighter-rouge>Msg</code> type (<code class=highlighter-rouge>DropZoneComplete</code>). If there was some additional context needed, we could provide it as an extra parameter to our <code class=highlighter-rouge>DropZoneComplete</code> tag. And, we don’t need to set up a port and subscription at all – we just listen for events.</p><p>But how do we generate the events? Here’s an example of what <code class=highlighter-rouge>bindDropZone()</code> looks like on the Javascript side.</p><div class="language-js highlighter-rouge"><div class=highlight><pre class=highlight><code>    <span class=kd>var</span> <span class=nx>dropZone</span> <span class=o>=</span> <span class=kc>undefined</span><span class=p>;</span>

    <span class=kd>function</span> <span class=nx>bindDropZone</span> <span class=p>()</span> <span class=p>{</span>
        <span class=c1>// We could make this dynamic, if needed</span>
        <span class=kd>var</span> <span class=nx>selector</span> <span class=o>=</span> <span class=s2>"#dropzone"</span><span class=p>;</span>
        <span class=kd>var</span> <span class=nx>element</span> <span class=o>=</span> <span class=nb>document</span><span class=p>.</span><span class=nx>querySelector</span><span class=p>(</span><span class=nx>selector</span><span class=p>);</span>

        <span class=k>if</span> <span class=p>(</span><span class=nx>element</span><span class=p>)</span> <span class=p>{</span>
            <span class=k>if</span> <span class=p>(</span><span class=nx>element</span><span class=p>.</span><span class=nx>dropZone</span><span class=p>)</span> <span class=p>{</span>
                <span class=c1>// Bail, since already initialized</span>
                <span class=k>return</span><span class=p>;</span>
            <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
                <span class=c1>// If we had one, and it's gone away, destroy it.  So, we should</span>
                <span class=c1>// only leak one ... it would be even nicer to catch the removal</span>
                <span class=c1>// from the DOM, but that's not entirely straightforward. Or,</span>
                <span class=c1>// perhaps we'd actually avoid any leak if we just didn't keep a</span>
                <span class=c1>// reference? But we necessarily need to keep a reference to the</span>
                <span class=c1>// element.</span>
                <span class=k>if</span> <span class=p>(</span><span class=nx>dropZone</span><span class=p>)</span> <span class=nx>dropZone</span><span class=p>.</span><span class=nx>destroy</span><span class=p>();</span>
            <span class=p>}</span>
        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
            <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>"Could not find dropzone div"</span><span class=p>);</span>
            <span class=k>return</span><span class=p>;</span>
        <span class=p>}</span>

        <span class=nx>dropZone</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Dropzone</span><span class=p>(</span><span class=nx>selector</span><span class=p>,</span> <span class=p>{</span>
            <span class=na>url</span><span class=p>:</span> <span class=s2>"cache-upload/images"</span><span class=p>,</span>
            <span class=na>dictDefaultMessage</span><span class=p>:</span> <span class=s2>"Touch here to take a photo, or drop a photo file here."</span><span class=p>,</span>
            <span class=na>resizeWidth</span><span class=p>:</span> <span class=mi>800</span><span class=p>,</span>
            <span class=na>resizeHeight</span><span class=p>:</span> <span class=mi>800</span><span class=p>,</span>
            <span class=na>resizeMethod</span><span class=p>:</span> <span class=s2>"contain"</span><span class=p>,</span>
            <span class=na>acceptedFiles</span><span class=p>:</span> <span class=s2>"jpg,jpeg,png,gif,image/*"</span>
        <span class=p>});</span>

        <span class=nx>dropZone</span><span class=p>.</span><span class=nx>on</span><span class=p>(</span><span class=s1>'complete'</span><span class=p>,</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>file</span><span class=p>)</span> <span class=p>{</span>
            <span class=c1>// We just send the `file` back into Elm, via the view ... Elm can</span>
            <span class=c1>// decode the file as it pleases.</span>
            <span class=kd>var</span> <span class=nx>event</span> <span class=o>=</span> <span class=nx>makeCustomEvent</span><span class=p>(</span><span class=s2>"dropzonecomplete"</span><span class=p>,</span> <span class=p>{</span>
                <span class=na>file</span><span class=p>:</span> <span class=nx>file</span>
            <span class=p>});</span>

            <span class=nx>element</span><span class=p>.</span><span class=nx>dispatchEvent</span><span class=p>(</span><span class=nx>event</span><span class=p>);</span>

            <span class=nx>dropZone</span><span class=p>.</span><span class=nx>removeFile</span><span class=p>(</span><span class=nx>file</span><span class=p>);</span>
        <span class=p>});</span>
    <span class=p>}</span>

    <span class=kd>function</span> <span class=nx>makeCustomEvent</span> <span class=p>(</span><span class=nx>eventName</span><span class=p>,</span> <span class=nx>detail</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>if</span> <span class=p>(</span><span class=k>typeof</span><span class=p>(</span><span class=nx>CustomEvent</span><span class=p>)</span> <span class=o>===</span> <span class=s1>'function'</span><span class=p>)</span> <span class=p>{</span>
            <span class=k>return</span> <span class=k>new</span> <span class=nx>CustomEvent</span><span class=p>(</span><span class=nx>eventName</span><span class=p>,</span> <span class=p>{</span>
                <span class=na>detail</span><span class=p>:</span> <span class=nx>detail</span><span class=p>,</span>
                <span class=na>bubbles</span><span class=p>:</span> <span class=kc>true</span>
            <span class=p>});</span>
        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
            <span class=kd>var</span> <span class=nx>event</span> <span class=o>=</span> <span class=nb>document</span><span class=p>.</span><span class=nx>createEvent</span><span class=p>(</span><span class=s1>'CustomEvent'</span><span class=p>);</span>
            <span class=nx>event</span><span class=p>.</span><span class=nx>initCustomEvent</span><span class=p>(</span><span class=nx>eventName</span><span class=p>,</span> <span class=kc>true</span><span class=p>,</span> <span class=kc>false</span><span class=p>,</span> <span class=nx>detail</span><span class=p>);</span>
            <span class=k>return</span> <span class=nx>event</span><span class=p>;</span>
        <span class=p>}</span>
    <span class=p>}</span>
</code></pre></div></div><p>So, instead of feeding events back into Elm via ports, we just feed them back in via the DOM. Then, we can listen for them, decode them and handle them in the usual way.</p><div class="ui segments"><div class="ui attached center aligned segment"><div class="ui image"><img src="https://www.gizra.com//assets/images/posts/elm-port-alternatives/dropzone.gif"/></div></div><div class="ui attached center aligned caption segment">DropzoneJS in action inside Elm</div></div><h2 id=plain-old-ports>Plain Old Ports</h2><p>I hope you’ve enjoyed this tour through some alternatives to using ports when you need to communicate between Javascript and Elm. But I should repeat what I said at the beginning. Plain old ports work really well for many situations – these are just some alternatives for certain cases where ports can be a bit awkward.</p></div></div><div class="twelve wide column computer only"><div class="ui borderless secondary menu"><a class=item href="/content/elm-in-drupal-panels/"><i class="chevron left icon"></i> Have Your Cake and Eat it Too: Elm Apps in Drupal Panels</a><div class="right menu"><a class=item href="/content/eat-soup-with-chopsticks/">Eat Soup with Chopsticks - My Journey to Improve my English Speaking. <i class="chevron right icon"></i></a></div></div></div><div class="twelve wide column"><div class="ui segment basic"><div id=disqus_thread></div><script type=text/javascript>var disqus_shortname = 'gizra';
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();</script><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div></div></div></div><footer class="ui black inverted vertical footer segment padded"><div class="ui center aligned container"><div class="ui three column stackable inverted grid"><div class=column><address><div class=strong>Israel Headquarters</div><div>5 Brenner Street, Tel Aviv</div><a class=telephone href=tel:+97233731222>+972-3-3731222</a> // <a class=email href=mailto:info@gizra.com>info@gizra.com</a></address></div><div class="column icons"><a target=_blank href=https://twitter.com/gizra_drupal><i class="twitter huge icon"></i></a> <a target=_blank href=https://github.com/Gizra/gizra.com><i class="github huge icon"></i></a></div><div class=column><address><div class=strong>North America Office</div><div>350 N. Orleans Street, Suite 9000N, Chicago, IL 60654</div><a class=telephone href=tel:+13125857625>312-585-7625</a> // <a class=email href=mailto:usoffice@gizra.com>usoffice@gizra.com</a></address></div></div></div></footer></div><script src=/bower_components/anchor-js/anchor.min.js></script><script src=/assets/javascript/script.js></script></body></html>