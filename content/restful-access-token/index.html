<!DOCTYPE html><html lang=en><head><title>Let’s Talk about Decoupled Authentication</title><meta name=viewport content="width=device-width,initial-scale=1"><meta property=og:site_name content=Gizra><meta property=og:title content="Let’s Talk about Decoupled Authentication"><meta name=description content="Normally in Drupal we don’t need to worry about authentication. This post explains how to handle authentication for decoupled sites with Angular JS."><meta property=og:description content="Normally in Drupal we don’t need to worry about authentication. This post explains how to handle authentication for decoupled sites with Angular JS."><meta name=twitter:card content="summary_large_image"/><meta name=twitter:site content="@gizra_drupal"/><meta property=og:image content=https://www.gizra.com/assets/images/posts/access-token/cookies.jpg><link rel=apple-touch-icon sizes=180x180 href=/assets/favicons/apple-touch-icon-180x180.png><link rel=icon type=image/png href=/assets/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/assets/favicons/favicon-194x194.png sizes=194x194><link rel=icon type=image/png href=/assets/favicons/favicon-96x96.png sizes=96x96><link rel=icon type=image/png href=/assets/favicons/android-chrome-192x192.png sizes=192x192><link rel=icon type=image/png href=/assets/favicons/favicon-16x16.png sizes=16x16><link rel=manifest href=/assets/favicons/manifest.json><meta name=msapplication-TileColor content=#000000><meta name=msapplication-TileImage content=/assets/favicons/mstile-144x144.png><meta name=theme-color content=#ffffff><link href="https://fonts.googleapis.com/css?family=Abril+Fatface&text=gizra" rel=stylesheet><link href="https://fonts.googleapis.com/css?family=Esteban" rel=stylesheet><link href="https://fonts.googleapis.com/css?family=Open+Sans:400,700" rel=stylesheet><link href="https://fonts.googleapis.com/css?family=Montserrat:500,700" rel=stylesheet><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.2.13/semantic.min.css integrity=sha384-370KB8zqOlHxys9dcOyC7aCeXVtGyiKkWkp+cn8Mfoi13/sPj7fvSuhKRRdFbcip crossorigin=anonymous><link rel=stylesheet href="/assets/stylesheets/style.css"/><script src=https://code.jquery.com/jquery-2.2.4.min.js integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.2.13/semantic.min.js integrity=sha384-xfhRYqbW4Asj6UIfXB+Fp7GsmhF9uCf4R+oIGrp7YaBMAmlQWihnvGrW2WbdQRIS crossorigin=anonymous></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-6558346-3', 'auto');
  ga('send', 'pageview');</script></head><body class=pushable><div class="ui sidebar inverted vertical menu left"><a class="item active" href="/">Home</a> <a class=item href=/team>Team</a> <a class=item href=/blog>Blog</a> <a class=item href=/podcast>Podcast</a> <a class=item href=/projects>Projects</a> <a class=item href=/our-story>Our Story</a> <a class=item href=/contact>Contact</a></div><div class=pusher><div class="ui grid container"><header class=row><div class="five wide column menu bar"><div class="ui large secondary menu"><a class="item sidebar-toggle"><i class="big sidebar icon"></i> Menu</a></div></div><div class="six wide computer six wide tablet eleven wide mobile column center aligned"><a class=gizra-logo href="/"><svg version=1.1 width=252 height=104 aria-labelledby="title desc" role=img><title id=title>Gizra Logo</title><desc id=desc>The Gizra Logo</desc><path fill=#E27058 fill-rule=evenodd d="M44.3 21.6c.2 3.5 3 5.4 6 5.4 3.5 0 6.7-2 6.7-7s-3.6-7.7-8.5-7.7c-4.3 0-10.3 2.5-10.3 11 0 1.7.2 3.4.6 5.3-3.4-2-6.5-2.6-11.6-2.6-16 0-22.7 7.6-22.7 17.5 0 8.7 4 13.7 12.2 16-8.2 5-12 7.8-12 13.8C4.7 78 8 83 20.7 83h10c11 0 13.4 2 13.4 7 0 6.7-5.8 11.3-17 11.3s-13.4-4.7-13.4-9c0-1.8.2-3.5 1-5.8l-6.4-3C4.5 84.8.2 87 .2 92c0 6.8 7.5 11.3 25.8 11.3 21.2 0 29.6-8.5 29.6-20 0-14.4-12-17.2-23.8-17.2H21c-5.5 0-6.6-.4-6.6-1.4 0-1 1-2 4.6-4.4 2.2.4 5.4.8 8.5.8C40.3 61 49 55 49 43c0-6.8-4-10.5-8-13.3-.6-2.5-.8-4.6-.8-6.3 0-6.5 3-7 4.5-7 2.2 0 2.8 1.7 2.5 3.4l-3 1.8zM22 41.2C22 29.7 24 28 27 28s4.6 1.4 4.6 13.2v5c0 11-1.8 12.7-4.6 12.7-3.2 0-5-2.3-5-12V41zM62 10c0 4.4 2 9.8 10.6 9.8 7.6 0 10.6-4.3 10.6-10 0-6.3-3.8-9.6-10.4-9.6C65 .2 62 5 62 10zm-5.4 17v2h6.2v46H57v2h31.2v-2h-6V27H56.7zm82.5 0H95l-1.4 20.2H95c4.3-15 8-18.3 22.2-18.3h1L93 75.3V77h44l1.8-21.5h-1.5C133.5 69 127.5 75 115.6 75h-1.4l25-46v-2zm41 3c2.2 0 4.3 1 2.2 5.3h-3.8c-2.2 7.5 1 12 8.2 12 5.6 0 8.8-4 8.8-10 0-8-5-11.3-11.2-11.3-6.3 0-12 3.6-14 11V27H145v2h5.7v46h-5.8v2h32.6v-2h-7.4V47c0-9.5 4.7-17 9.7-17zm40.5 22.3c-15 0-24.2 2.4-24.2 13 0 10.5 8.2 12.8 15.6 12.8 7.2 0 10.3-2.7 12-7.7 1.2 5 6 7.8 14.4 7.8 9 0 13-3.5 13.5-16l-1.7-.2c-.5 8.8-2.3 10.8-4.2 10.8-1.7 0-3-1.2-3-5.5V46c0-15.2-5.5-19.8-22-19.8-14.3 0-22 4-22 13 0 5 2.6 8.6 9 8.6 5.3 0 9.3-3.3 9.3-8.2 0-2-.3-3.4-.8-4.7H214c-.6-1.2-.8-2.2-.8-3 0-3.4 3-4.3 5-4.3 4.2 0 5.3 3.5 5.3 16.8v8h-3zM219 73.8c-2 0-2.7-1-2.7-8.6v-1.6c0-6.4 2-9.6 6.5-9.6h.7v9.8c0 6.7-2.5 10-4.5 10z"/></svg></a><div class=tagline>We Build Websites</div></div><div class="five wide computer only column"></div></header><div class="ui grid centered post"><div class="sixteen wide mobile sixteen wide tablet twelve wide computer column"><div class="ui raised padded segment"><h1 class="ui dividing header"><div class="ui image"><img src=/assets/images/team/avatars/RoySegall.jpg class="ui circular image"></div><div class=content><a href="/content/restful-access-token/">Let’s Talk about Decoupled Authentication</a><div class="sub header">By Roy Segall // 27 Oct 2016</div></div><div class="right floated column"><a href=/blog class="ui teal right ribbon big label">Blog Post</a></div></h1><p>For a traditional Drupal site, we don’t need to handle authentication, because Drupal has our back - a user submits the login form, gets a cookie, and starts using the awesome site. But what about decoupled sites? How can we authenticate the user?</p><p>Before diving into this, we need to understand the authentication types provided by RESTful:</p><ol><li><p>Cookie - Validating the user cookie is not something new for us. We have been doing it for years, and it’s one of the first techniques web developers acquire. But, to validate the request we need to pass a CSRF token. This token helps <a href=https://github.com/RESTful-Drupal/restful/blob/b5f717945081be3f1aa22968f140a3b6d056fea1/src/Plugin/authentication/CookieAuthentication.php#L49>make sure</a> the form was not a fraud. An example could be a form that tweets on the behalf of us on Twitter. The existence of a valid CSRF in the request would make sure an internet scam could not generate the form and upload to Twitter a photo of a cat, when you’re a dog person.</p></li><li><p>Access token - RESTful will generate an access token and bind it to the user. Unlike the cookie which needs a CSRF token to be valid by Restful, we get a two-for-one deal. The existence of the access token in the DB is verified and references us to the user which is represented by that access token.</p></li></ol><p>Important: in order to use access token authentication, you’ll need to enable the module <a href=https://github.com/RESTful-Drupal/restful/tree/7.x-2.x/modules/restful_token_auth>RESTful token authentication</a> (which is a submodule of <a href=https://github.com/RESTful-Drupal/restful>RESTful</a>).</p><h2 id=generating-the-access-token>Generating the access token</h2><p>Below is how an access token is generated using Angular JS. If the authentication process passes, the end point will return an object with 3 values:</p><ol><li><code class=highlighter-rouge>access_token</code> - This is the token which represents the user in any request.</li><li><code class=highlighter-rouge>expires_in</code> - The amount of seconds in which the access token is valid.</li><li><code class=highlighter-rouge>refresh_token</code> - Once the token is no longer valid, you’ll need to ask for a new one using the refresh token.</li></ol><p>You can see below a small amount of Angular JS code:</p><div class="language-javascript highlighter-rouge"><div class=highlight><pre class=highlight><code><span class=nx>$http</span><span class=p>.</span><span class=kd>get</span><span class=p>(</span><span class=s1>'http://localhost/drupal/api/login-token'</span><span class=p>,</span> <span class=p>{</span>
  <span class=na>headers</span><span class=p>:</span> <span class=p>{</span>
    <span class=s1>'Authorization'</span><span class=p>:</span> <span class=s1>'Basic '</span> <span class=o>+</span> <span class=nx>Base64</span><span class=p>.</span><span class=nx>encode</span><span class=p>(</span><span class=nx>username</span> <span class=o>+</span> <span class=s1>':'</span> <span class=o>+</span> <span class=nx>password</span><span class=p>)</span>
  <span class=p>}</span>
<span class=p>})</span>
<span class=p>.</span><span class=nx>success</span><span class=p>(</span><span class=kd>function</span><span class=p>(</span><span class=nx>data</span><span class=p>)</span> <span class=p>{</span>
  <span class=nx>localStorageService</span><span class=p>.</span><span class=kd>set</span><span class=p>(</span><span class=s1>'access_token'</span><span class=p>,</span> <span class=nx>data</span><span class=p>.</span><span class=nx>access_token</span><span class=p>);</span>
<span class=p>});</span>
</code></pre></div></div><p>And this is what you’ll get back:</p><div class="language-json highlighter-rouge"><div class=highlight><pre class=highlight><code><span class=p>{</span><span class=w>
  </span><span class=s2>"access_token"</span><span class=p>:</span><span class=w> </span><span class=s2>"Y3wQua-qFY-mukslgPaLqKdNmlGdBQK4dly-UhlJcYk"</span><span class=p>,</span><span class=w>
  </span><span class=s2>"type"</span><span class=p>:</span><span class=w> </span><span class=s2>"Bearer"</span><span class=p>,</span><span class=w>
  </span><span class=s2>"expires_in"</span><span class=p>:</span><span class=w> </span><span class=mi>86400</span><span class=p>,</span><span class=w>
  </span><span class=s2>"refresh_token"</span><span class=p>:</span><span class=w> </span><span class=s2>"xRP-nnKA05GGsN-jr80Z_hfPHqrkpyjAtevDSeTLbYU"</span><span class=w>
</span><span class=p>}</span><span class=w>
</span></code></pre></div></div><h2 id=refreshing-an-access-token>Refreshing an access token</h2><p>As mentioned above, the access token is only valid for a specific amount of time, usually 24 hours, so you’ll need to check it before the request:</p><div class="language-javascript highlighter-rouge"><div class=highlight><pre class=highlight><code><span class=k>if</span> <span class=p>(</span><span class=k>new</span> <span class=nb>Date</span><span class=p>().</span><span class=nx>getTime</span><span class=p>()</span> <span class=o>&gt;</span> <span class=nx>localStorageService</span><span class=p>.</span><span class=kd>get</span><span class=p>(</span><span class=s1>'expire_in'</span><span class=p>))</span> <span class=p>{</span>
  <span class=kd>var</span> <span class=nx>refresh_token</span> <span class=o>=</span> <span class=nx>localStorageService</span><span class=p>.</span><span class=kd>get</span><span class=p>(</span><span class=s1>'refresh_token'</span><span class=p>);</span>
  <span class=nx>$http</span><span class=p>.</span><span class=kd>get</span><span class=p>(</span><span class=s1>'http://localhost/drupal/refresh-token/'</span> <span class=o>+</span> <span class=nx>refresh_token</span><span class=p>)</span>
  <span class=p>.</span><span class=nx>success</span><span class=p>(</span><span class=kd>function</span><span class=p>(</span><span class=nx>data</span><span class=p>)</span> <span class=p>{</span>
    <span class=nx>localStorageService</span><span class=p>.</span><span class=kd>set</span><span class=p>(</span><span class=s1>'access_token'</span><span class=p>,</span> <span class=nx>data</span><span class=p>.</span><span class=nx>access_token</span><span class=p>);</span>
    <span class=nx>localStorageService</span><span class=p>.</span><span class=kd>set</span><span class=p>(</span><span class=s1>'refresh_token'</span><span class=p>,</span> <span class=nx>data</span><span class=p>.</span><span class=nx>refresh_token</span><span class=p>);</span>
    <span class=nx>localStorageService</span><span class=p>.</span><span class=kd>set</span><span class=p>(</span><span class=s1>'expire_in'</span><span class=p>,</span> <span class=k>new</span> <span class=nb>Date</span><span class=p>().</span><span class=nx>getTime</span><span class=p>()</span> <span class=o>+</span> <span class=nx>data</span><span class=p>.</span><span class=nx>expires_in</span><span class=p>);</span>
  <span class=p>});</span>
<span class=p>}</span>
</code></pre></div></div><h2 id=using-the-access-token>Using the access token</h2><p>OK, so we got the access token and we can refresh it when it’s no longer valid. The next thing you need to know is how to inject the access token into the header:</p><div class="language-javascript highlighter-rouge"><div class=highlight><pre class=highlight><code><span class=nx>$http</span><span class=p>.</span><span class=nx>post</span><span class=p>(</span><span class=s1>'http://localhost/drupal/api/article'</span><span class=p>,</span> <span class=p>{</span>
  <span class=na>headers</span><span class=p>:</span> <span class=p>{</span>
    <span class=s1>'access-token'</span><span class=p>:</span> <span class=nx>localStorageService</span><span class=p>.</span><span class=kd>get</span><span class=p>(</span><span class=s1>'access_token'</span><span class=p>)</span>
  <span class=p>},</span>
  <span class=na>data</span><span class=p>:</span> <span class=p>{</span>
    <span class=s1>'label'</span><span class=p>:</span> <span class=s1>'foo'</span>
  <span class=p>}</span>
<span class=p>})</span>
<span class=p>.</span><span class=nx>success</span><span class=p>(</span><span class=kd>function</span><span class=p>(</span><span class=nx>data</span><span class=p>)</span> <span class=p>{</span>
  <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>'Cool! You posted a new article.'</span><span class=p>);</span>
<span class=p>});</span>
</code></pre></div></div><p>You can have a look at our <a href=https://github.com/Gizra/generator-hedley>yo hedley</a> generator to see how we <a href=https://github.com/Gizra/generator-hedley/blob/38cf1b88da79469379ab66c0d219dcde9ab763e2/app/templates/client/app/scripts/app.js#L162>implemented</a> HTTP interceptor to improve the process displayed above.</p></div></div><div class="twelve wide column computer only"><div class="ui borderless secondary menu"><a class=item href="/content/thoughts-about-training/"><i class="chevron left icon"></i> Play Rugby in the meeting room? Thoughts about employee training program</a><div class="right menu"><a class=item href="/content/elm-business-perspective/">Elm from a Business Perspective <i class="chevron right icon"></i></a></div></div></div><div class="twelve wide column"><div class="ui segment basic"><div id=disqus_thread></div><script type=text/javascript>var disqus_shortname = 'gizra';
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();</script><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div></div></div></div><footer class="ui black inverted vertical footer segment padded"><div class="ui center aligned container"><div class="ui three column stackable inverted grid"><div class=column><address><div class=strong>Israel Headquarters</div><div>5 Brenner Street, Tel Aviv</div><a class=telephone href=tel:+97233731222>+972-3-3731222</a> // <a class=email href=mailto:info@gizra.com>info@gizra.com</a></address></div><div class="column icons"><a target=_blank href=https://twitter.com/gizra_drupal><i class="twitter huge icon"></i></a> <a target=_blank href=https://github.com/Gizra/gizra.com><i class="github huge icon"></i></a></div><div class=column><address><div class=strong>North America Office</div><div>350 N. Orleans Street, Suite 9000N, Chicago, IL 60654</div><a class=telephone href=tel:+13125857625>312-585-7625</a> // <a class=email href=mailto:usoffice@gizra.com>usoffice@gizra.com</a></address></div></div></div></footer></div><script src=/bower_components/anchor-js/anchor.min.js></script><script src=/assets/javascript/script.js></script></body></html>