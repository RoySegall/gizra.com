<!DOCTYPE html><html><head><title>User points - Rules style</title><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta property=og:site_name content=Gizra><meta property=og:title content="User points - Rules style"><meta name=description content="Gizra is a web strategy, design, and
  development agency with an extensive track record in complex content
  management solutions in Drupal and Elm."><meta property=og:description content=""><meta name=twitter:card content="summary_large_image"/><meta name=twitter:site content="@gizra_drupal"/><meta property=og:image content=https://www.gizra.com/assets/images/homepage/gizra-logo-site.jpg><link rel=apple-touch-icon sizes=180x180 href=/assets/favicons/apple-touch-icon-180x180.png><link rel=icon type=image/png href=/assets/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/assets/favicons/favicon-194x194.png sizes=194x194><link rel=icon type=image/png href=/assets/favicons/favicon-96x96.png sizes=96x96><link rel=icon type=image/png href=/assets/favicons/android-chrome-192x192.png sizes=192x192><link rel=icon type=image/png href=/assets/favicons/favicon-16x16.png sizes=16x16><link rel=manifest href=/assets/favicons/manifest.json><meta name=msapplication-TileColor content=#000000><meta name=msapplication-TileImage content=/assets/favicons/mstile-144x144.png><meta name=theme-color content=#ffffff><link href="https://fonts.googleapis.com/css?family=Abril+Fatface&text=gizra" rel=stylesheet><link href="https://fonts.googleapis.com/css?family=Esteban" rel=stylesheet><link href="https://fonts.googleapis.com/css?family=Open+Sans:400,700" rel=stylesheet><link href="https://fonts.googleapis.com/css?family=Montserrat:500,700" rel=stylesheet><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.2.13/semantic.min.css integrity=sha384-370KB8zqOlHxys9dcOyC7aCeXVtGyiKkWkp+cn8Mfoi13/sPj7fvSuhKRRdFbcip crossorigin=anonymous><link rel=stylesheet href="/assets/stylesheets/style.css"/><script src=https://code.jquery.com/jquery-2.2.4.min.js integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.2.13/semantic.min.js integrity=sha384-xfhRYqbW4Asj6UIfXB+Fp7GsmhF9uCf4R+oIGrp7YaBMAmlQWihnvGrW2WbdQRIS crossorigin=anonymous></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-6558346-3', 'auto');
  ga('send', 'pageview');</script></head><body class=pushable><div class="ui sidebar inverted vertical menu left"><a class="item active" href="/">Home</a> <a class=item href=/team>Team</a> <a class=item href=/blog>Blog</a> <a class=item href=/podcast>Podcast</a> <a class=item href=/projects>Projects</a> <a class=item href=/our-story>Our Story</a> <a class=item href=/contact>Contact</a></div><div class=pusher><div class="ui grid container"><header class=row><div class="five wide column menu bar"><div class="ui large secondary menu"><a class="item sidebar-toggle"><i class="big sidebar icon"></i> Menu</a></div></div><div class="six wide computer six wide tablet eleven wide mobile column center aligned"><a class=gizra-logo href="/"><svg version=1.1 width=252 height=104 aria-labelledby="title desc" role=img><title id=title>Gizra Logo</title><desc id=desc>The Gizra Logo</desc><path fill=#E27058 fill-rule=evenodd d="M44.3 21.6c.2 3.5 3 5.4 6 5.4 3.5 0 6.7-2 6.7-7s-3.6-7.7-8.5-7.7c-4.3 0-10.3 2.5-10.3 11 0 1.7.2 3.4.6 5.3-3.4-2-6.5-2.6-11.6-2.6-16 0-22.7 7.6-22.7 17.5 0 8.7 4 13.7 12.2 16-8.2 5-12 7.8-12 13.8C4.7 78 8 83 20.7 83h10c11 0 13.4 2 13.4 7 0 6.7-5.8 11.3-17 11.3s-13.4-4.7-13.4-9c0-1.8.2-3.5 1-5.8l-6.4-3C4.5 84.8.2 87 .2 92c0 6.8 7.5 11.3 25.8 11.3 21.2 0 29.6-8.5 29.6-20 0-14.4-12-17.2-23.8-17.2H21c-5.5 0-6.6-.4-6.6-1.4 0-1 1-2 4.6-4.4 2.2.4 5.4.8 8.5.8C40.3 61 49 55 49 43c0-6.8-4-10.5-8-13.3-.6-2.5-.8-4.6-.8-6.3 0-6.5 3-7 4.5-7 2.2 0 2.8 1.7 2.5 3.4l-3 1.8zM22 41.2C22 29.7 24 28 27 28s4.6 1.4 4.6 13.2v5c0 11-1.8 12.7-4.6 12.7-3.2 0-5-2.3-5-12V41zM62 10c0 4.4 2 9.8 10.6 9.8 7.6 0 10.6-4.3 10.6-10 0-6.3-3.8-9.6-10.4-9.6C65 .2 62 5 62 10zm-5.4 17v2h6.2v46H57v2h31.2v-2h-6V27H56.7zm82.5 0H95l-1.4 20.2H95c4.3-15 8-18.3 22.2-18.3h1L93 75.3V77h44l1.8-21.5h-1.5C133.5 69 127.5 75 115.6 75h-1.4l25-46v-2zm41 3c2.2 0 4.3 1 2.2 5.3h-3.8c-2.2 7.5 1 12 8.2 12 5.6 0 8.8-4 8.8-10 0-8-5-11.3-11.2-11.3-6.3 0-12 3.6-14 11V27H145v2h5.7v46h-5.8v2h32.6v-2h-7.4V47c0-9.5 4.7-17 9.7-17zm40.5 22.3c-15 0-24.2 2.4-24.2 13 0 10.5 8.2 12.8 15.6 12.8 7.2 0 10.3-2.7 12-7.7 1.2 5 6 7.8 14.4 7.8 9 0 13-3.5 13.5-16l-1.7-.2c-.5 8.8-2.3 10.8-4.2 10.8-1.7 0-3-1.2-3-5.5V46c0-15.2-5.5-19.8-22-19.8-14.3 0-22 4-22 13 0 5 2.6 8.6 9 8.6 5.3 0 9.3-3.3 9.3-8.2 0-2-.3-3.4-.8-4.7H214c-.6-1.2-.8-2.2-.8-3 0-3.4 3-4.3 5-4.3 4.2 0 5.3 3.5 5.3 16.8v8h-3zM219 73.8c-2 0-2.7-1-2.7-8.6v-1.6c0-6.4 2-9.6 6.5-9.6h.7v9.8c0 6.7-2.5 10-4.5 10z"/></svg></a><div class=tagline>We Build Websites</div></div><div class="five wide computer only column"></div></header><div class="ui grid centered post"><div class="sixteen wide mobile sixteen wide tablet twelve wide computer column"><div class="ui raised padded segment"><h1 class="ui dividing header"><div class="ui image"><img src=/assets/images/team/avatars/amitaibu.jpg class="ui circular image"></div><div class=content><a href="/content/user-points-rules-style/">User points - Rules style</a><div class="sub header">By Amitai Burstein (@amitaibu) // 14 Jan 2010</div></div><div class="right floated column"><a href=/blog class="ui teal right ribbon big label">Blog Post</a></div></h1><p><a href=http://www.nicklewis.org/40-essential-drupal-6-modules>Nick Lewis</a> wrote about his 40+ essential modules, and I really missed two modules there - Rules and Flag. I commented that</p><blockquote>My top 5 are: Views, CCK, Flag, Rules, Panels. I think that the Flag &amp; Rules combo is less known in the community, but there are so many use cases they can cover. Because they are a bit abstracted it's hard for newbies to realize their potential.</blockquote><p>I think there’s no better way to show my point, than a tutorial. Lazy people can even download the feature from <a href=/sites/default/files/user_points_rules.tar_.gz>here</a>. This tutorial will be about having “User points” functionality without using the user points module. I’m not saying that module is bad, but sometimes I need multiple user points per user. Also, re-using existing modules always feels me with great joy. GREAT joy! Also, thinking about Drupal 7 with fields API, suddenly _user points can become _any-fieldable-entity points… The tutorial will cover the “Rule sets” concept in Rules module, which is also considered by many as a great mystery. Let’s define our mission:</p><ol><li>Every time a user creates a story content type, one point is deducted</li><li>When no points are left, user should not be able to create more stories</li><li>Upon content profile creation, the user receives three points</li><li>Site admin should be able to "reset" the points of users back to three points</li></ol><p>If your eyes no longer see the above list as words, but as Drupal modules, then you probably think CCK, Content profile, Rules and Flag. We will add a content profile to each user. That profile will have a CCK field that will hold the user points. When user points reach zero, a “story editor” role will be removed from the user - denying access to creating new story content. For “reseting” the user points, we will use a flag on the user, that a site admin can click on. First preparations:</p><ol><li>Download and enable modules (is there still anybody not using Drush?) ``` drush dl cck content_profile rules flag-6.x-2.x-dev features ctools strongarm-6.x-2.0-beta3 drush en -y content number content_permissions content_profile rules rules_admin flag features php ctools strongarm ```</li><li>Make the new "Profile" content type a user profile through _admin/content/node-type/profile &gt;&gt; Content Profile &gt;&gt; Use this content type as a content profile for users</li><li>Add a new Integer type field called _field_user_points to the profile content type</li><li>In _admin/user/roles add a new role called "story editor".</li><li>We should carefully take care of the permissions. In _admin/user/permissions - allow "authenticated user" role to _view field_user_points and _create profile content; and allow "story editor" role to _create story content</li></ol><p>Before we set up our logic using Rules Let’s go over a bit about the concept of “Rule sets”. You should think of a rule sets as an API function. That function gets arguments and processes them. It’s up to an implementing module to use the API function properly. Like API functions rule sets are there in order to prevent duplication and to centralize actions. Let’s make the idea clear by thinking about points 1 and 2 in our mission. We have here two rules - one will deduct points from the user’s profile, and the other should remove the “story editor” role.</p><p>We could create two triggered rules both with the event “After saving new content”, and check in both rules that the content type is story. As you can see, there’s a duplication in the event and in the conditions. If our logic will change and be more complex the duplication might increase.</p><p>So, for such a case we will use the rule sets. We’ll define two arguments that are mandatory one is a node, in which we’ll pass the content profile. The other is the user. If you are a developer then think of it as _function user_points_logic($profile_content, $account).</p><p>In this rule sets we will add our two rules without even bothering to check if the new created content is indeed “story”. For that we’ll have a third rule, that will not be a rule inside a rule sets, but a triggered rule. This rule will be executed “After saving new content”, will check the condition of the content type is story, and then willload the user’s profile content and invoke our rule sets.</p><p>In terms of code, think of it as calling _user_points_logic() from _hook_nodeapi() upon node insert. Now that the concept should be clear, let’s see how we do it:</p><ol><li>Make sure you enabled the "PHP filter" core module, as we'll need few lines of PHP</li><li>Add a new rule sets (_admin/rules/rule_sets) labeled "User points" with _content and _user arguments.</li><li>Add a new rule in the "User points" rule sets labeled "Deduct points on story creation" and add the action _Populate a field, select the field _field_user_points and continue</li><li>Under "Advanced: Specify the fields value with PHP code" enter the following code (without the ```<?php ?>``` delimiters): ```php<?php // Current user points. $current_points = $profile_node->field_user_points[0]['value']; // Remove one point. return array( // Rules will make sure the content profile is saved // after all rules have finished executing. 0 => array('value' => ($current_points - 1)), ); ?>```</li><li>Create the second rule in the rule sets labeled "Remove role when no user points left" with the condition _Field has value, and again select _field_user_points. In the field value enter 0</li><li>Add action _Remove user role and select "story editor" role</li><li>Points 1 and 2 in our mission are almost complete, we only need to call the rule sets when appropriate. Create a triggered rule (_admin/rules/trigger) labeled "Invoke user points" with the event _After saving new content (we don't want to deduct point when user is just updating an existing content). Add condition _Content has type to check it's a story. Add action _Load content profile and make sure the argument _User, whose profile should be loaded is set to _content's author - we do that as the _acting user might be an admin manually creating a new user. Second action is _User points which is our rule sets. Also here make sure you pass the correct arguments (i.e. _content profile for the content argument and _content's author for the user argument).</li></ol><p>The implementation of “reset” points and grant points on user registration is similar in concept to our previous mission. We create a rule sets labeled “User points grant” which will set the field value to 3 and grant “story editor” role. This rule sets will be called from two different triggered rules - once upon content profile creation, and second when a site admin will “reset” the user points. How will the site admin “reset”? Easily - we’ll create a new user type flag called “Reset user points”, and in Rules create a triggered rule that is invoked on the event _A user has been flagged, under “Reset user points”.</p><p>That’s it. Download the <a href=/sites/default/files/user_points_rules.tar_.gz>feature</a>, and add your own logic.</p><p>– Notice if you download the modules manually to use Flag module with version 6.x-2.x or higher and strongarm version 6.x-2.x or higher.</p></div></div><div class="twelve wide column computer only"><div class="ui borderless secondary menu"><a class=item href="/content/organic-groups-7/"><i class="chevron left icon"></i> Organic groups 7!</a><div class="right menu"><a class=item href="/content/thinking-grid-960/">Thinking 960 <i class="chevron right icon"></i></a></div></div></div><div class="twelve wide column"><div class="ui segment basic"><div id=disqus_thread></div><script type=text/javascript>var disqus_shortname = 'gizra';
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();</script><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div></div></div></div><footer class="ui black inverted vertical footer segment padded"><div class="ui center aligned container"><div class="ui three column stackable inverted grid"><div class=column><address><div class=strong>Israel Headquarters</div><div>5 Brenner Street, Tel Aviv</div><a class=telephone href=tel:+97233731222>+972-3-3731222</a> // <a class=email href=mailto:info@gizra.com>info@gizra.com</a></address></div><div class="column icons"><a target=_blank href=https://twitter.com/gizra_drupal><i class="twitter huge icon"></i></a> <a target=_blank href=https://github.com/Gizra/gizra.com><i class="github huge icon"></i></a></div><div class=column><address><div class=strong>North America Office</div><div>350 N. Orleans Street, Suite 9000N, Chicago, IL 60654</div><a class=telephone href=tel:+13125857625>312-585-7625</a> // <a class=email href=mailto:usoffice@gizra.com>usoffice@gizra.com</a></address></div></div></div></footer></div><script src=/bower_components/anchor-js/anchor.min.js></script><script src=/assets/javascript/script.js></script></body></html>