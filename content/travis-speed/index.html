<!DOCTYPE html><html><head><title>Travis - The Need for Speed</title><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta property=og:site_name content=Gizra><meta property=og:title content="Travis - The Need for Speed"><meta name=description content="In continuous integration, every second matters - and can even save a hasty merge. Explore ways to fine-tune Travis so that it hums along for your team."><meta property=og:description content="In continuous integration, every second matters - and can even save a hasty merge. Explore ways to fine-tune Travis so that it hums along for your team."><meta name=twitter:card content="summary_large_image"/><meta name=twitter:site content="@gizra_drupal"/><meta property=og:image content=https://www.gizra.com/assets/images/posts/travis-speed/thumb.jpg><link rel=apple-touch-icon sizes=180x180 href=/assets/favicons/apple-touch-icon-180x180.png><link rel=icon type=image/png href=/assets/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/assets/favicons/favicon-194x194.png sizes=194x194><link rel=icon type=image/png href=/assets/favicons/favicon-96x96.png sizes=96x96><link rel=icon type=image/png href=/assets/favicons/android-chrome-192x192.png sizes=192x192><link rel=icon type=image/png href=/assets/favicons/favicon-16x16.png sizes=16x16><link rel=manifest href=/assets/favicons/manifest.json><meta name=msapplication-TileColor content=#000000><meta name=msapplication-TileImage content=/assets/favicons/mstile-144x144.png><meta name=theme-color content=#ffffff><link href="https://fonts.googleapis.com/css?family=Abril+Fatface&text=gizra" rel=stylesheet><link href="https://fonts.googleapis.com/css?family=Esteban" rel=stylesheet><link href="https://fonts.googleapis.com/css?family=Open+Sans:400,700" rel=stylesheet><link href="https://fonts.googleapis.com/css?family=Montserrat:500,700" rel=stylesheet><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.2.13/semantic.min.css integrity=sha384-370KB8zqOlHxys9dcOyC7aCeXVtGyiKkWkp+cn8Mfoi13/sPj7fvSuhKRRdFbcip crossorigin=anonymous><link rel=stylesheet href="/assets/stylesheets/style.css"/><script src=https://code.jquery.com/jquery-2.2.4.min.js integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.2.13/semantic.min.js integrity=sha384-xfhRYqbW4Asj6UIfXB+Fp7GsmhF9uCf4R+oIGrp7YaBMAmlQWihnvGrW2WbdQRIS crossorigin=anonymous></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-6558346-3', 'auto');
  ga('send', 'pageview');</script></head><body class=pushable><div class="ui sidebar inverted vertical menu left"><a class="item active" href="/">Home</a> <a class=item href=/team>Team</a> <a class=item href=/blog>Blog</a> <a class=item href=/podcast>Podcast</a> <a class=item href=/projects>Projects</a> <a class=item href=/our-story>Our Story</a> <a class=item href=/contact>Contact</a></div><div class=pusher><div class="ui grid container"><header class=row><div class="five wide column menu bar"><div class="ui large secondary menu"><a class="item sidebar-toggle"><i class="big sidebar icon"></i> Menu</a></div></div><div class="six wide computer six wide tablet eleven wide mobile column center aligned"><a class=gizra-logo href="/"><svg version=1.1 width=252 height=104 aria-labelledby="title desc" role=img><title id=title>Gizra Logo</title><desc id=desc>The Gizra Logo</desc><path fill=#E27058 fill-rule=evenodd d="M44.3 21.6c.2 3.5 3 5.4 6 5.4 3.5 0 6.7-2 6.7-7s-3.6-7.7-8.5-7.7c-4.3 0-10.3 2.5-10.3 11 0 1.7.2 3.4.6 5.3-3.4-2-6.5-2.6-11.6-2.6-16 0-22.7 7.6-22.7 17.5 0 8.7 4 13.7 12.2 16-8.2 5-12 7.8-12 13.8C4.7 78 8 83 20.7 83h10c11 0 13.4 2 13.4 7 0 6.7-5.8 11.3-17 11.3s-13.4-4.7-13.4-9c0-1.8.2-3.5 1-5.8l-6.4-3C4.5 84.8.2 87 .2 92c0 6.8 7.5 11.3 25.8 11.3 21.2 0 29.6-8.5 29.6-20 0-14.4-12-17.2-23.8-17.2H21c-5.5 0-6.6-.4-6.6-1.4 0-1 1-2 4.6-4.4 2.2.4 5.4.8 8.5.8C40.3 61 49 55 49 43c0-6.8-4-10.5-8-13.3-.6-2.5-.8-4.6-.8-6.3 0-6.5 3-7 4.5-7 2.2 0 2.8 1.7 2.5 3.4l-3 1.8zM22 41.2C22 29.7 24 28 27 28s4.6 1.4 4.6 13.2v5c0 11-1.8 12.7-4.6 12.7-3.2 0-5-2.3-5-12V41zM62 10c0 4.4 2 9.8 10.6 9.8 7.6 0 10.6-4.3 10.6-10 0-6.3-3.8-9.6-10.4-9.6C65 .2 62 5 62 10zm-5.4 17v2h6.2v46H57v2h31.2v-2h-6V27H56.7zm82.5 0H95l-1.4 20.2H95c4.3-15 8-18.3 22.2-18.3h1L93 75.3V77h44l1.8-21.5h-1.5C133.5 69 127.5 75 115.6 75h-1.4l25-46v-2zm41 3c2.2 0 4.3 1 2.2 5.3h-3.8c-2.2 7.5 1 12 8.2 12 5.6 0 8.8-4 8.8-10 0-8-5-11.3-11.2-11.3-6.3 0-12 3.6-14 11V27H145v2h5.7v46h-5.8v2h32.6v-2h-7.4V47c0-9.5 4.7-17 9.7-17zm40.5 22.3c-15 0-24.2 2.4-24.2 13 0 10.5 8.2 12.8 15.6 12.8 7.2 0 10.3-2.7 12-7.7 1.2 5 6 7.8 14.4 7.8 9 0 13-3.5 13.5-16l-1.7-.2c-.5 8.8-2.3 10.8-4.2 10.8-1.7 0-3-1.2-3-5.5V46c0-15.2-5.5-19.8-22-19.8-14.3 0-22 4-22 13 0 5 2.6 8.6 9 8.6 5.3 0 9.3-3.3 9.3-8.2 0-2-.3-3.4-.8-4.7H214c-.6-1.2-.8-2.2-.8-3 0-3.4 3-4.3 5-4.3 4.2 0 5.3 3.5 5.3 16.8v8h-3zM219 73.8c-2 0-2.7-1-2.7-8.6v-1.6c0-6.4 2-9.6 6.5-9.6h.7v9.8c0 6.7-2.5 10-4.5 10z"/></svg></a><div class=tagline>We Build Websites</div></div><div class="five wide computer only column"></div></header><div class="ui grid centered post"><div class="sixteen wide mobile sixteen wide tablet twelve wide computer column"><div class="ui raised padded segment"><h1 class="ui dividing header"><div class="ui image"><img src=/assets/images/team/avatars/AronNovak.jpg class="ui circular image"></div><div class=content><a href="/content/travis-speed/">Travis - The Need for Speed</a><div class="sub header">By Áron Novák // 16 Feb 2018</div></div><div class="right floated column"><a href=/blog class="ui teal right ribbon big label">Blog Post</a></div></h1><p>Chances are that you already use Travis or another cool CI to execute your tests, and everyone politely waits for the CI checks before even thinking about merging, right? More likely, waiting your turn becomes a pain and you click on the merge: it’s a trivial change and you need it now. If this happens often, then it’s the responsibility of those who worked on those scripts that Travis crunches to make some changes. There are some trivial and not so trivial options to make the team always be willing to wait for the completion.</p><p>This blog post is for you if you have a project with Travis integration, and you’d like to maintain and optimize it, or just curious what’s possible. Users of other CI tools, keep reading, many areas may apply in your case too.</p><p>Unlike other performance optimization areas, doing before-after benchmarks is not so crucial, as Travis mostly collects the data, you just have to make sure to do the math and <a href=https://github.com/Gizra/drupal-elm-starter/pull/171#issuecomment-334493419>present the numbers proudly</a>.</p><h2 id=caching>Caching</h2><p>To start, if your <code class=highlighter-rouge>.travis.yml</code> lacks the <code class=highlighter-rouge>cache:</code> directive, then you might start in the easiest place: caching dependencies. For a Drupal-based project, it’s a good idea to think about caching all the modules and libraries that must be downloaded to build the project (it uses a buildsystem, doesn’t it?). So even a variant of:</p><div class="language-yml highlighter-rouge"><div class=highlight><pre class=highlight><code><span class=na>cache</span><span class=pi>:</span>
  <span class=na>directories</span><span class=pi>:</span>
    <span class=pi>-</span> <span class=s>$HOME/.composer/cache/files</span>
</code></pre></div></div><p>or for Drush</p><div class="language-yml highlighter-rouge"><div class=highlight><pre class=highlight><code><span class=na>cache</span><span class=pi>:</span>
  <span class=na>directories</span><span class=pi>:</span>
    <span class=pi>-</span> <span class=s>$HOME/.drush/cache</span>
</code></pre></div></div><p>It’s explained well in the verbose <a href=https://docs.travis-ci.com/user/caching>documentation</a> at Travis-ci.com. Before your script is executed, Travis populates the cache directories automatically from a successful previous build. If your project has only a few packages, it won’t help much, and actually it can make things even slower. What’s critical is that we need to cache slow-to-generate, easy-to-download materials. Caching a large ZIP file would not make sense for example, caching many small ones from multiple origin servers would be more beneficial.</p><p>From this point, you could just read the standard documentation instead of this blog post, but we also have icing on the cake for you. A Drupal installation can take several minutes, initializing all the modules, executing the logic of the install profile and so on. Travis is kind enough to provide a bird’s-eye view on what eats up build time:</p><div class="ui segments"><div class="ui attached center aligned segment"><div class="ui image"><img src="https://www.gizra.com/assets/images/posts/travis-speed/travis-benchmark.png"/></div></div><div class="ui attached center aligned caption segment">Execution speed measurements built in the log</div></div><p>Mind the bottleneck when making a decision on what to cache and how.</p><p>For us, it means cache of the installed, initialized Drupal database and the full document root. Cache invalidation is hard, we can’t change that, but it turned out to be a good compromise between complexity and execution speed gain, check our examples:</p><ul><li><a href=https://github.com/Gizra/drupal-elm-starter/blob/master/ci-scripts/pre_cache.sh><code class=highlighter-rouge>pre_cache.sh</code></a></li><li><a href=https://github.com/Gizra/drupal-elm-starter/blob/master/ci-scripts/post_cache.sh><code class=highlighter-rouge>post_cache.sh</code></a></li></ul><p>Do your homework and cache what’s the most resource-consuming to generate, SQL database, built source code or compiled binary, Travis is here to assist with that.</p><h2 id=software-versions>Software Versions</h2><p>There are two reasons to pay attention to software versions.</p><h3 id=use-pre-installed-versions>Use Pre-installed Versions</h3><p>Travis uses containers of different distributions, let’s say you use <code class=highlighter-rouge>trusty</code>, the default one these days, then if you choose PHP 7.0.7, it’s <a href=https://docs.travis-ci.com/user/reference/trusty/#PHP-images>pre-installled</a>, in case of 7.1, it’s needed to fetch separately and that takes time for every single build. When you have production constraints, that’s almost certainly more important to match, but in some cases, using the pre-installed version can speed things up.</p><p>And moreover, let’s say you prefer <a href=https://docs.travis-ci.com/user/database-setup/#MariaDB>MariaDB</a> over MySQL, then do not <code class=highlighter-rouge>sudo</code> and start to install it with the package manager, as there is the add-on system to make it available. The same goes for <a href=https://docs.travis-ci.com/user/chrome>Google Chrome</a>, and so on. Stick to what’s inside the image already if you can. Exploit that possibility of what Travis can fetch via the YML definition!</p><h3 id=use-the-latest-and-or-greatest>Use the Latest and (or) Greatest</h3><p>If you ever read an article about the performance gain from migrating to PHP 7, you sense the importance of selecting the versions carefully. If your build is PHP-execution heavy, fetching PHP 7.2 (it’s another leap, but mind the <a href=http://php.net/manual/en/migration72.incompatible.php>backward incompatibilities</a>) could totally make sense and it’s as easy as can be after making your code compatible:</p><div class="language-yml highlighter-rouge"><div class=highlight><pre class=highlight><code><span class=na>language</span><span class=pi>:</span> <span class=s>php</span>
<span class=na>php</span><span class=pi>:</span>
  <span class=pi>-</span> <span class=s1>'</span><span class=s>7.2'</span>
</code></pre></div></div><p>Almost certainly, a similar thing could be written about Node.js, or relational databases, etc. If you know what’s the bottleneck in your build and find the best performing versions – newer or older – it will improve your speed. Does that conflict with the previous point about pre-installed versions? Not really, just measure which one helps your build the most!</p><h2 id=make-it-parallel>Make it Parallel</h2><p>When a Travis job is running, 2 cores and 4 GBytes of RAM is <a href=https://docs.travis-ci.com/user/reference/overview/#Virtualization-environments>available</a> – that’s something to rely on! Downloading packages should happen in parallel. <code class=highlighter-rouge>drush make</code>, <code class=highlighter-rouge>gulp</code> and other tools like that might use it out of the box: check your parameters and configfiles. However, on the higher level, let’s say you’d like to execute a unit test and a browser-based test, as well. You can ask Travis to spin up two (or more) containers concurrently. In the first, you can install the unit testing dependencies and execute it; then the second one can take care of only the functional test. We have a fine-grained example of this approach in our <a href=https://github.com/Gizra/drupal-elm-starter/blob/master/.travis.yml#L10>Drupal-Elm Starter</a>, where 7 containers are used for various testing and linting. In addition to the great execution speed reduction, the benefit is that the result is also more fine-grained, instead of having a single boolean value, just by checking the build, you have an overview what can be broken.</p><p>All in all, it’s a warm fuzzy feeling that Travis is happy to create so many containers for your humble project:</p><div class="ui segments"><div class="ui attached center aligned segment"><div class="ui image"><img src="https://www.gizra.com/assets/images/posts/travis-speed/parallel.gif"/></div></div><div class="ui attached center aligned caption segment">If it's independent, no need to serialize the execution</div></div><h2 id=utilize-ram>Utilize RAM</h2><p>The available memory is currently between 4 and 7.5 GBytes , depending on the configuration, and it should be used as much as possible. One example could be to move the database main working directory to a memory-based filesystem. For many simpler projects, that’s absolutely doable and at least for Drupal, a solid speedup. Needless to say, we have an <a href=https://github.com/Gizra/drupal-elm-starter/blob/master/ci-scripts/install_server.sh#L13>example</a> and on client projects, we saw 15-30% improvement at SimpleTest execution. For traditional RMDBS, you can give it a try. If your DB cannot fit in memory, you can still ask <a href="https://www.percona.com/blog/2013/09/20/innodb-performance-optimization-basics-updated/">InnoDB to fill memory</a>.</p><p>Think about your use case – even moving the whole document root there could be legitimate. Also if you need to compile a source code, doing it there makes sense as well.</p><h2 id=build-your-own-docker-image>Build Your Own Docker Image</h2><p>If your project is really exotic or a legacy one, it potentially makes sense to maintain your own Docker image and then download and execute it in Travis. We did it in the past and then <a href=https://github.com/Gizra/drupal-elm-starter/pull/165/files>converted</a>. Maintaining your image means recurring effort, fighting with outdated versions, unavailable dependencies, that’s what to expect. Still, even it could be a type of performance optimization if you have lots of software dependencies that are hard to install on the current Travis container images.</p><h2 id=1---debug-with-ease>+1 - Debug with Ease</h2><p>To work on various improvements in the Travis integration for your projects, it’s a <em>must</em> to spot issues quickly. What worked on localhost, might or might not work on Travis – and you should know the root cause quickly.</p><p>In the past, we propagated <a href=https://github.com/Gizra/drupal-elm-starter/pull/165/files>video recording</a>, now I’d recommend something else. You have a web application, for all the backend errors, there’s a tool to access the logs, at Drupal, you can use Drush. But what about the frontend? Headless Chrome is neat, it has built-in debugging capability, the best of which is that you can break out of the box using Ngrok. Without any X11 forwarding (which is not available) or a local hack to try to mimic Travis, you can play with your app running in the Travis environment. All you need to do is to execute a <a href=https://github.com/Gizra/drupal-elm-starter/pull/165/files>Debug build</a>, execute the installation part (<code class=highlighter-rouge>travis_run_before_install</code>, <code class=highlighter-rouge>travis_run_install</code>, <code class=highlighter-rouge>travis_run_before_script</code>), start Headless Chrome (<code class=highlighter-rouge>google-chrome --headless --remote-debugging-port=9222</code>), download <a href=https://ngrok.com/download>Ngrok</a>, start a tunnel (<code class=highlighter-rouge>ngrok http 9222</code>), visit the exposed URL from your local Chrome and have fun with inspection, debugger console, and <a href="https://chromedevtools.github.io/devtools-protocol/">more</a>.</p><h2 id=takeaway>Takeaway</h2><p>Working on such improvements has benefits of many kinds. The entire development team can enjoy the shorter queues and faster merges, and you can go ahead and apply part of the enhancements to your local environment, especially if you dig deep into database performance optimization and make the things parallel. And even more, clients love to hear that you are going to speed up their sites, as this mindset should be also used at production.</p></div></div><div class="twelve wide column computer only"><div class="ui borderless secondary menu"><a class=item href="/content/elm-related-types/"><i class="chevron left icon"></i> Expressing a Relationship between Multiple Types in Elm</a><div class="right menu"><a class=item href="/podcast/whats-so-special/">What’s So Special About the Gizra Way <i class="chevron right icon"></i></a></div></div></div><div class="twelve wide column"><div class="ui segment basic"><div id=disqus_thread></div><script type=text/javascript>var disqus_shortname = 'gizra';
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();</script><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div></div></div></div><footer class="ui black inverted vertical footer segment padded"><div class="ui center aligned container"><div class="ui three column stackable inverted grid"><div class=column><address><div class=strong>Israel Headquarters</div><div>5 Brenner Street, Tel Aviv</div><a class=telephone href=tel:+97233731222>+972-3-3731222</a> // <a class=email href=mailto:info@gizra.com>info@gizra.com</a></address></div><div class="column icons"><a target=_blank href=https://twitter.com/gizra_drupal><i class="twitter huge icon"></i></a> <a target=_blank href=https://github.com/Gizra/gizra.com><i class="github huge icon"></i></a></div><div class=column><address><div class=strong>North America Office</div><div>350 N. Orleans Street, Suite 9000N, Chicago, IL 60654</div><a class=telephone href=tel:+13125857625>312-585-7625</a> // <a class=email href=mailto:usoffice@gizra.com>usoffice@gizra.com</a></address></div></div></div></footer></div><script src=/bower_components/anchor-js/anchor.min.js></script><script src=/assets/javascript/script.js></script></body></html>