<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        
    

<title>Sending LOTS of emails (Hint: with Drush)</title>

        <meta name="description" content="">
        <meta name="keywords" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

      <!-- Favicon for all platforms -->
      <link rel="apple-touch-icon" sizes="180x180" href="/images/favicons/apple-touch-icon-180x180.4fe6.png">
      <link rel="icon" type="image/png" href="/images/favicons/favicon-32x32.c391.png" sizes="32x32">
      <link rel="icon" type="image/png" href="/images/favicons/favicon-194x194.2d07.png" sizes="194x194">
      <link rel="icon" type="image/png" href="/images/favicons/favicon-96x96.8557.png" sizes="96x96">
      <link rel="icon" type="image/png" href="/images/favicons/android-chrome-192x192.8b66.png" sizes="192x192">
      <link rel="icon" type="image/png" href="/images/favicons/favicon-16x16.a93c.png" sizes="16x16">
      <link rel="manifest" href="/images/favicons/manifest.json">
      <meta name="msapplication-TileColor" content="#000000">
      <meta name="msapplication-TileImage" content="/images/favicons/mstile-144x144.png">
      <meta name="theme-color" content="#ffffff">
      <!-- End favicon for all platforms -->

      <link rel="stylesheet" href="/css/main.e27e.css"/>
      <link href='http://fonts.googleapis.com/css?family=Abril+Fatface&text=gizra' rel='stylesheet' type='text/css'>
      <link href='https://fonts.googleapis.com/css?family=Hind:400,600,300,500' rel='stylesheet' type='text/css'>
      <link href='https://fonts.googleapis.com/css?family=Raleway:400,300,600,800' rel='stylesheet' type='text/css'>
      <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
      <!-- Google Analytics -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-6558346-3', 'auto');
  ga('send', 'pageview');

</script>
<!-- End Google Analytics -->


      <!-- Begin Inspectlet Embed Code -->
      <script type="text/javascript" id="inspectletjs">
      window.__insp = window.__insp || [];
      __insp.push(['wid', 314054580]);
      (function() {
      function ldinsp(){if(typeof window.__inspld != "undefined") return; window.__inspld = 1; var insp = document.createElement('script'); insp.type = 'text/javascript'; insp.async = true; insp.id = "inspsync"; insp.src = ('https:' == document.location.protocol ? 'https' : 'http') + '://cdn.inspectlet.com/inspectlet.js'; var x = document.getElementsByTagName('script')[0]; x.parentNode.insertBefore(insp, x); };
      setTimeout(ldinsp, 500); document.readyState != "complete" ? (window.attachEvent ? window.attachEvent('onload', ldinsp) : window.addEventListener('load', ldinsp, false)) : ldinsp();
      })();
      </script>
      <!-- End Inspectlet Embed Code -->

    </head>
    <body>

    <!-- Main content -->
    
  



  
    
      
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  


<header id="header-global">
  <div class="container">
    <div class="row">
      <div class="col-sm-12">
        
  

<span class="gizra-logo"><a href="/">gizra</a></span>
<h1 class="sr-only">Gizra</h1>
<nav id="nav" role="navigation" class="navbar navbar-default">
  <div class="navbar-header">
    <button data-target=".navbar-collapse" data-toggle="collapse" class="navbar-toggle" type="button">
      <span class="sr-only">Toggle navigation</span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
    </button>
  </div>
  <div class="navbar-collapse collapse">
    <ul class="nav navbar-nav">
      <li><a href="/#about" class="smooth-scroll-to">About</a></li>
      <li><a href="/services">Our Work</a></li>
      <li><a href="/team">Team</a></li>
      <li><a href="/blog">Blog</a></li>
      <li><a href="/fit">Do We Fit?</a></li>
      <li><a href="/contact">Contact</a></li>
    </ul>
  </div>
</nav>

      </div>
    </div>
  </div>
</header>
<article id="post-page">
  <div class="container">
    <div class="row">
      <div id="post-title" class="col-sm-10 col-sm-offset-1">
        <h1><a href="/content/sending-lots-emails-hint-drush/">Sending LOTS of emails (Hint: with Drush) </a></h1>
        <div class="post-author">By Amitai Burstein</div>
      </div>
    </div>
    <div class="row">
      <div id="post-data" class="col-sm-2 col-sm-offset-1">
  			<div id="post-label">
  		 		<a href="/blog"><span class="label label-default">Gizra Blog</span></a>
  			</div>
        <div class="date">24 Jan 2012</div>
        <section class="author-details">
          <div class="image-wrapper">
            <img src="/images/team/avatars/amitaibu.a340.jpg" class="img-circle img-responsive">
          </div>
          <div class="text-wrapper">
            <span class="name">Amitai Burstein</span>
            
              <span class="twitter">(@amitaibu)</span>
            
            <div class="title">CTO, Co-Owner</div>
            <div class="bio">Maintainer of Organic groups, the Message stack, and co-maintainer of Drupal 8's Entity reference. <a href="/content/the-about-story/">The about story</a>.</div>
          </div>
        </section>
        <div class="tags">
          <div class="title">Tags:</div>
          
            <ul class="inline">
              
              

  
    
      <li><a href="/tags.html#Drupal-planet-ref">Drupal-planet</a></li>
    
      <li><a href="/tags.html#Message-ref">Message</a></li>
    
      <li><a href="/tags.html#Drush-ref">Drush</a></li>
    
  


            </ul>
          
        </div>
      </div>
      <div id="post-content" class="col-sm-8">

        <p>On my <a href="http://www.gizra.com/content/message-notify-multilingual-email-notifications">last blog</a> post I talked about Message notify module, and mentioned we were using it to send digest emails. While Message notify really eases the pain of creating personalized emails, and sending them, we still needed to find a scalable solutions for sending lots of emails. LOTS of emails!</p>

<p>Doing it on hook_cron() is nice if you need to send few emails, but when you need to send thousands of emails a day, it won’t do. Cron will take too long, or might hang up if we try to process too many digest emails at once.</p>

<p>A nice and simple solution we came up with, was to write a Drush command that will process a small batch of users, and use Jenkins to fire up this command every two minutes.</p>

<p>This post will demonstrate the code, that can be used by others - however you will need to copy and change the command to fit your business logic.</p>

<!-- more -->

<p>Assuming our module’s name is foo, you will need to place your code in <code>foo.drush.inc</code>:</p>
<div class="highlight"><pre><code class="php language-php" data-lang="php"><span class="cp">&lt;?php</span>

<span class="sd">/**</span>
<span class="sd"> * @file</span>
<span class="sd"> * Drush integration of Foo module.</span>
<span class="sd"> *</span>
<span class="sd"> */</span>

<span class="sd">/**</span>
<span class="sd"> * Implements hook_drush_help().</span>
<span class="sd"> */</span>
<span class="k">function</span> <span class="nf">foo_drush_help</span><span class="p">(</span><span class="nv">$section</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">switch</span> <span class="p">(</span><span class="nv">$section</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="s1">&#39;drush:foo-digest&#39;</span><span class="o">:</span>
      <span class="k">return</span> <span class="nx">dt</span><span class="p">(</span><span class="s1">&#39;Send digest emails.&#39;</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="sd">/**</span>
<span class="sd"> * Implements hook_drush_command().</span>
<span class="sd"> */</span>
<span class="k">function</span> <span class="nf">foo_drush_command</span><span class="p">()</span> <span class="p">{</span>
  <span class="nv">$items</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>

  <span class="nv">$items</span><span class="p">[</span><span class="s1">&#39;foo-digest&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
    <span class="s1">&#39;callback&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;drush_foo_digest&#39;</span><span class="p">,</span>
    <span class="s1">&#39;drupal dependencies&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">),</span>
    <span class="s1">&#39;description&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Send digest emails.&#39;</span><span class="p">,</span>
    <span class="s1">&#39;arguments&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
      <span class="s1">&#39;range&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;The number of users to be processed.&#39;</span><span class="p">,</span>
    <span class="p">),</span>
    <span class="s1">&#39;bootstrap&#39;</span> <span class="o">=&gt;</span> <span class="nx">DRUSH_BOOTSTRAP_DRUPAL_FULL</span><span class="p">,</span>
    <span class="s1">&#39;aliases&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;fdg&#39;</span><span class="p">),</span>
    <span class="s1">&#39;examples&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
      <span class="s1">&#39;drush foo-digest&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Process 10 users.&#39;</span><span class="p">,</span>
      <span class="s1">&#39;drush foo-digest --range=50&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Process 50 users.&#39;</span><span class="p">,</span>
    <span class="p">),</span>
  <span class="p">);</span>

  <span class="k">return</span> <span class="nv">$items</span><span class="p">;</span>
<span class="p">}</span>

<span class="sd">/**</span>
<span class="sd"> * Callback function for sending digest email command.</span>
<span class="sd"> */</span>
<span class="k">function</span> <span class="nf">drush_foo_digest</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">lock_acquire</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="mf">240.0</span><span class="p">))</span> <span class="p">{</span>
    <span class="c1">// Digest is already processed.</span>
    <span class="nx">drush_log</span><span class="p">(</span><span class="nx">dt</span><span class="p">(</span><span class="s1">&#39;Attempting to re-run foo digest command while it is already running.&#39;</span><span class="p">),</span> <span class="s1">&#39;notice&#39;</span><span class="p">);</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="nv">$range</span> <span class="o">=</span> <span class="nx">drush_get_option</span><span class="p">(</span><span class="s1">&#39;range&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
  <span class="c1">// This function should be replaced by your function that gets all the</span>
  <span class="c1">// users that need to get the digest email.</span>
  <span class="nv">$uids</span> <span class="o">=</span> <span class="nx">foo_get_digest_users</span><span class="p">(</span><span class="nv">$range</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$uids</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">drush_log</span><span class="p">(</span><span class="nx">dt</span><span class="p">(</span><span class="s1">&#39;No users found for digest.&#39;</span><span class="p">),</span> <span class="s1">&#39;ok&#39;</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="c1">// This function should be replaced by your function that will send the</span>
  <span class="c1">// emails (maybe by using Message notify), and is expected to return</span>
  <span class="c1">// the user IDs of the successful emails.</span>
  <span class="nv">$return</span> <span class="o">=</span> <span class="nx">foo_process_digest</span><span class="p">(</span><span class="nv">$uids</span><span class="p">);</span>
  <span class="nv">$params</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
    <span class="s1">&#39;@uids&#39;</span> <span class="o">=&gt;</span> <span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$return</span><span class="p">)</span> <span class="o">?</span> <span class="nb">implode</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">,</span> <span class="nv">$return</span><span class="p">)</span> <span class="o">:</span> <span class="s1">&#39;none&#39;</span><span class="p">,</span>
  <span class="p">);</span>

  <span class="nx">drush_log</span><span class="p">(</span><span class="nx">dt</span><span class="p">(</span><span class="s1">&#39;Users IDs that got email: @uids.&#39;</span><span class="p">,</span> <span class="nv">$params</span><span class="p">),</span> <span class="s1">&#39;ok&#39;</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">?&gt;</span><span class="x"></span>
</code></pre></div>
<p>Note the code comments - you are expected to replace foo<em>get</em>digest<em>users() and foo</em>process_digest(). Btw, in those functions, I’ve added debug messages like this.</p>
<div class="highlight"><pre><code class="php language-php" data-lang="php"><span class="cp">&lt;?php</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">function_exists</span><span class="p">(</span><span class="s1">&#39;drush_log&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">drush_get_option</span><span class="p">(</span><span class="s1">&#39;verbose&#39;</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">drush_log</span><span class="p">(</span><span class="nx">dt</span><span class="p">(</span><span class="s1">&#39;Digest email to user @uid could not be sent&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;@uid&#39;</span> <span class="o">=&gt;</span> <span class="nv">$account</span><span class="o">-&gt;</span><span class="na">uid</span><span class="p">)),</span> <span class="s1">&#39;ok&#39;</span><span class="p">);</span>
  <span class="p">}</span>
<span class="cp">?&gt;</span><span class="x"></span>
</code></pre></div>
<p>After that, all you need to do is create a new Jenkins job.
<img src="/assets/images/legacy/digest_dev_Config_Jenkins.jpg" /></p>

<p><a href="http://getpantheon.com">Pantheon</a> gives us this flexibility, here&rsquo;s the console log:
<img src="/assets/images/legacy/digest-console.jpg" /></p>

<p>Don&rsquo;t forget to use <a href="http://drupal.org/project/reroute_email">Reroute email</a> so your users don’t get dummy emails form your Dev and Test environments.</p>


      </div>
    </div>
  </div>
</article>
<section id="post-nav">
  <div class="container">
    <div class="row">
      <div class="col-sm-3 col-sm-offset-3 col-xs-6 previous">
        
        <a href="/content/message-notify-multilingual-email-notifications/">
          <div id="previous-label" class="text-small">
            <span class="hidden-xs"><i class="fa fa-chevron-circle-left"></i>&nbsp;Message notify - Multilingual email notifications</span>
            <span class="visible-xs"><i class="fa fa-chevron-circle-left"></i>&nbsp;Previous post</span>
          </div>
        </a>
        
      </div>
      <div class="col-sm-3 col-sm-offset-2 col-xs-6 next">
        
        <a href="/content/commerce-product-subform/">
          <div id="next-label" class="text-small">
            <span class="hidden-xs">Commerce product + Subform&nbsp;<i class="fa fa-chevron-circle-right"></i></span>
            <span class="visible-xs">Next post&nbsp;<i class="fa fa-chevron-circle-right"></i></span>
          </div>
        </a>
        
      </div>
    </div>
  </div>
</section>
<section>
  <div class="container">
    <div class="row">
      <div class="col-sm-8 col-sm-offset-3">
        <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_developer = 1;
    var disqus_shortname = 'gizra';
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

      </div>
    </div>
  </div>
</section>
    


    <!--Footer -->
    
  <div id="contact">
    <footer id="footer" role="contentinfo">
      <div class="footer-wrapper">
        <div class="background">
          <div class="container">
            <div class="row">
              <div class="col-sm-12">
                <h2 class="title">Talk to us</h2>
                <div class="clearfix">
                  <address>
                    <div class="strong">Israel Headquarters</div>
                    <span>5 Brenner Street, Tel Aviv</span>
                      <a class="telephone" href="tel:+97233731222">+972-3-3731222</a>
                    <a class="email" href="mailto:info@gizra.com">info@gizra.com</a>
                  </address>
                  <address class="separator">
                    <div class="strong">North America Office</div>
                    <span>106 West 32nd Street, 2nd Floor, New York, NY 10001</span>
                    <a class="telephone" href="tel:+13476864508">212-634-1687</a>
                    <a class="email" href="mailto:usoffice@gizra.com">usoffice@gizra.com</a>
                  </address>
                  <div class="separator social-links">
                    <span class="link github">
                      <a href="https://github.com/Gizra" target="_blank"><i class="fa fa-github-square"></i><span class="link-text">Gizra's Github Account</span></a>
                    </span>
                    <span class="link twitter">
                      <a href="https://twitter.com/gizra_drupal" target="_blank"><i class="fa fa-twitter-square"></i><span class="link-text">Gizra's Twitter Account</span></a>
                    </span>
                    <span class="link linkedin">
                      <a href="https://www.linkedin.com/company/gizra-ltd" target="_blank"><i class="fa fa-linkedin-square"></i><span class="link-text">Gizra's LinkedIn Page</span></a>
                    </span>
                    <span class="link facebook">
                      <a href="https://www.facebook.com/gizraltd/timeline" target="_blank"><i class="fa fa-facebook-square"></i><span class="link-text">Gizra's Facebook Page</span></a>
                    </span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </footer>
  </div>



    <script src="/js/plugins.c51b.js"></script>

    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery-backstretch/2.0.4/jquery.backstretch.min.js"></script>

    <script src="/js/scripts.1fc2.js"></script>
    </body>
</html>
