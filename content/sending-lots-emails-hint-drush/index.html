<!DOCTYPE html><html><head><title>Sending LOTS of emails (Hint: with Drush)</title><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta property=og:site_name content=Gizra><meta property=og:title content="Sending LOTS of emails (Hint: with Drush)"><meta name=description content="Gizra is a web strategy, design, and
  development agency with an extensive track record in complex content
  management solutions in Drupal and Elm."><meta property=og:description content=""><meta name=twitter:card content="summary_large_image"/><meta name=twitter:site content="@gizra_drupal"/><meta property=og:image content=https://www.gizra.com/assets/images/homepage/gizra-logo-site.jpg><link rel=apple-touch-icon sizes=180x180 href=/assets/favicons/apple-touch-icon-180x180.png><link rel=icon type=image/png href=/assets/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/assets/favicons/favicon-194x194.png sizes=194x194><link rel=icon type=image/png href=/assets/favicons/favicon-96x96.png sizes=96x96><link rel=icon type=image/png href=/assets/favicons/android-chrome-192x192.png sizes=192x192><link rel=icon type=image/png href=/assets/favicons/favicon-16x16.png sizes=16x16><link rel=manifest href=/assets/favicons/manifest.json><meta name=msapplication-TileColor content=#000000><meta name=msapplication-TileImage content=/assets/favicons/mstile-144x144.png><meta name=theme-color content=#ffffff><link href="https://fonts.googleapis.com/css?family=Abril+Fatface&text=gizra" rel=stylesheet><link href="https://fonts.googleapis.com/css?family=Esteban" rel=stylesheet><link href="https://fonts.googleapis.com/css?family=Open+Sans:400,700" rel=stylesheet><link href="https://fonts.googleapis.com/css?family=Montserrat:500,700" rel=stylesheet><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.2.7/semantic.min.css integrity="sha256-wT6CFc7EKRuf7uyVfi+MQNHUzojuHN2pSw0YWFt2K5E=" crossorigin="anonymous"/><link rel=stylesheet href="/assets/stylesheets/style.css"/><script src=https://code.jquery.com/jquery-2.2.4.min.js integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.2.7/semantic.min.js integrity="sha256-flVaeawsBV96vCHiLmXn03IRJym7+ZfcLVvUWONCas8=" crossorigin=anonymous></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-6558346-3', 'auto');
  ga('send', 'pageview');</script></head><body class=pushable><div class="ui sidebar inverted vertical menu left"><a class="item active" href="/">Home</a> <a class=item href=/team>Team</a> <a class=item href=/blog>Blog</a> <a class=item href=/podcast>Podcast</a> <a class=item href=/projects>Projects</a> <a class=item href=/our-story>Our Story</a> <a class=item href=/contact>Contact</a></div><div class=pusher><div class="ui grid container"><header class=row><div class="five wide column menu bar"><div class="ui large secondary menu"><a class="item sidebar-toggle"><i class="big sidebar icon"></i> Menu</a></div></div><div class="six wide computer six wide tablet eleven wide mobile column center aligned"><a class=gizra-logo href="/"><svg xmlns=http://www.w3.org/2000/svg width=252 height=104><title>gizra</title><path fill=#E27058 fill-rule=evenodd d="M44.3 21.6c.2 3.5 3 5.4 6 5.4 3.5 0 6.7-2 6.7-7s-3.6-7.7-8.5-7.7c-4.3 0-10.3 2.5-10.3 11 0 1.7.2 3.4.6 5.3-3.4-2-6.5-2.6-11.6-2.6-16 0-22.7 7.6-22.7 17.5 0 8.7 4 13.7 12.2 16-8.2 5-12 7.8-12 13.8C4.7 78 8 83 20.7 83h10c11 0 13.4 2 13.4 7 0 6.7-5.8 11.3-17 11.3s-13.4-4.7-13.4-9c0-1.8.2-3.5 1-5.8l-6.4-3C4.5 84.8.2 87 .2 92c0 6.8 7.5 11.3 25.8 11.3 21.2 0 29.6-8.5 29.6-20 0-14.4-12-17.2-23.8-17.2H21c-5.5 0-6.6-.4-6.6-1.4 0-1 1-2 4.6-4.4 2.2.4 5.4.8 8.5.8C40.3 61 49 55 49 43c0-6.8-4-10.5-8-13.3-.6-2.5-.8-4.6-.8-6.3 0-6.5 3-7 4.5-7 2.2 0 2.8 1.7 2.5 3.4l-3 1.8zM22 41.2C22 29.7 24 28 27 28s4.6 1.4 4.6 13.2v5c0 11-1.8 12.7-4.6 12.7-3.2 0-5-2.3-5-12V41zM62 10c0 4.4 2 9.8 10.6 9.8 7.6 0 10.6-4.3 10.6-10 0-6.3-3.8-9.6-10.4-9.6C65 .2 62 5 62 10zm-5.4 17v2h6.2v46H57v2h31.2v-2h-6V27H56.7zm82.5 0H95l-1.4 20.2H95c4.3-15 8-18.3 22.2-18.3h1L93 75.3V77h44l1.8-21.5h-1.5C133.5 69 127.5 75 115.6 75h-1.4l25-46v-2zm41 3c2.2 0 4.3 1 2.2 5.3h-3.8c-2.2 7.5 1 12 8.2 12 5.6 0 8.8-4 8.8-10 0-8-5-11.3-11.2-11.3-6.3 0-12 3.6-14 11V27H145v2h5.7v46h-5.8v2h32.6v-2h-7.4V47c0-9.5 4.7-17 9.7-17zm40.5 22.3c-15 0-24.2 2.4-24.2 13 0 10.5 8.2 12.8 15.6 12.8 7.2 0 10.3-2.7 12-7.7 1.2 5 6 7.8 14.4 7.8 9 0 13-3.5 13.5-16l-1.7-.2c-.5 8.8-2.3 10.8-4.2 10.8-1.7 0-3-1.2-3-5.5V46c0-15.2-5.5-19.8-22-19.8-14.3 0-22 4-22 13 0 5 2.6 8.6 9 8.6 5.3 0 9.3-3.3 9.3-8.2 0-2-.3-3.4-.8-4.7H214c-.6-1.2-.8-2.2-.8-3 0-3.4 3-4.3 5-4.3 4.2 0 5.3 3.5 5.3 16.8v8h-3zM219 73.8c-2 0-2.7-1-2.7-8.6v-1.6c0-6.4 2-9.6 6.5-9.6h.7v9.8c0 6.7-2.5 10-4.5 10z"/></svg></a><div class=tagline>We Build Websites</div></div><div class="five wide computer only column"></div></header><div class="ui grid centered post"><div class="sixteen wide mobile sixteen wide tablet twelve wide computer column"><div class="ui raised padded segment"><h1 class="ui dividing header"><div class="ui image"><img src=/assets/images/team/avatars/amitaibu.jpg class="ui circular image"></div><div class=content><a href="/content/sending-lots-emails-hint-drush/">Sending LOTS of emails (Hint: with Drush)</a><div class="sub header">By Amitai Burstein (@amitaibu) // 24 Jan 2012</div></div><div class="right floated column"><a href=/blog class="ui teal right ribbon big label">Blog Post</a></div></h1><p>On my <a href=/content/message-notify-multilingual-email-notifications>last blog</a> post I talked about Message notify module, and mentioned we were using it to send digest emails. While Message notify really eases the pain of creating personalized emails, and sending them, we still needed to find a scalable solutions for sending lots of emails. LOTS of emails!</p><p>Doing it on hook_cron() is nice if you need to send few emails, but when you need to send thousands of emails a day, it won’t do. Cron will take too long, or might hang up if we try to process too many digest emails at once.</p><p>A nice and simple solution we came up with, was to write a Drush command that will process a small batch of users, and use Jenkins to fire up this command every two minutes.</p><p>This post will demonstrate the code, that can be used by others - however you will need to copy and change the command to fit your business logic.</p><p>Assuming our module’s name is foo, you will need to place your code in <code class=highlighter-rouge>foo.drush.inc</code>:</p><div class="language-php highlighter-rouge"><div class=highlight><pre class=highlight><code><span class=cp>&lt;?php</span>

<span class=sd>/**
 * @file
 * Drush integration of Foo module.
 *
 */</span>

<span class=sd>/**
 * Implements hook_drush_help().
 */</span>
<span class=k>function</span> <span class=nf>foo_drush_help</span><span class=p>(</span><span class=nv>$section</span><span class=p>)</span> <span class=p>{</span>
  <span class=k>switch</span> <span class=p>(</span><span class=nv>$section</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>case</span> <span class=s1>'drush:foo-digest'</span><span class=o>:</span>
      <span class=k>return</span> <span class=nx>dt</span><span class=p>(</span><span class=s1>'Send digest emails.'</span><span class=p>);</span>
  <span class=p>}</span>
<span class=p>}</span>

<span class=sd>/**
 * Implements hook_drush_command().
 */</span>
<span class=k>function</span> <span class=nf>foo_drush_command</span><span class=p>()</span> <span class=p>{</span>
  <span class=nv>$items</span> <span class=o>=</span> <span class=k>array</span><span class=p>();</span>

  <span class=nv>$items</span><span class=p>[</span><span class=s1>'foo-digest'</span><span class=p>]</span> <span class=o>=</span> <span class=k>array</span><span class=p>(</span>
    <span class=s1>'callback'</span> <span class=o>=&gt;</span> <span class=s1>'drush_foo_digest'</span><span class=p>,</span>
    <span class=s1>'drupal dependencies'</span> <span class=o>=&gt;</span> <span class=k>array</span><span class=p>(</span><span class=s1>'foo'</span><span class=p>),</span>
    <span class=s1>'description'</span> <span class=o>=&gt;</span> <span class=s1>'Send digest emails.'</span><span class=p>,</span>
    <span class=s1>'arguments'</span> <span class=o>=&gt;</span> <span class=k>array</span><span class=p>(</span>
      <span class=s1>'range'</span> <span class=o>=&gt;</span> <span class=s1>'The number of users to be processed.'</span><span class=p>,</span>
    <span class=p>),</span>
    <span class=s1>'bootstrap'</span> <span class=o>=&gt;</span> <span class=nx>DRUSH_BOOTSTRAP_DRUPAL_FULL</span><span class=p>,</span>
    <span class=s1>'aliases'</span> <span class=o>=&gt;</span> <span class=k>array</span><span class=p>(</span><span class=s1>'fdg'</span><span class=p>),</span>
    <span class=s1>'examples'</span> <span class=o>=&gt;</span> <span class=k>array</span><span class=p>(</span>
      <span class=s1>'drush foo-digest'</span> <span class=o>=&gt;</span> <span class=s1>'Process 10 users.'</span><span class=p>,</span>
      <span class=s1>'drush foo-digest --range=50'</span> <span class=o>=&gt;</span> <span class=s1>'Process 50 users.'</span><span class=p>,</span>
    <span class=p>),</span>
  <span class=p>);</span>

  <span class=k>return</span> <span class=nv>$items</span><span class=p>;</span>
<span class=p>}</span>

<span class=sd>/**
 * Callback function for sending digest email command.
 */</span>
<span class=k>function</span> <span class=nf>drush_foo_digest</span><span class=p>()</span> <span class=p>{</span>
  <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>lock_acquire</span><span class=p>(</span><span class=s1>'foo'</span><span class=p>,</span> <span class=mf>240.0</span><span class=p>))</span> <span class=p>{</span>
    <span class=c1>// Digest is already processed.</span>
    <span class=nx>drush_log</span><span class=p>(</span><span class=nx>dt</span><span class=p>(</span><span class=s1>'Attempting to re-run foo digest command while it is already running.'</span><span class=p>),</span> <span class=s1>'notice'</span><span class=p>);</span>
    <span class=k>return</span><span class=p>;</span>
  <span class=p>}</span>
  <span class=nv>$range</span> <span class=o>=</span> <span class=nx>drush_get_option</span><span class=p>(</span><span class=s1>'range'</span><span class=p>,</span> <span class=mi>10</span><span class=p>);</span>
  <span class=c1>// This function should be replaced by your function that gets all the</span>
  <span class=c1>// users that need to get the digest email.</span>
  <span class=nv>$uids</span> <span class=o>=</span> <span class=nx>foo_get_digest_users</span><span class=p>(</span><span class=nv>$range</span><span class=p>);</span>
  <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nv>$uids</span><span class=p>)</span> <span class=p>{</span>
    <span class=nx>drush_log</span><span class=p>(</span><span class=nx>dt</span><span class=p>(</span><span class=s1>'No users found for digest.'</span><span class=p>),</span> <span class=s1>'ok'</span><span class=p>);</span>
  <span class=p>}</span>

  <span class=c1>// This function should be replaced by your function that will send the</span>
  <span class=c1>// emails (maybe by using Message notify), and is expected to return</span>
  <span class=c1>// the user IDs of the successful emails.</span>
  <span class=nv>$return</span> <span class=o>=</span> <span class=nx>foo_process_digest</span><span class=p>(</span><span class=nv>$uids</span><span class=p>);</span>
  <span class=nv>$params</span> <span class=o>=</span> <span class=k>array</span><span class=p>(</span>
    <span class=s1>'@uids'</span> <span class=o>=&gt;</span> <span class=o>!</span><span class=k>empty</span><span class=p>(</span><span class=nv>$return</span><span class=p>)</span> <span class=o>?</span> <span class=nb>implode</span><span class=p>(</span><span class=s1>', '</span><span class=p>,</span> <span class=nv>$return</span><span class=p>)</span> <span class=o>:</span> <span class=s1>'none'</span><span class=p>,</span>
  <span class=p>);</span>

  <span class=nx>drush_log</span><span class=p>(</span><span class=nx>dt</span><span class=p>(</span><span class=s1>'Users IDs that got email: @uids.'</span><span class=p>,</span> <span class=nv>$params</span><span class=p>),</span> <span class=s1>'ok'</span><span class=p>);</span>
<span class=p>}</span>
<span class=cp>?&gt;</span>
</code></pre></div></div><p>Note the code comments - you are expected to replace foo_get_digest_users() and foo_process_digest(). Btw, in those functions, I’ve added debug messages like this.</p><div class="language-php highlighter-rouge"><div class=highlight><pre class=highlight><code><span class=cp>&lt;?php</span>
  <span class=k>if</span> <span class=p>(</span><span class=nb>function_exists</span><span class=p>(</span><span class=s1>'drush_log'</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=nx>drush_get_option</span><span class=p>(</span><span class=s1>'verbose'</span><span class=p>))</span> <span class=p>{</span>
    <span class=nx>drush_log</span><span class=p>(</span><span class=nx>dt</span><span class=p>(</span><span class=s1>'Digest email to user @uid could not be sent'</span><span class=p>,</span> <span class=k>array</span><span class=p>(</span><span class=s1>'@uid'</span> <span class=o>=&gt;</span> <span class=nv>$account</span><span class=o>-&gt;</span><span class=na>uid</span><span class=p>)),</span> <span class=s1>'ok'</span><span class=p>);</span>
  <span class=p>}</span>
<span class=cp>?&gt;</span>
</code></pre></div></div><p>After that, all you need to do is create a new Jenkins job.</p><div class="ui segments"><div class="ui attached center aligned segment"><div class="ui image"><img src="https://www.gizra.com//assets/images/legacy/digest_dev_Config_Jenkins.jpg"/></div></div></div><p><a href=http://getpantheon.com>Pantheon</a> gives us this flexibility, here’s the console log:</p><div class="ui segments"><div class="ui attached center aligned segment"><div class="ui image"><img src="https://www.gizra.com//assets/images/legacy/digest-console.jpg"/></div></div></div><p>Don’t forget to use <a href=http://drupal.org/project/reroute_email>Reroute email</a> so your users don’t get dummy emails form your Dev and Test environments.</p></div></div><div class="twelve wide column computer only"><div class="ui borderless secondary menu"><a class=item href="/content/message-notify-multilingual-email-notifications/"><i class="chevron left icon"></i> Message notify - Multilingual email notifications</a><div class="right menu"><a class=item href="/content/commerce-product-subform/">Commerce product + Subform <i class="chevron right icon"></i></a></div></div></div><div class="twelve wide column"><div class="ui segment basic"><div id=disqus_thread></div><script type=text/javascript>var disqus_shortname = 'gizra';
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();</script><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div></div></div></div><footer class="ui black inverted vertical footer segment padded"><div class="ui center aligned container"><div class="ui three column stackable inverted grid"><div class=column><address><div class=strong>Israel Headquarters</div><div>5 Brenner Street, Tel Aviv</div><a class=telephone href=tel:+97233731222>+972-3-3731222</a> // <a class=email href=mailto:info@gizra.com>info@gizra.com</a></address></div><div class="column icons"><a target=_blank href=https://twitter.com/gizra_drupal><i class="twitter huge icon"></i></a> <a target=_blank href=https://github.com/Gizra/gizra.com><i class="github huge icon"></i></a></div><div class=column><address><div class=strong>North America Office</div><div>350 N. Orleans Street, Suite 9000N, Chicago, IL 60654</div><a class=telephone href=tel:+13125857625>312-585-7625</a> // <a class=email href=mailto:usoffice@gizra.com>usoffice@gizra.com</a></address></div></div></div></footer></div><script src=/bower_components/anchor-js/anchor.min.js></script><script src=/assets/javascript/script.js></script></body></html>